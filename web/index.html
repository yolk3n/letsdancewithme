<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/strings.ru.js"></script>
    <style>
      :root {
        --bg-main: #f6f2ea;
        --bg-soft: #fefcf8;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-border: rgba(38, 30, 20, 0.12);
        --text-main: #1f1b16;
        --text-muted: #6f665c;
        --accent-pink: #f24f88;
        --accent-cyan: #00a8c7;
        --accent-yellow: #f1b341;
        --danger: #c93e57;
        --radius-lg: 18px;
        --radius-md: 12px;
        --font-body: "Manrope", sans-serif;
        --font-display: "Bebas Neue", sans-serif;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        padding: 16px;
        color: var(--text-main);
        font-family: var(--font-body);
        background:
          radial-gradient(120% 80% at 0% 0%, rgba(242, 79, 136, 0.1) 0%, rgba(242, 79, 136, 0) 55%),
          linear-gradient(180deg, #fffdf9 0%, var(--bg-main) 100%);
      }
      .app-shell {
        max-width: 860px;
        margin: 0 auto;
      }
      .card {
        margin-bottom: 14px;
        padding: 16px;
        border: 1px solid var(--card-border);
        border-radius: var(--radius-lg);
        background: var(--card-bg);
        box-shadow: 0 3px 10px rgba(53, 35, 22, 0.08);
        animation: cardIn 170ms ease;
      }
      .card > b:first-child {
        display: block;
        margin-bottom: 10px;
        font-size: 26px;
        line-height: 1;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .hidden { display: none; }
      .muted { color: var(--text-muted); }
      .error { color: var(--danger); }
      button, input, select, textarea {
        width: 100%;
        margin-bottom: 8px;
        padding: 12px 13px;
        border-radius: var(--radius-md);
        font-family: var(--font-body);
        font-size: 15px;
      }
      button {
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(65, 31, 42, 0.12);
        color: #fff;
        background: #e86593;
        cursor: pointer;
        font-weight: 700;
        text-align: left;
        box-shadow: 0 2px 7px rgba(232, 101, 147, 0.2);
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }
      button:hover { transform: translateY(-1px); filter: brightness(1.02); }
      button:active { transform: translateY(0); }
      button.secondary {
        color: #2d251e;
        border-color: rgba(45, 31, 20, 0.16);
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 1px 5px rgba(76, 53, 32, 0.08);
      }
      input, select, textarea {
        border: 1px solid rgba(50, 35, 22, 0.2);
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.82);
        outline: none;
      }
      input:focus, select:focus, textarea:focus {
        border-color: rgba(0, 168, 199, 0.72);
        box-shadow: 0 0 0 3px rgba(0, 168, 199, 0.18);
      }
      .teacher-btn { display: flex; align-items: center; gap: 12px; text-align: left; }
      .teacher-avatar { width: 46px; height: 46px; border-radius: 50%; object-fit: cover; flex: 0 0 46px; border: 1px solid rgba(54, 34, 20, 0.2); }
      .teacher-avatar-fallback {
        width: 46px; height: 46px; border-radius: 50%; flex: 0 0 46px; display: flex;
        align-items: center; justify-content: center; font-size: 14px; font-weight: 800;
        color: #2a2118;
        background: linear-gradient(145deg, #ffd7e8, #cceef7);
        border: 1px solid rgba(54, 34, 20, 0.17);
      }
      .teacher-content { min-width: 0; }
      .teacher-content small { display: inline-block; margin-top: 2px; }
      .profile-top {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-start;
        cursor: pointer;
      }
      .profile-greeting { font-weight: 700; }
      #user {
        background: transparent;
        border: 0;
        box-shadow: none;
        padding: 0 0 8px;
        margin-bottom: 8px;
      }
      .profile-avatar,
      .profile-avatar-fallback {
        width: 42px;
        height: 42px;
        flex: 0 0 42px;
        border-radius: 50%;
      }
      .profile-avatar {
        object-fit: cover;
        border: 1px solid rgba(54, 34, 20, 0.2);
      }
      .profile-avatar-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 800;
        color: #2a2118;
        background: linear-gradient(145deg, #ffd7e8, #cceef7);
        border: 1px solid rgba(54, 34, 20, 0.17);
      }
      .profile-menu {
        margin-top: 10px;
        display: grid;
        gap: 6px;
      }
      .profile-menu button {
        margin: 0;
      }
      .style-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      .style-chip {
        width: auto;
        margin: 0;
        padding: 8px 11px;
        border-radius: 999px;
        border: 1px solid rgba(45, 31, 20, 0.18);
        background: rgba(255, 255, 255, 0.86);
        color: #2d251e;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
        box-shadow: none;
      }
      .style-chip.active {
        color: #fff;
        border-color: #ff6f67;
        background: #ff6f67;
      }
      .teacher-card {
        border: 1px solid rgba(38, 30, 20, 0.22);
        border-radius: 14px;
        padding: 10px;
        background: #ffffff;
        box-shadow: 0 6px 16px rgba(55, 38, 23, 0.12);
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease;
      }
      .catalog-bar {
        display: grid;
        gap: 8px;
        margin-bottom: 14px;
      }
      .catalog-row {
        display: flex;
        gap: 8px;
      }
      .catalog-row > * { flex: 1; }
      .teacher-filter-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .teacher-filter-btn {
        width: auto;
        margin: 0;
        padding: 8px 11px;
        border-radius: 999px;
        border: 1px solid rgba(45, 31, 20, 0.18);
        background: rgba(255, 255, 255, 0.86);
        color: #2d251e;
        box-shadow: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        line-height: 1;
        font-size: 13px;
        font-weight: 600;
      }
      .teacher-filter-btn.active {
        color: #fff;
        border-color: #ff6f67;
        background: #ff6f67;
      }
      .teacher-filter-avatar,
      .teacher-filter-fallback {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        flex: 0 0 22px;
      }
      .teacher-filter-avatar { object-fit: cover; }
      .teacher-filter-fallback {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
        color: #2d251e;
        background: #ece7df;
      }
      .teacher-filter-clear {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 1px solid rgba(45, 31, 20, 0.2);
        font-size: 12px;
        line-height: 1;
      }
      .teacher-picker {
        border: 1px solid rgba(38, 30, 20, 0.1);
        border-radius: 26px 26px 0 0;
        background: rgba(255, 255, 255, 0.98);
        padding: 16px 14px 10px;
        display: grid;
        gap: 6px;
        width: min(440px, calc(100vw - 24px));
        max-height: 70vh;
        overflow: auto;
      }
      .teacher-picker-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
      }
      .teacher-picker-head h3 {
        margin: 0;
        font-size: 28px;
        line-height: 1;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .teacher-picker-close {
        width: 34px;
        min-width: 34px;
        height: 34px;
        margin: 0;
        padding: 0;
        border-radius: 50%;
        font-size: 20px;
        line-height: 1;
        text-align: center;
      }
      .teacher-picker-item {
        margin: 0;
        width: 100%;
        border: 1px solid rgba(38, 30, 20, 0.08);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        color: #2d251e;
        box-shadow: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-start;
      }
      .teacher-picker-main {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        min-width: 0;
        flex: 1;
      }
      .teacher-picker-name {
        font-size: 16px;
        font-weight: 700;
        line-height: 1.2;
      }
      .teacher-picker-sub {
        font-size: 12px;
        color: var(--text-muted);
      }
      .teacher-picker-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #fff3ef;
      }
      .teacher-picker-radio {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 1px solid rgba(38, 30, 20, 0.2);
        flex: 0 0 18px;
      }
      .teacher-picker-radio.selected {
        border-color: #ff6f67;
        background: radial-gradient(circle at center, #ff6f67 0 45%, transparent 48% 100%);
      }
      .teacher-picker .teacher-filter-avatar,
      .teacher-picker .teacher-filter-fallback {
        width: 40px;
        height: 40px;
        flex: 0 0 40px;
      }
      .teacher-picker-overlay {
        position: fixed;
        inset: 0;
        z-index: 50;
        background: rgba(19, 14, 12, 0.36);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 0;
      }
      .course-progress {
        margin-top: 10px;
      }
      .course-progress-track {
        height: 4px;
        border-radius: 999px;
        background: rgba(38, 30, 20, 0.12);
        overflow: hidden;
      }
      .course-progress-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #3e9db4, #5bb58a);
      }
      .course-progress-label {
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }
      .course-author {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .course-top-row {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid rgba(38, 30, 20, 0.12);
      }
      .course-progress-inline {
        width: 24%;
        min-width: 84px;
      }
      .course-progress-inline .course-progress-track { margin-top: 2px; }
      .course-progress-inline .course-progress-label {
        margin-top: 4px;
        text-align: right;
      }
      .course-author-avatar,
      .course-author-fallback {
        width: 46px;
        height: 46px;
        flex: 0 0 46px;
        border-radius: 50%;
      }
      .course-author-avatar {
        object-fit: cover;
        border: 1px solid rgba(38, 30, 20, 0.2);
      }
      .course-author-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: #2d251e;
        background: #ece7df;
      }
      .course-author-name {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 46px;
        max-width: 150px;
        font-size: 13px;
        line-height: 1.15;
        font-weight: 600;
        color: var(--text-muted);
      }
      .course-author-name.single {
        justify-content: center;
      }
      .course-author-line {
        display: block;
      }
      .teacher-card:hover { transform: translateY(-1px); filter: brightness(1.01); }
      .teacher-card:active { transform: translateY(0); }
      #studentScreen.flat-list {
        background: transparent;
        border: 0;
        box-shadow: none;
        padding: 0;
      }
      .teacher-card-head {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .teacher-name {
        margin: 0;
        font-size: 16px;
        line-height: 1.2;
      }
      .teacher-courses-count {
        margin-top: 2px;
        font-size: 12px;
        color: var(--text-muted);
      }
      .teacher-style-row {
        margin: 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .teacher-style-chip {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 12px;
        line-height: 1.25;
        color: #2d251e;
        background: var(--teacher-chip-bg, #f6efe4);
      }
      .teacher-proof {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 10px 0 8px;
      }
      .teacher-proof-label {
        font-size: 12px;
        color: var(--text-muted);
      }
      .mini-avatars {
        display: flex;
        align-items: center;
      }
      .mini-avatars img,
      .mini-avatars span {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1.5px solid #fff;
        margin-left: -6px;
        background: #fff;
      }
      .mini-avatars > :first-child { margin-left: 0; }
      .mini-avatars span {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #4f463d;
        font-weight: 700;
      }
      .stack { display: grid; gap: 8px; }
      .student-header {
        margin-bottom: 10px;
      }
      .student-header-top {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .student-header-title {
        margin: 0;
        font-size: 24px;
        line-height: 1;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .back-btn {
        width: auto;
        min-width: 90px;
        margin: 0;
        text-align: center;
      }
      .back-spacer {
        display: inline-block;
        width: 90px;
        flex: 0 0 90px;
      }
      .section-subtitle {
        margin: 6px 0 10px;
        color: var(--text-muted);
        font-size: 13px;
      }
      .course-card {
        border: 1px solid rgba(38, 30, 20, 0.12);
        border-radius: 12px;
        padding: 14px;
        background: rgba(255, 255, 255, 0.72);
      }
      .catalog-courses-grid {
        display: grid;
        gap: 12px;
      }
      .catalog-course-card {
        cursor: pointer;
        border-color: rgba(38, 30, 20, 0.1);
        background: #fff;
        box-shadow: 0 6px 16px rgba(31, 24, 19, 0.06);
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }
      .catalog-course-card.level-beginner {
        background: #fff;
      }
      .catalog-course-card.level-advanced {
        background: #fff;
      }
      .catalog-course-card.level-professional {
        background: #fff;
      }
      .catalog-course-card:hover { transform: translateY(-1px); }
      .catalog-course-card:active { transform: translateY(0); }
      .course-card-title { font-weight: 700; margin-bottom: 3px; }
      .course-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        margin-top: 0;
      }
      .course-card-title {
        flex: 1 1 auto;
        font-size: 19px;
        line-height: 1.2;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      .catalog-course-card.level-beginner .course-card-title {
        color: #1f5f77;
      }
      .catalog-course-card.level-advanced .course-card-title {
        color: #8f4d1d;
      }
      .catalog-course-card.level-professional .course-card-title {
        color: #5a3b93;
      }
      .course-level-badge {
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 13px;
        line-height: 1.2;
        font-weight: 700;
        border: 1px solid rgba(38, 30, 20, 0.12);
        background: #f3f0f9;
        color: #7a6a98;
        white-space: nowrap;
      }
      .course-level-badge.beginner {
        border-color: rgba(61, 143, 171, 0.35);
        background: rgba(220, 244, 255, 0.86);
      }
      .course-level-badge.advanced {
        border-color: rgba(203, 126, 61, 0.34);
        background: rgba(255, 236, 214, 0.9);
      }
      .course-level-badge.professional {
        border-color: rgba(117, 87, 178, 0.35);
        background: rgba(235, 227, 255, 0.88);
      }
      .course-card-meta {
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .course-head-side {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
      }
      .course-access-badge {
        border-radius: 8px;
        padding: 3px 8px;
        font-size: 12px;
        font-weight: 800;
        line-height: 1;
      }
      .course-access-badge.free {
        color: #1f9c64;
        background: #e9faef;
      }
      .course-access-badge.paid {
        color: #fff;
        background: #ff6f67;
      }
      .lesson-btn[disabled] {
        cursor: not-allowed;
        filter: grayscale(0.3);
        opacity: 0.66;
      }
      .lesson-hero {
        border: 0;
        border-radius: 0 0 24px 24px;
        padding: 12px 16px 18px;
        color: #fff;
        background: linear-gradient(180deg, #ff7469 0%, #ff7f73 100%);
      }
      .lesson-hero.level-beginner {
        background: linear-gradient(180deg, #ff7469 0%, #ff7f73 100%);
      }
      .lesson-hero.level-advanced {
        background: linear-gradient(180deg, #ff7469 0%, #ff7f73 100%);
      }
      .lesson-hero.level-professional {
        background: linear-gradient(180deg, #ff7469 0%, #ff7f73 100%);
      }
      .lesson-hero-nav {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 10px;
      }
      .hero-icon-btn {
        width: 34px;
        min-width: 34px;
        height: 34px;
        margin: 0;
        padding: 0;
        border-radius: 50%;
        text-align: center;
      }
      .lesson-hero-tags {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .lesson-hero-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 9px;
        border-radius: 9px;
        font-size: 12px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
        background: rgba(255, 255, 255, 0.2);
      }
      .lesson-hero-author {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
      }
      .lesson-hero-name {
        font-size: 24px;
        line-height: 1.05;
        font-family: var(--font-display);
        font-weight: 400;
        color: #fff;
      }
      .lesson-hero-role {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.88);
      }
      .lesson-hero-title {
        margin: 0;
        font-size: 42px;
        line-height: 0.96;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .catalog-header-space {
        height: 4px;
      }
      .lesson-list-wrap {
        margin-top: -8px;
        padding: 14px 12px 12px;
        border-radius: 18px 18px 0 0;
        border: 1px solid rgba(38, 30, 20, 0.08);
        background: rgba(255, 255, 255, 0.97);
        box-shadow: 0 -2px 10px rgba(28, 20, 15, 0.04);
      }
      .lesson-program-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 2px 2px 10px;
      }
      .lesson-program-header h3 {
        margin: 0;
        font-size: 34px;
        line-height: 0.95;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .lesson-program-header span {
        font-weight: 700;
        color: #ff6f67;
      }
      .lesson-card {
        border: 1px solid rgba(38, 30, 20, 0.12);
        border-radius: 12px;
        padding: 10px;
        background: #fff;
        cursor: pointer;
        transition: transform 100ms ease, box-shadow 100ms ease, opacity 100ms ease;
      }
      .lesson-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(28, 20, 15, 0.07);
      }
      .lesson-card.locked {
        opacity: 0.72;
        cursor: not-allowed;
      }
      .lesson-card + .lesson-card {
        margin-top: 8px;
      }
      .lesson-roadmap {
        position: relative;
      }
      .lesson-roadmap::before {
        content: "";
        position: absolute;
        left: 10px;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: rgba(38, 30, 20, 0.12);
      }
      .lesson-node {
        position: relative;
        margin-left: 24px;
      }
      .lesson-node::before {
        content: "";
        position: absolute;
        left: -20px;
        top: 18px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ece6e1;
        border: 2px solid #fff9f6;
      }
      .lesson-node.unlocked::before {
        background: #b4efe1;
      }
      .lesson-card-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
      }
      .lesson-card-title {
        margin: 0;
        font-size: 31px;
        line-height: 0.94;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .lesson-card-meta {
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .lesson-type-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(38, 30, 20, 0.08);
        font-size: 12px;
      }
      .lesson-state-icon {
        font-size: 16px;
        color: #7c788f;
      }
      .lesson-page-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 0;
        padding: 2px 4px 8px;
      }
      .lesson-page-nav-title {
        flex: 1;
        font-size: 28px;
        line-height: 1;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .lesson-page-nav-dots {
        font-size: 24px;
      }
      .lesson-media {
        height: 220px;
        border-radius: 0;
        margin: 0 -16px;
        background: linear-gradient(140deg, #1b1f2a 0%, #424852 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lesson-media-play {
        width: 78px;
        height: 78px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.9);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: #fff;
      }
      .lesson-page-wrap {
        padding-bottom: 14px;
      }
      .lesson-page-meta {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .lesson-type-pill,
      .lesson-duration-pill {
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 800;
      }
      .lesson-type-pill.free {
        color: #1f9c64;
        background: #e9faef;
      }
      .lesson-type-pill.paid {
        color: #fff;
        background: #ff6f67;
      }
      .lesson-duration-pill {
        color: #5c4e45;
        background: #fff3ee;
      }
      .lesson-materials {
        margin-top: 18px;
      }
      .lesson-materials h4 {
        margin: 0 0 8px;
        font-size: 34px;
        line-height: 0.95;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .lesson-material-item {
        border: 1px solid rgba(38, 30, 20, 0.1);
        border-radius: 12px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .lesson-material-item + .lesson-material-item {
        margin-top: 8px;
      }
      .lesson-material-icon {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #fff6f2;
      }
      .lesson-material-main {
        display: inline-flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
        flex: 1;
      }
      .lesson-material-main b {
        font-size: 16px;
        line-height: 1.2;
      }
      .lesson-material-main small {
        color: var(--text-muted);
      }
      .lesson-material-download {
        font-size: 18px;
        color: #ff6f67;
      }
      .lesson-next-btn {
        margin-top: 16px;
        text-align: center;
        border-radius: 12px;
      }
      .lesson-page-card {
        border: 1px solid rgba(38, 30, 20, 0.12);
        border-radius: 14px;
        background: #fff;
        padding: 14px;
      }
      .lesson-page-card h3 {
        margin: 0 0 8px;
        font-size: 22px;
        line-height: 1.15;
      }
      .lesson-page-description {
        margin: 0 0 10px;
        color: #5e5347;
        line-height: 1.35;
      }
      .row { display: flex; gap: 8px; align-items: center; }
      .row > * { flex: 1; }
      .lesson-row, .user-row {
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(38, 30, 20, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      .pill {
        display: inline-block;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 700;
        color: #fff;
        background: #6a6171;
      }
      .pill.free { background: linear-gradient(135deg, #2d9050, #2f7f95); }
      .pill.paid { background: linear-gradient(135deg, #8e3a55, #a35333); }
      .role-switch-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      .mode-label { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      .switch { position: relative; display: inline-block; width: 46px; height: 26px; flex: 0 0 46px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d7d0c7;
        transition: 0.2s; border-radius: 999px;
      }
      .slider:before {
        position: absolute; content: ""; height: 20px; width: 20px; left: 3px; top: 3px; background: #fff;
        transition: 0.2s; border-radius: 50%;
        box-shadow: 0 1px 3px rgba(42, 31, 20, 0.22);
      }
      .switch input:checked + .slider { background-color: #f24f88; }
      .switch input:checked + .slider:before { transform: translateX(20px); }
      hr {
        border: 0;
        height: 1px;
        margin: 14px 0;
        background: rgba(43, 30, 17, 0.12);
      }
      a { color: #007ea1; }
      @keyframes cardIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @media (min-width: 860px) {
        .catalog-courses-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (max-width: 700px) {
        body { padding: 12px; }
        .card { padding: 14px; border-radius: 14px; }
        button, input, select, textarea { font-size: 16px; }
        .lesson-hero-title { font-size: 36px; }
        .lesson-card-title { font-size: 26px; }
      }
    </style>
  </head>
  <body>
    <main class="app-shell">
    <div class="card" id="user"></div>

    <div class="card hidden" id="onboardingCard">
      <b id="onboardingTitle"></b>
      <p class="muted" id="onboardingText"></p>
      <button id="onboardingBtn"></button>
    </div>

    <div class="card hidden" id="studentScreen"></div>
    <div class="card hidden" id="profileScreen"></div>
    <div class="card hidden" id="teacherScreen"></div>
    <div class="card hidden" id="adminScreen"></div>
    </main>

    <script>
      const S = window.STRINGS_RU;
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;

      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingTitle = document.getElementById("onboardingTitle");
      const onboardingText = document.getElementById("onboardingText");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const profileScreen = document.getElementById("profileScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const adminScreen = document.getElementById("adminScreen");

      let currentUser = null;
      let selectedStyleId = "";
      let selectedTeacherFilterId = "";
      let showTeacherPicker = false;
      let studentCatalogMode = "all";
      let currentStyles = [];
      let currentStudentTeachers = [];
      let selectedTeacherId = null;
      let currentStudentCourses = [];
      let currentCourseLessons = [];
      let openedStudentCourseId = null;
      let openedLessonNumber = null;
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let currentAdminUsers = [];
      let editingLessonId = null;
      let selectedAppScreen = "student";

      renderStaticTexts();

      if (!tgUser) {
        userBlock.innerHTML = `<span class="error">${S.noTelegramData}</span>`;
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderStaticTexts() {
        onboardingTitle.textContent = S.onboardingTitle;
        onboardingText.textContent = S.onboardingText;
        onboardingBtn.textContent = S.onboardingStart;
        userBlock.textContent = S.loadingUser;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function getLevel(xp) {
        if (xp >= 60) return S.levelDancer;
        if (xp >= 30) return S.levelStudent;
        return S.levelBeginner;
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      function renderCourseAuthorAvatar(course) {
        if (course.teacher_avatar_url) {
          return `<img class="course-author-avatar" src="${escapeHtml(course.teacher_avatar_url)}" alt="${escapeHtml(
            course.teacher_name || "Teacher"
          )}" />`;
        }
        return `<span class="course-author-fallback">${escapeHtml(getInitials(course.teacher_name || "T"))}</span>`;
      }

      function formatTeacherNameForCard(fullName) {
        const parts = String(fullName || "")
          .trim()
          .split(/\s+/)
          .filter(Boolean);
        if (parts.length >= 2) {
          return {
            line1: parts[1],
            line2: parts[0],
            isSingle: false,
          };
        }
        return {
          line1: parts[0] || "Преподаватель",
          line2: "",
          isSingle: true,
        };
      }

      function renderTeacherFilterAvatar(teacher) {
        if (teacher?.avatar_url) {
          return `<img class="teacher-filter-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-filter-fallback">${escapeHtml(getInitials(teacher?.name || "T"))}</span>`;
      }

      function pluralizeRu(count, forms) {
        const value = Math.abs(Number(count) || 0);
        const mod10 = value % 10;
        const mod100 = value % 100;
        if (mod10 === 1 && mod100 !== 11) return forms[0];
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return forms[1];
        return forms[2];
      }

      function courseCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["курс", "курса", "курсов"])}`;
      }

      function studentCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["ученик", "ученика", "учеников"])}`;
      }

      function getCourseLevelLabel(level) {
        if (level === "advanced") return "Продвинутый";
        if (level === "professional") return "Профессионал";
        return "Новичок";
      }

      function getCourseLevelClass(level) {
        if (level === "advanced") return "advanced";
        if (level === "professional") return "professional";
        return "beginner";
      }

      function normalizeLessonTitle(lesson) {
        let rawTitle = String(lesson?.title || "").trim();
        if (!rawTitle) {
          return `${S.lessonsTitle.slice(0, -1)} ${lesson?.lesson_number || ""}`.trim();
        }
        while (/^урок\s*\d+\s*:\s*/i.test(rawTitle)) {
          rawTitle = rawTitle.replace(/^урок\s*\d+\s*:\s*/i, "").trim();
        }
        return rawTitle;
      }

      function renderLessonHero(course) {
        const levelClass = getCourseLevelClass(course?.level);
        const teacherName = course?.teacher_name || "Преподаватель";
        const title = course?.title || "Курс";
        return `
          <div class="lesson-hero level-${levelClass}">
            <div class="lesson-hero-author">
              ${renderCourseAuthorAvatar(course || {})}
              <div class="lesson-hero-name">${escapeHtml(teacherName)}</div>
            </div>
            <h2 class="lesson-hero-title">${escapeHtml(title)}</h2>
          </div>
        `;
      }

      function getTeacherAccent(teacherId) {
        const palette = [
          { chipBg: "#fde8ee" },
          { chipBg: "#e3f5fb" },
          { chipBg: "#faefde" },
          { chipBg: "#edf5e7" },
          { chipBg: "#f0eafa" },
          { chipBg: "#fbe9ef" },
        ];
        const index = Math.abs(Number(teacherId) || 0) % palette.length;
        return palette[index];
      }

      function renderStyleFilterChips(styles) {
        return `
          <div class="style-chips">
            <button class="style-chip ${selectedStyleId ? "" : "active"}" onclick="setStyleFilter('')">${S.allStyles}</button>
            ${styles
              .map(
                (style) =>
                  `<button class="style-chip ${String(style.id) === String(selectedStyleId) ? "active" : ""}" onclick="setStyleFilter('${style.id}')">${escapeHtml(style.name)}</button>`
              )
              .join("")}
          </div>
        `;
      }

      function renderStudentProof(teacher) {
        const avatars = Array.isArray(teacher.student_avatars_preview)
          ? teacher.student_avatars_preview.filter(Boolean).slice(0, 3)
          : [];
        const studentsCount = Number(teacher.students_count || 0);
        if (!studentsCount) return "";
        return `
          <div class="teacher-proof">
            <small class="teacher-proof-label">${studentCountLabel(studentsCount)}</small>
            <div class="mini-avatars">
              ${avatars.map((url) => `<img src="${escapeHtml(url)}" alt="student" />`).join("")}
              ${studentsCount > avatars.length ? `<span>+${studentsCount - avatars.length}</span>` : ""}
            </div>
          </div>
        `;
      }

      function setStyleFilter(styleId) {
        selectedStyleId = styleId ? String(styleId) : "";
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function toggleTeacherPicker() {
        showTeacherPicker = !showTeacherPicker;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function closeTeacherPicker() {
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function selectTeacherFilter(teacherId) {
        selectedTeacherFilterId = String(teacherId || "");
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function clearTeacherFilter(event) {
        if (event && typeof event.stopPropagation === "function") event.stopPropagation();
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderTeacherFilterControl(teachers) {
        const selectedTeacher = teachers.find((teacher) => String(teacher.id) === String(selectedTeacherFilterId));
        if (!selectedTeacher) {
          return `<button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">Все преподаватели</button>`;
        }

        return `
          <button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">
            ${renderTeacherFilterAvatar(selectedTeacher)}
            <span>${escapeHtml(selectedTeacher.name || "Преподаватель")}</span>
            <span class="teacher-filter-clear" onclick="clearTeacherFilter(event)">×</span>
          </button>
        `;
      }

      function renderTeacherPicker(teachers) {
        if (!showTeacherPicker) return "";
        const selectedId = String(selectedTeacherFilterId || "");
        return `
          <div class="teacher-picker-overlay" onclick="closeTeacherPicker()">
            <div class="teacher-picker" onclick="event.stopPropagation()">
              <div class="teacher-picker-head">
                <h3>Выберите преподавателя</h3>
                <button class="secondary teacher-picker-close" onclick="closeTeacherPicker()">×</button>
              </div>
              <button class="teacher-picker-item" onclick="clearTeacherFilter()">
                <span class="teacher-picker-avatar">👥</span>
                <span class="teacher-picker-main">
                  <span class="teacher-picker-name">Все преподаватели</span>
                </span>
                <span class="teacher-picker-radio ${!selectedId ? "selected" : ""}"></span>
              </button>
              ${teachers
                .map(
                  (teacher) => `
                    <button class="teacher-picker-item" onclick="selectTeacherFilter(${teacher.id})">
                      ${renderTeacherFilterAvatar(teacher)}
                      <span class="teacher-picker-main">
                        <span class="teacher-picker-name">${escapeHtml(teacher.name || "Преподаватель")}</span>
                        <span class="teacher-picker-sub">${escapeHtml((teacher.styles || []).map((s) => s.name).join(", ") || "Направления")}</span>
                      </span>
                      <span class="teacher-picker-radio ${String(teacher.id) === selectedId ? "selected" : ""}"></span>
                    </button>
                  `
                )
                .join("")}
            </div>
          </div>
        `;
      }

      function renderTeacherCard(teacher) {
        const accent = getTeacherAccent(teacher.id);
        const styles = Array.isArray(teacher.styles) ? teacher.styles : [];
        const visibleStyles = styles.slice(0, 2);
        const overflowCount = Math.max(styles.length - visibleStyles.length, 0);
        return `
          <div class="teacher-card" onclick="loadCourses(${teacher.id})" style="--teacher-chip-bg:${accent.chipBg};">
            <div class="teacher-card-head">
              ${renderTeacherAvatar(teacher)}
              <div class="teacher-content">
                <h3 class="teacher-name">${escapeHtml(teacher.name || "Преподаватель")}</h3>
                <div class="teacher-courses-count">${courseCountLabel(Number(teacher.published_courses_count || 0))}</div>
              </div>
            </div>
            <div class="teacher-style-row">
              ${
                visibleStyles.length
                  ? visibleStyles.map((style) => `<span class="teacher-style-chip">${escapeHtml(style.name)}</span>`).join("")
                  : `<span class="teacher-style-chip">Направление не указано</span>`
              }
              ${overflowCount ? `<span class="teacher-style-chip">+${overflowCount}</span>` : ""}
            </div>
            ${renderStudentProof(teacher)}
          </div>
        `;
      }

      function formatRub(value) {
        return `${Number(value || 0)} ₽`;
      }

      function renderStudentHeader(title, subtitle = "", backAction = "") {
        const backPart = backAction
          ? `<button class="secondary back-btn" onclick="${backAction}">← Назад</button>`
          : `<span class="back-spacer"></span>`;
        return `
          <div class="student-header">
            <div class="student-header-top">
              ${backPart}
              <h2 class="student-header-title">${escapeHtml(title)}</h2>
            </div>
            ${subtitle ? `<p class="section-subtitle">${escapeHtml(subtitle)}</p>` : ""}
          </div>
        `;
      }

      async function bootstrap() {
        bindEvents();
        await syncProfileFromTelegram();
        await loadCurrentUser();
        await routeByRole();
      }

      async function syncProfileFromTelegram() {
        await apiFetch("/api/profile/sync", {
          method: "POST",
          body: JSON.stringify({
            first_name: tgUser.first_name,
            last_name: tgUser.last_name,
            username: tgUser.username,
            avatar_url: tgUser.photo_url,
          }),
        });
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        const avatarUrl = currentUser.avatar_url || tgUser.photo_url || "";
        const helloName =
          [currentUser.last_name, currentUser.first_name].filter(Boolean).join(" ") ||
          [tgUser.last_name, tgUser.first_name].filter(Boolean).join(" ") ||
          currentUser.username ||
          S.userDefaultName;

        userBlock.innerHTML = `
          <div class="profile-top" onclick="openProfileMenu()">
            ${
              avatarUrl
                ? `<img class="profile-avatar" src="${escapeHtml(avatarUrl)}" alt="profile avatar" />`
                : `<span class="profile-avatar-fallback">${escapeHtml(getInitials(currentUser.first_name || tgUser.first_name || "U"))}</span>`
            }
            <div class="profile-greeting">Привет, ${escapeHtml(helloName)}</div>
          </div>
        `;
      }

      function openProfileMenu() {
        selectedAppScreen = "profile";
        routeByRole().catch((error) => {
          profileScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openStudentScreen() {
        selectedAppScreen = "student";
        routeByRole().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openTeacherCabinet() {
        selectedAppScreen = "teacher";
        routeByRole().catch((error) => {
          teacherScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openAdminPanel() {
        selectedAppScreen = "admin";
        routeByRole().catch((error) => {
          adminScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openSupport() {
        tg.showAlert("Напиши в поддержку: @letsdancewithme_support");
      }

      function openMySubscriptions() {
        studentCatalogMode = "subscriptions";
        openStudentScreen();
      }

      function openAllCourses() {
        studentCatalogMode = "all";
        openStudentScreen();
      }

      async function renderProfileScreen() {
        profileScreen.innerHTML = `
          ${renderStudentHeader("Профиль", "", "openStudentScreen()")}
          <div class="profile-menu">
            <button onclick="openMySubscriptions()">Мои подписки</button>
            ${currentUser.role === "teacher" || currentUser.role === "admin" ? `<button onclick="openTeacherCabinet()">Мои курсы</button>` : ""}
            ${currentUser.role === "admin" ? `<button onclick="openAdminPanel()">Администрирование</button>` : ""}
            <button class="secondary" onclick="openSupport()">Поддержка</button>
            <button class="secondary" onclick="openAllCourses()">Все курсы</button>
          </div>
        `;
      }

      async function completeOnboarding() {
        await apiFetch("/api/onboarding/complete", { method: "POST" });
        await loadCurrentUser();
        await routeByRole();
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        profileScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");
        adminScreen.classList.add("hidden");

        if (selectedAppScreen === "profile") {
          profileScreen.classList.remove("hidden");
          await renderProfileScreen();
          return;
        }

        const canUseTeacher = currentUser.role === "teacher" || currentUser.role === "admin";
        const canUseAdmin = currentUser.role === "admin";
        const showTeacherScreen = selectedAppScreen === "teacher" && canUseTeacher;
        const showAdminScreen = selectedAppScreen === "admin" && canUseAdmin;

        if (!currentUser.is_onboarded && !(showTeacherScreen || showAdminScreen)) {
          onboardingCard.classList.remove("hidden");
        }

        if (showAdminScreen) {
          adminScreen.classList.remove("hidden");
          await renderAdminScreen();
          return;
        }

        if (showTeacherScreen) {
          teacherScreen.classList.remove("hidden");
          await renderTeacherScreen();
          return;
        }

        studentScreen.classList.remove("hidden");
        await renderStudentScreen();
      }

      async function renderStudentScreen() {
        studentScreen.classList.add("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = null;
        openedLessonNumber = null;
        const [teachers, styles] = await Promise.all([apiFetch("/api/teachers"), apiFetch("/api/styles")]);
        currentStudentTeachers = teachers;
        currentStyles = styles;
        const styleQuery = selectedStyleId ? `&styleId=${selectedStyleId}` : "";
        const teacherQuery = selectedTeacherFilterId ? `&teacherId=${selectedTeacherFilterId}` : "";
        const purchasedQuery = studentCatalogMode === "subscriptions" ? "&purchased=1" : "";
        const courses = await apiFetch(`/api/student/courses?1=1${styleQuery}${teacherQuery}${purchasedQuery}`);
        currentStudentCourses = courses;
        studentScreen.innerHTML = `
          <div class="catalog-header-space"></div>
          ${renderStyleFilterChips(styles)}
          <div class="catalog-bar">
            <div class="catalog-row">
              <div class="teacher-filter-wrap">
                ${renderTeacherFilterControl(teachers)}
              </div>
            </div>
            ${renderTeacherPicker(teachers)}
          </div>
          <div class="catalog-courses-grid">
          ${
            courses.length
              ? courses
                  .map(
                    (course) => {
                      const levelClass = getCourseLevelClass(course.level);
                      const levelLabel = getCourseLevelLabel(course.level);
                      const author = formatTeacherNameForCard(course.teacher_name);
                      const progressPercent = Number(course.progress_percent || 0);
                      const purchaseBadge = course.is_purchased ? "FREE" : "PAID";
                      return `
                <div class="course-card catalog-course-card level-${levelClass}" onclick="openCourse(${course.id})">
                  <div class="course-head">
                    <div class="course-card-title">${escapeHtml(course.title)}</div>
                    <div class="course-head-side">
                      <span class="course-level-badge ${levelClass}">${levelLabel}</span>
                      <span class="course-access-badge ${course.is_purchased ? "free" : "paid"}">${purchaseBadge}</span>
                    </div>
                  </div>
                  <div class="course-top-row">
                    <div class="course-author">
                      ${renderCourseAuthorAvatar(course)}
                      <div class="course-author-name ${author.isSingle ? "single" : ""}">
                        <span class="course-author-line">${escapeHtml(author.line1)}</span>
                        ${author.line2 ? `<span class="course-author-line">${escapeHtml(author.line2)}</span>` : ""}
                      </div>
                    </div>
                    ${
                      progressPercent > 0
                        ? `<div class="course-progress-inline">
                            <div class="course-progress-track">
                              <div class="course-progress-fill" style="width:${Math.max(0, Math.min(100, progressPercent))}%"></div>
                            </div>
                            <div class="course-progress-label">${progressPercent}%</div>
                          </div>`
                        : ""
                    }
                  </div>
                </div>
              `;
                    }
                  )
                  .join("")
              : `<small class="muted">Курсы не найдены.</small>`
          }
          </div>
        `;
      }

      async function loadCourses(teacherId) {
        studentScreen.classList.remove("flat-list");
        selectedTeacherId = teacherId;
        openedStudentCourseId = null;
        openedLessonNumber = null;
        const selectedTeacher = currentStudentTeachers.find((teacher) => Number(teacher.id) === Number(teacherId));
        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, S.loadingCourses, "renderStudentScreen()")}
        `;
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);
        currentStudentCourses = courses;
        const coursesSubtitle = selectedTeacher
          ? `Преподаватель: ${selectedTeacher.name}${
              selectedStyleId
                ? ` • ${currentStyles.find((item) => String(item.id) === String(selectedStyleId))?.name || ""}`
                : ""
            }`
          : "Выбери курс для старта.";

        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, coursesSubtitle, "renderStudentScreen()")}
          <div class="stack">
            ${
              courses.length
                ? courses
                    .map(
                      (course) => `
                  <div class="course-card">
                    <div class="course-card-title">${escapeHtml(course.title)}</div>
                    <small class="muted">${escapeHtml(course.description || "")}</small>
                    <div class="course-card-meta">
                      <small class="muted">${S.priceLabel}: ${formatRub(course.price)}</small>
                      <small class="pill ${course.is_purchased ? "free" : "paid"}">${course.is_purchased ? S.purchased : S.notPurchased}</small>
                    </div>
                    <button onclick="openCourse(${course.id})">Открыть уроки</button>
                  </div>
                `
                    )
                    .join("")
                : `<small class="muted">По выбранным фильтрам курсы не найдены.</small>`
            }
          </div>
        `;
      }

      async function openCourse(courseId) {
        studentScreen.classList.add("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = courseId;
        openedLessonNumber = null;
        studentScreen.innerHTML = `
          <div class="section-subtitle">${S.loadingLessons}</div>
        `;
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        currentCourseLessons = lessons;
        const course = currentStudentCourses.find((item) => item.id === courseId);
        const hasPaidLessons = lessons.some((lesson) => !lesson.is_free);
        const showBuyButton = hasPaidLessons && course && !course.is_purchased;
        const levelClass = getCourseLevelClass(course?.level);
        const styleChips = Array.isArray(course?.styles) ? course.styles : [];
        const progressPercent = Number(course?.progress_percent || 0);
        const completedLessons = Number(course?.completed_lessons || 0);

        studentScreen.innerHTML = `
          <div class="lesson-hero level-${levelClass}">
            <div class="lesson-hero-nav">
              <button class="secondary hero-icon-btn" onclick="openStudentScreen()">←</button>
            </div>
            ${
              styleChips.length
                ? `<div class="lesson-hero-tags">${styleChips
                    .slice(0, 2)
                    .map((style) => `<span class="lesson-hero-tag">${escapeHtml(style.name)}</span>`)
                    .join("")}</div>`
                : ""
            }
            <h2 class="lesson-hero-title">${escapeHtml(course?.title || "Курс")}</h2>
            <div class="lesson-hero-author">
              ${renderCourseAuthorAvatar(course || {})}
              <div>
                <div class="lesson-hero-name">${escapeHtml(course?.teacher_name || "Преподаватель")}</div>
                <div class="lesson-hero-role">Преподаватель</div>
              </div>
            </div>
          </div>
          <div class="lesson-list-wrap">
            ${showBuyButton ? `<button onclick="purchaseCourse(${courseId})">${S.buyCourse} ${formatRub(course.price)}</button>` : ""}
            <div class="lesson-program-header">
              <h3>Программа</h3>
              <span>${Math.max(0, Math.min(100, progressPercent))}% пройдено</span>
            </div>
            <div class="lesson-roadmap">
              ${
                lessons.length
                  ? lessons
                      .map((lesson) => {
                        const typeIcon = lesson.is_free ? "🆓" : "💳";
                        const durationText = lesson.duration_sec
                          ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}`
                          : S.noDuration;
                        const isCompleted = lesson.lesson_number <= completedLessons;
                        const stateIcon = lesson.is_unlocked ? (isCompleted ? "↻" : "▶") : "🔒";
                        const previewHtml = lesson.preview_url
                          ? `<small><a href="${escapeHtml(
                              lesson.preview_url
                            )}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small>`
                          : "";
                        const title = normalizeLessonTitle(lesson);
                        const action = lesson.is_unlocked ? `onclick="openLessonPage(${courseId}, ${lesson.lesson_number})"` : "";
                        return `
                  <div class="lesson-node ${lesson.is_unlocked ? "unlocked" : ""}">
                    <div class="lesson-card ${lesson.is_unlocked ? "" : "locked"}" ${action}>
                      <div class="lesson-card-head">
                        <h3 class="lesson-card-title">${escapeHtml(title)}</h3>
                        <span class="lesson-state-icon">${stateIcon}</span>
                      </div>
                      <div class="lesson-card-meta">
                        <span class="lesson-type-icon" title="${lesson.is_free ? S.free : S.paid}">${typeIcon}</span>
                        <small class="muted">${durationText}</small>
                        ${previewHtml}
                      </div>
                    </div>
                  </div>
                `;
                      })
                      .join("")
                  : `<small class="muted">В этом курсе пока нет уроков.</small>`
              }
            </div>
          </div>
        `;
      }

      function openLessonPage(courseId, lessonNumber) {
        const lesson = currentCourseLessons.find((item) => Number(item.lesson_number) === Number(lessonNumber));
        const course = currentStudentCourses.find((item) => Number(item.id) === Number(courseId));
        if (!lesson) return;
        openedLessonNumber = lessonNumber;

        const durationText = lesson.duration_sec ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}` : S.noDuration;
        const previewHtml = lesson.preview_url
          ? `<p class="lesson-page-description"><a href="${escapeHtml(
              lesson.preview_url
            )}" target="_blank" rel="noopener noreferrer">${S.preview}</a></p>`
          : "";
        const hasNextLesson = currentCourseLessons.some((item) => Number(item.lesson_number) === Number(lesson.lesson_number) + 1);

        studentScreen.innerHTML = `
          <div class="lesson-page-nav">
            <button class="secondary hero-icon-btn" onclick="openCourse(${courseId})">←</button>
            <div class="lesson-page-nav-title">Урок ${lesson.lesson_number}</div>
            <span class="lesson-page-nav-dots">⋮</span>
          </div>
          <div class="lesson-media">
            <div class="lesson-media-play">▶</div>
          </div>
          <div class="lesson-page-wrap">
            <div class="lesson-page-card">
              <div class="lesson-page-meta">
                <span class="lesson-type-pill ${lesson.is_free ? "free" : "paid"}">${lesson.is_free ? "FREE" : "PAID"}</span>
                <span class="lesson-duration-pill">⏱ ${durationText}</span>
              </div>
              <h3>${escapeHtml(normalizeLessonTitle(lesson))}</h3>
              <p class="lesson-page-description">${escapeHtml(lesson.description || "Описание будет добавлено позже.")}</p>
              ${previewHtml}
              <div class="lesson-materials">
                <h4>Материалы</h4>
                <div class="lesson-material-item">
                  <span class="lesson-material-icon">♫</span>
                  <span class="lesson-material-main"><b>Трек для тренировки.mp3</b><small>4.2 MB</small></span>
                  <span class="lesson-material-download">⇩</span>
                </div>
                <div class="lesson-material-item">
                  <span class="lesson-material-icon">📄</span>
                  <span class="lesson-material-main"><b>Памятка по шагам.pdf</b><small>1.5 MB</small></span>
                  <span class="lesson-material-download">⇩</span>
                </div>
              </div>
              <button class="lesson-next-btn" onclick="doLesson(${courseId}, ${lesson.lesson_number})">${hasNextLesson ? "Следующий урок →" : "Завершить урок"}</button>
            </div>
          </div>
        `;
      }

      async function purchaseCourse(courseId) {
        await apiFetch(`/api/courses/${courseId}/purchase`, { method: "POST" });
        const selectedCourse = currentStudentCourses.find((item) => item.id === courseId);
        if (selectedCourse) selectedCourse.is_purchased = true;
        tg.showAlert(S.coursePurchaseSuccess);
        await openCourse(courseId);
      }

      async function doLesson(courseId, lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({ telegramId: tgUser.id, courseId, lessonNumber }),
        });

        if (data.blocked) {
          const message =
            data.reason === "course_purchase_required" ? S.lessonLockedNeedPurchase : S.lessonLockedGeneric;
          tg.showPopup({ title: S.lessonLockedTitle, message, buttons: [{ type: "ok" }] });
          return;
        }

        await loadCurrentUser();
        if (openedStudentCourseId) {
          await openCourse(openedStudentCourseId);
          const nextLesson = currentCourseLessons.find((item) => Number(item.lesson_number) === Number(lessonNumber) + 1 && item.is_unlocked);
          if (nextLesson) {
            openLessonPage(openedStudentCourseId, nextLesson.lesson_number);
            return;
          }
          if (openedLessonNumber) openLessonPage(openedStudentCourseId, openedLessonNumber);
        }
      }

      async function renderTeacherScreen() {
        teacherScreen.innerHTML = `
          <b>${S.teacherCabinet}</b>
          <p class="muted">${S.profileTitle}</p>
          <input id="teacherName" placeholder="${S.teacherNamePh}" />
          <input id="teacherDescription" placeholder="${S.teacherDescriptionPh}" />
          <input id="teacherAvatarUrl" placeholder="${S.teacherAvatarPh}" />
          <button id="saveTeacherProfileBtn">${S.saveProfile}</button>
          <hr />
          <p class="muted">${S.newCourseTitle}</p>
          <input id="courseTitle" placeholder="${S.courseNamePh}" />
          <input id="courseDescription" placeholder="${S.courseDescriptionPh}" />
          <div class="row">
            <input id="coursePrice" type="number" placeholder="${S.coursePricePh}" min="199" />
            <select id="courseLevel">
              <option value="beginner">Новичок</option>
              <option value="advanced">Продвинутый</option>
              <option value="professional">Профессионал</option>
            </select>
          </div>
          <div class="row">
            <select id="coursePublished">
              <option value="true">${S.published}</option>
              <option value="false">${S.hidden}</option>
            </select>
          </div>
          <button id="createCourseBtn">${S.createCourse}</button>
          <hr />
          <p class="muted">${S.teacherLessonsTitle}</p>
          <select id="teacherCourseSelect"></select>
          <div class="row">
            <input id="lessonNumber" type="number" min="1" placeholder="${S.lessonNumberPh}" />
            <input id="lessonDuration" type="number" min="1" placeholder="${S.lessonDurationPh}" />
          </div>
          <input id="lessonTitle" placeholder="${S.lessonNamePh}" />
          <input id="lessonPreviewUrl" placeholder="${S.lessonPreviewPh}" />
          <textarea id="lessonDescription" placeholder="${S.lessonDescriptionPh}"></textarea>
          <select id="lessonIsFree">
            <option value="true">${S.lessonFree}</option>
            <option value="false">${S.lessonPaid}</option>
          </select>
          <button id="saveLessonBtn">${S.saveLesson}</button>
          <div id="teacherCourses" class="muted">${S.loading}</div>
          <div id="teacherLessons" class="muted">${S.chooseCourse}</div>
        `;

        const teacherNameInput = document.getElementById("teacherName");
        const teacherDescriptionInput = document.getElementById("teacherDescription");
        const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
        const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");
        const courseTitleInput = document.getElementById("courseTitle");
        const courseDescriptionInput = document.getElementById("courseDescription");
        const coursePriceInput = document.getElementById("coursePrice");
        const courseLevelInput = document.getElementById("courseLevel");
        const coursePublishedInput = document.getElementById("coursePublished");
        const createCourseBtn = document.getElementById("createCourseBtn");
        const teacherCourseSelect = document.getElementById("teacherCourseSelect");
        const lessonNumberInput = document.getElementById("lessonNumber");
        const lessonDurationInput = document.getElementById("lessonDuration");
        const lessonTitleInput = document.getElementById("lessonTitle");
        const lessonPreviewInput = document.getElementById("lessonPreviewUrl");
        const lessonDescriptionInput = document.getElementById("lessonDescription");
        const lessonIsFreeInput = document.getElementById("lessonIsFree");
        const saveLessonBtn = document.getElementById("saveLessonBtn");
        const teacherCoursesBlock = document.getElementById("teacherCourses");
        const teacherLessonsBlock = document.getElementById("teacherLessons");

        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";

        saveTeacherProfileBtn.addEventListener("click", async () => {
          await apiFetch("/api/teacher/profile", {
            method: "PUT",
            body: JSON.stringify({
              name: teacherNameInput.value.trim(),
              description: teacherDescriptionInput.value.trim(),
              avatarUrl: teacherAvatarInput.value.trim(),
            }),
          });
          tg.showAlert(S.profileSaved);
        });

        async function loadTeacherCoursesData() {
          currentTeacherCourses = await apiFetch("/api/teacher/courses");
          teacherCoursesBlock.innerHTML =
            `<b>${S.yourCourses}</b><br/><br/>` +
            (currentTeacherCourses.length
              ? currentTeacherCourses
                  .map(
                    (course) =>
                      `• ${escapeHtml(course.title)} — ${getCourseLevelLabel(course.level)} — ${Number(course.price || 0)} ₽ (${
                        course.is_published ? S.published.toLowerCase() : S.hidden.toLowerCase()
                      })`
                  )
                  .join("<br/>")
              : S.noCoursesYet);

          teacherCourseSelect.innerHTML = currentTeacherCourses.length
            ? currentTeacherCourses.map((course) => `<option value="${course.id}">${escapeHtml(course.title)}</option>`).join("")
            : `<option value="">${S.noCourses}</option>`;
        }

        async function loadTeacherLessonsData() {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) {
            teacherLessonsBlock.textContent = S.chooseCourse;
            return;
          }

          const lessons = await apiFetch(`/api/teacher/courses/${courseId}/lessons`);
          currentTeacherLessons = lessons;
          teacherLessonsBlock.innerHTML =
            `<b>${S.selectedCourseLessons}</b><br/><br/>` +
            (lessons.length
              ? lessons
                  .map(
                    (lesson) => `
                      <div class="lesson-row">
                        <b>${lesson.lesson_number}. ${escapeHtml(lesson.title)}</b><br/>
                        <small class="muted">${escapeHtml(lesson.description || "")}</small><br/>
                        <small class="muted">${lesson.is_free ? S.free : S.paid} • ${
                          lesson.duration_sec ? `${lesson.duration_sec} ${S.seconds}` : S.noDuration
                        }</small><br/>
                        ${
                          lesson.preview_url
                            ? `<small><a href="${escapeHtml(lesson.preview_url)}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small><br/>`
                            : ""
                        }
                        <button class="secondary" onclick="editLessonById(${lesson.id})">${S.editLesson}</button>
                      </div>
                    `
                  )
                  .join("")
              : S.noLessonsYet);
        }

        createCourseBtn.addEventListener("click", async () => {
          const title = courseTitleInput.value.trim();
          const price = Number(coursePriceInput.value || 0);
          if (!title) return tg.showAlert(S.needCourseName);
          if (!Number.isFinite(price) || price < 199) return tg.showAlert(S.minCoursePriceError);

          await apiFetch("/api/teacher/courses", {
            method: "POST",
            body: JSON.stringify({
              title,
              description: courseDescriptionInput.value.trim(),
              price,
              level: courseLevelInput.value,
              isPublished: coursePublishedInput.value === "true",
              styleIds: [],
            }),
          });
          courseTitleInput.value = "";
          courseDescriptionInput.value = "";
          coursePriceInput.value = "";
          courseLevelInput.value = "beginner";
          await loadTeacherCoursesData();
          await loadTeacherLessonsData();
          tg.showAlert(S.courseCreated);
        });

        teacherCourseSelect.addEventListener("change", loadTeacherLessonsData);

        function resetLessonForm() {
          editingLessonId = null;
          lessonNumberInput.value = "";
          lessonDurationInput.value = "";
          lessonTitleInput.value = "";
          lessonPreviewInput.value = "";
          lessonDescriptionInput.value = "";
          lessonIsFreeInput.value = "true";
          saveLessonBtn.textContent = S.saveLesson;
        }

        window.editLessonById = function editLessonById(lessonId) {
          const lesson = currentTeacherLessons.find((item) => item.id === lessonId);
          if (!lesson) return;
          editingLessonId = lesson.id;
          lessonNumberInput.value = lesson.lesson_number;
          lessonDurationInput.value = lesson.duration_sec || "";
          lessonTitleInput.value = lesson.title || "";
          lessonPreviewInput.value = lesson.preview_url || "";
          lessonDescriptionInput.value = lesson.description || "";
          lessonIsFreeInput.value = lesson.is_free ? "true" : "false";
          saveLessonBtn.textContent = S.updateLesson;
        };

        saveLessonBtn.addEventListener("click", async () => {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) return tg.showAlert(S.chooseCourseError);

          const payload = {
            lessonNumber: Number(lessonNumberInput.value),
            title: lessonTitleInput.value.trim(),
            description: lessonDescriptionInput.value.trim(),
            isFree: lessonIsFreeInput.value === "true",
            durationSec: lessonDurationInput.value ? Number(lessonDurationInput.value) : null,
            previewUrl: lessonPreviewInput.value.trim() || null,
          };

          if (!payload.lessonNumber || !payload.title) return tg.showAlert(S.fillLessonError);

          if (editingLessonId) {
            await apiFetch(`/api/teacher/lessons/${editingLessonId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch(`/api/teacher/courses/${courseId}/lessons`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }

          resetLessonForm();
          await loadTeacherLessonsData();
          tg.showAlert(S.lessonSaved);
        });

        await loadTeacherCoursesData();
        await loadTeacherLessonsData();
      }

      async function renderAdminScreen() {
        adminScreen.innerHTML = `
          <b>${S.adminPanelTitle}</b>
          <p class="muted">${S.adminPanelText}</p>
          <button class="secondary" id="refreshAdminUsersBtn">${S.refreshUsers}</button>
          <div id="adminUsersList" class="muted">${S.loadingUsers}</div>
        `;

        const refreshAdminUsersBtn = document.getElementById("refreshAdminUsersBtn");
        const adminUsersList = document.getElementById("adminUsersList");

        async function loadAdminUsers() {
          currentAdminUsers = await apiFetch("/api/admin/users");
          adminUsersList.innerHTML = currentAdminUsers.length
            ? currentAdminUsers
                .map(
                  (user) => `
                    <div class="user-row">
                      ${
                        user.avatar_url
                          ? `<img class="teacher-avatar" src="${escapeHtml(user.avatar_url)}" alt="avatar" />`
                          : `<span class="teacher-avatar-fallback">${escapeHtml(
                              getInitials(user.first_name || user.username || String(user.telegram_id))
                            )}</span>`
                      }
                      <b>${escapeHtml(
                        [user.first_name, user.last_name].filter(Boolean).join(" ") || "Без имени"
                      )}</b><br/>
                      ${
                        user.username
                          ? `<small class="muted">@${escapeHtml(user.username)}</small><br/>`
                          : ""
                      }
                      <b>${S.userIdLabel}:</b> ${user.telegram_id}<br/>
                      <small class="muted">${S.userRoleLabel}: ${escapeHtml(user.role)} | XP: ${user.xp} | ${S.userLessonsLabel}: ${user.lessons_completed}</small>
                      <div class="role-switch-row">
                        <small>${S.teacherRoleSwitch}${user.telegram_id === currentUser.telegram_id ? " (недоступно для себя)" : ""}</small>
                        <label class="switch">
                          <input
                            type="checkbox"
                            ${user.role === "teacher" ? "checked" : ""}
                            ${user.telegram_id === currentUser.telegram_id ? "disabled" : ""}
                            onchange="setTeacherRoleSwitch(${user.telegram_id}, this.checked)"
                          />
                          <span class="slider"></span>
                        </label>
                      </div>
                    </div>
                  `
                )
                .join("")
            : S.usersEmpty;
        }

        window.setTeacherRoleSwitch = async function setTeacherRoleSwitch(telegramId, checked) {
          if (Number(telegramId) === Number(currentUser.telegram_id)) {
            tg.showAlert("Нельзя изменить свою роль из админ-панели");
            return;
          }
          const role = checked ? "teacher" : "student";
          await apiFetch(`/api/admin/users/${telegramId}/role`, {
            method: "PUT",
            body: JSON.stringify({ role }),
          });
          tg.showAlert(S.roleUpdated);
          await loadAdminUsers();
        };

        refreshAdminUsersBtn.addEventListener("click", loadAdminUsers);
        await loadAdminUsers();
      }

      window.renderStudentScreen = renderStudentScreen;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.openLessonPage = openLessonPage;
      window.purchaseCourse = purchaseCourse;
      window.doLesson = doLesson;
      window.setStyleFilter = setStyleFilter;
      window.toggleTeacherPicker = toggleTeacherPicker;
      window.closeTeacherPicker = closeTeacherPicker;
      window.selectTeacherFilter = selectTeacherFilter;
      window.clearTeacherFilter = clearTeacherFilter;
      window.openProfileMenu = openProfileMenu;
      window.openStudentScreen = openStudentScreen;
      window.openMySubscriptions = openMySubscriptions;
      window.openAllCourses = openAllCourses;
      window.openTeacherCabinet = openTeacherCabinet;
      window.openAdminPanel = openAdminPanel;
      window.openSupport = openSupport;
    </script>
  </body>
</html>


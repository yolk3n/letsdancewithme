<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Let's Dance With Me</title>

    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
      }

      h1 {
        margin-top: 0;
      }

      .card {
        background: #1e1e1e;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 15px;
        border-radius: 8px;
        border: none;
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }

      button.secondary {
        background: #333;
      }

      button:active {
        background: #e03a58;
      }

      .error {
        color: #ff8080;
      }

      small {
        color: #bbb;
      }

      .teacher-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .teacher-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex: 0 0 44px;
      }

      .teacher-avatar-fallback {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        flex: 0 0 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        background: #2b2b2b;
        color: #fff;
      }

      .teacher-content {
        min-width: 0;
      }
    </style>
  </head>

  <body>
    <h1>üíÉ Let's Dance With Me</h1>

    <div class="card" id="user">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>
    <div class="card" id="screen">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const userBlock = document.getElementById("user");
      const screen = document.getElementById("screen");

      const tgUser = tg.initDataUnsafe?.user;

      if (!tgUser) {
        userBlock.innerHTML =
          '<span class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</span>';
      } else {
        loadUser();
        loadTeachers();
      }

      /* =========================
         USER
      ========================= */

      function getLevel(xp) {
        if (xp >= 60) return "üíÉ –¢–∞–Ω—Ü–æ—Ä";
        if (xp >= 30) return "ü•ã –£—á–µ–Ω–∏–∫";
        return "üå± –ù–æ–≤–∏—á–æ–∫";
      }

      function loadUser() {
        fetch(`/api/user/${tgUser.id}`)
          .then((res) => res.json())
          .then((data) => {
            userBlock.innerHTML = `
              <b>${tgUser.first_name}</b><br/>
              ‚≠ê XP: ${data.xp}<br/>
              üèÖ –£—Ä–æ–≤–µ–Ω—å: ${getLevel(data.xp)}<br/>
              üìö –£—Ä–æ–∫–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: ${data.lessons_completed}
            `;
          })
          .catch(() => {
            userBlock.innerHTML =
              '<span class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>';
          });
      }

      /* =========================
         TEACHERS
      ========================= */

      function loadTeachers() {
        screen.innerHTML = "<b>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b><br/><br/>–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch("/api/teachers")
          .then((res) => res.json())
          .then((teachers) => {
            screen.innerHTML =
              "<b>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b><br/><br/>" +
              teachers
                .map(
                  (t) => `
                  <button class="teacher-btn" onclick="loadCourses(${t.id})">
                    ${renderTeacherAvatar(t)}
                    <span class="teacher-content">
                      ${t.name}<br/>
                      <small>${t.description || ""}</small>
                    </span>
                  </button>
                `
                )
                .join("");
          })
          .catch(() => {
            screen.innerHTML =
              '<span class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</span>';
          });
      }

      /* =========================
         COURSES
      ========================= */

      function loadCourses(teacherId) {
        screen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...";
        fetch(`/api/courses/${teacherId}`)
          .then((res) => res.json())
          .then((courses) => {
            screen.innerHTML =
              "<b>–ö—É—Ä—Å—ã</b><br/><br/>" +
              courses
                .map(
                  (c) => `
                  <button onclick="openCourse(${c.id})">
                    ${c.title}<br/>
                    <small>${c.description}</small>
                  </button>
                `
                )
                .join("") +
              `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
          })
          .catch(() => {
            screen.innerHTML =
              '<span class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤</span>';
          });
      }

      /* =========================
         LESSONS
      ========================= */

      function openCourse(courseId) {
        screen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...";
        fetch(`/api/lessons/${courseId}`)
          .then((res) => res.json())
          .then((lessons) => {
            screen.innerHTML =
              "<b>–£—Ä–æ–∫–∏</b><br/><br/>" +
              lessons
                .map(
                  (l) => `
                  <button onclick="doLesson(${l.lesson_number})">
                    –£—Ä–æ–∫ ${l.lesson_number}: ${l.title}
                  </button>
                `
                )
                .join("") +
              `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
          })
          .catch(() => {
            screen.innerHTML =
              '<span class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–æ–≤</span>';
          });
      }

      /* =========================
         COMPLETE LESSON
      ========================= */

      function doLesson(lessonNumber) {
        fetch("/api/lesson", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            telegramId: tgUser.id,
            lessonNumber: lessonNumber,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.blocked) {
              tg.showPopup({
                title: "üîí –£—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç",
                message: "–≠—Ç–æ—Ç —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ",
                buttons: [{ type: "ok" }],
              });
            }
            loadUser();
          })
          .catch(() => {
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —É—Ä–æ–∫–∞");
          });
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part.charAt(0).toUpperCase())
          .join("") || "T";
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(
            teacher.avatar_url
          )}" alt="${escapeHtml(teacher.name || "Teacher")}"/>`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(
          getInitials(teacher.name)
        )}</span>`;
      }

      /* expose */
      window.loadTeachers = loadTeachers;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.doLesson = doLesson;
    </script>
  </body>
</html>

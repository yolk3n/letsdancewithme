<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Let's Dance With Me</title>

    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
        padding: 20px;
        margin: 0;
      }

      h1 {
        margin-top: 0;
      }

      .card {
        background: #1e1e1e;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      button {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }

      button:active {
        background: #e03a58;
      }

      .error {
        color: #ff8080;
      }
    </style>
  </head>

  <body>
    <h1>üíÉ Let's Dance With Me</h1>

    <div class="card" id="user">
      –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
    </div>

    <div class="card">
      <h3>–£—Ä–æ–∫–∏</h3>
      <button onclick="doLesson(1)">–£—Ä–æ–∫ 1 ‚Äî –ë–∞–∑–æ–≤—ã–π —à–∞–≥</button>
      <button onclick="doLesson(2)">–£—Ä–æ–∫ 2 ‚Äî –ü—Ä–∞–≤—ã–π –ø–æ–≤–æ—Ä–æ—Ç</button>
      <button onclick="doLesson(3)">–£—Ä–æ–∫ 3 ‚Äî –°–≤—è–∑–∫–∞</button>
      <button onclick="doLesson(4)">–£—Ä–æ–∫ 4 ‚Äî –ö–æ–º–±–∏–Ω–∞—Ü–∏—è üîí</button>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand(); // –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–ª–∏–∫–æ–≤

      const userBlock = document.getElementById("user");
      const tgUser = tg.initDataUnsafe?.user;

      if (!tgUser) {
        userBlock.innerHTML =
          '<span class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</span>';
      } else {
        loadUser();
      }

      function getLevel(xp) {
        if (xp >= 60) return "üíÉ –¢–∞–Ω—Ü–æ—Ä";
        if (xp >= 30) return "ü•ã –£—á–µ–Ω–∏–∫";
        return "üå± –ù–æ–≤–∏—á–æ–∫";
      }

      function loadUser() {
        fetch(`/api/user/${tgUser.id}`)
          .then((res) => {
            if (!res.ok) throw new Error("API error");
            return res.json();
          })
          .then((data) => {
            userBlock.innerHTML = `
              <b>${tgUser.first_name}</b><br/><br/>
              ‚≠ê XP: ${data.xp}<br/>
              üèÖ –£—Ä–æ–≤–µ–Ω—å: ${getLevel(data.xp)}<br/>
              üìö –£—Ä–æ–∫–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: ${data.lessons_completed}
            `;
          })
          .catch(() => {
            userBlock.innerHTML =
              '<span class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>';
            tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
          });
      }

      function doLesson(lessonNumber) {
        fetch("/api/lesson", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            telegramId: tgUser.id,
            lessonNumber: lessonNumber,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.blocked) {
              tg.showPopup({
                title: "üîí –£—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç",
                message: "–≠—Ç–æ—Ç —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ",
                buttons: [{ type: "ok" }],
              });
            }
            loadUser();
          })
          .catch(() => {
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —É—Ä–æ–∫–∞");
          });
      }

      // –≤–∞–∂–Ω–æ: –¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –∫–Ω–æ–ø–∫–∞–º
      window.doLesson = doLesson;
    </script>
  </body>
</html>

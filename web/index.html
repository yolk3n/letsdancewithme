<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/strings.ru.js"></script>
    <style>
      :root {
        --bg-main: #f6f2ea;
        --bg-soft: #fefcf8;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-border: rgba(38, 30, 20, 0.12);
        --text-main: #1f1b16;
        --text-muted: #6f665c;
        --accent-pink: #f24f88;
        --accent-cyan: #00a8c7;
        --accent-yellow: #f1b341;
        --danger: #c93e57;
        --radius-lg: 18px;
        --radius-md: 12px;
        --font-body: "Manrope", sans-serif;
        --font-display: "Bebas Neue", sans-serif;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        padding: 16px;
        color: var(--text-main);
        font-family: var(--font-body);
        background:
          radial-gradient(120% 80% at 0% 0%, rgba(242, 79, 136, 0.1) 0%, rgba(242, 79, 136, 0) 55%),
          linear-gradient(180deg, #fffdf9 0%, var(--bg-main) 100%);
      }
      .app-shell {
        max-width: 860px;
        margin: 0 auto;
      }
      .card {
        margin-bottom: 14px;
        padding: 16px;
        border: 1px solid var(--card-border);
        border-radius: var(--radius-lg);
        background: var(--card-bg);
        box-shadow: 0 3px 10px rgba(53, 35, 22, 0.08);
        animation: cardIn 170ms ease;
      }
      .card > b:first-child {
        display: block;
        margin-bottom: 10px;
        font-size: 26px;
        line-height: 1;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .hidden { display: none; }
      .muted { color: var(--text-muted); }
      .error { color: var(--danger); }
      button, input, select, textarea {
        width: 100%;
        margin-bottom: 8px;
        padding: 12px 13px;
        border-radius: var(--radius-md);
        font-family: var(--font-body);
        font-size: 15px;
      }
      button {
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(65, 31, 42, 0.12);
        color: #fff;
        background: #e86593;
        cursor: pointer;
        font-weight: 700;
        text-align: left;
        box-shadow: 0 2px 7px rgba(232, 101, 147, 0.2);
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }
      button:hover { transform: translateY(-1px); filter: brightness(1.02); }
      button:active { transform: translateY(0); }
      button.secondary {
        color: #2d251e;
        border-color: rgba(45, 31, 20, 0.16);
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 1px 5px rgba(76, 53, 32, 0.08);
      }
      input, select, textarea {
        border: 1px solid rgba(50, 35, 22, 0.2);
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.82);
        outline: none;
      }
      input:focus, select:focus, textarea:focus {
        border-color: rgba(0, 168, 199, 0.72);
        box-shadow: 0 0 0 3px rgba(0, 168, 199, 0.18);
      }
      .teacher-btn { display: flex; align-items: center; gap: 12px; text-align: left; }
      .teacher-avatar { width: 46px; height: 46px; border-radius: 50%; object-fit: cover; flex: 0 0 46px; border: 1px solid rgba(54, 34, 20, 0.2); }
      .teacher-avatar-fallback {
        width: 46px; height: 46px; border-radius: 50%; flex: 0 0 46px; display: flex;
        align-items: center; justify-content: center; font-size: 14px; font-weight: 800;
        color: #2a2118;
        background: linear-gradient(145deg, #ffd7e8, #cceef7);
        border: 1px solid rgba(54, 34, 20, 0.17);
      }
      .teacher-content { min-width: 0; }
      .teacher-content small { display: inline-block; margin-top: 2px; }
      .profile-top {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-start;
        cursor: pointer;
      }
      .profile-greeting { font-weight: 700; }
      #user {
        background: transparent;
        border: 0;
        box-shadow: none;
        padding: 0 0 8px;
        margin-bottom: 8px;
      }
      .profile-avatar,
      .profile-avatar-fallback {
        width: 42px;
        height: 42px;
        flex: 0 0 42px;
        border-radius: 50%;
      }
      .profile-avatar {
        object-fit: cover;
        border: 1px solid rgba(54, 34, 20, 0.2);
      }
      .profile-avatar-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 800;
        color: #2a2118;
        background: linear-gradient(145deg, #ffd7e8, #cceef7);
        border: 1px solid rgba(54, 34, 20, 0.17);
      }
      .profile-menu {
        margin-top: 10px;
        display: grid;
        gap: 6px;
      }
      .profile-menu button {
        margin: 0;
      }
      .style-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      .style-chip {
        width: auto;
        margin: 0;
        padding: 8px 11px;
        border-radius: 999px;
        border: 1px solid rgba(45, 31, 20, 0.18);
        background: rgba(255, 255, 255, 0.86);
        color: #2d251e;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
        box-shadow: none;
      }
      .style-chip.active {
        color: #1d1711;
        border-color: rgba(0, 168, 199, 0.33);
        background: rgba(0, 168, 199, 0.11);
      }
      .teacher-card {
        border: 1px solid rgba(38, 30, 20, 0.22);
        border-radius: 14px;
        padding: 10px;
        background: #ffffff;
        box-shadow: 0 6px 16px rgba(55, 38, 23, 0.12);
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease;
      }
      .catalog-bar {
        display: grid;
        gap: 8px;
        margin-bottom: 14px;
      }
      .catalog-row {
        display: flex;
        gap: 8px;
      }
      .catalog-row > * { flex: 1; }
      .course-progress {
        margin-top: 10px;
      }
      .course-progress-track {
        height: 4px;
        border-radius: 999px;
        background: rgba(38, 30, 20, 0.12);
        overflow: hidden;
      }
      .course-progress-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #3e9db4, #5bb58a);
      }
      .course-progress-label {
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }
      .course-author {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .course-author-avatar,
      .course-author-fallback {
        width: 24px;
        height: 24px;
        flex: 0 0 24px;
        border-radius: 50%;
      }
      .course-author-avatar {
        object-fit: cover;
        border: 1px solid rgba(38, 30, 20, 0.2);
      }
      .course-author-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
        color: #2d251e;
        background: #ece7df;
      }
      .teacher-card:hover { transform: translateY(-1px); filter: brightness(1.01); }
      .teacher-card:active { transform: translateY(0); }
      #studentScreen.flat-list {
        background: transparent;
        border: 0;
        box-shadow: none;
        padding: 0;
      }
      .teacher-card-head {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .teacher-name {
        margin: 0;
        font-size: 16px;
        line-height: 1.2;
      }
      .teacher-courses-count {
        margin-top: 2px;
        font-size: 12px;
        color: var(--text-muted);
      }
      .teacher-style-row {
        margin: 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .teacher-style-chip {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 12px;
        line-height: 1.25;
        color: #2d251e;
        background: var(--teacher-chip-bg, #f6efe4);
      }
      .teacher-proof {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 10px 0 8px;
      }
      .teacher-proof-label {
        font-size: 12px;
        color: var(--text-muted);
      }
      .mini-avatars {
        display: flex;
        align-items: center;
      }
      .mini-avatars img,
      .mini-avatars span {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1.5px solid #fff;
        margin-left: -6px;
        background: #fff;
      }
      .mini-avatars > :first-child { margin-left: 0; }
      .mini-avatars span {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #4f463d;
        font-weight: 700;
      }
      .stack { display: grid; gap: 8px; }
      .student-header {
        margin-bottom: 10px;
      }
      .student-header-top {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .student-header-title {
        margin: 0;
        font-size: 24px;
        line-height: 1;
        letter-spacing: 0.01em;
        font-family: var(--font-display);
        font-weight: 400;
      }
      .back-btn {
        width: auto;
        min-width: 90px;
        margin: 0;
        text-align: center;
      }
      .back-spacer {
        display: inline-block;
        width: 90px;
        flex: 0 0 90px;
      }
      .section-subtitle {
        margin: 6px 0 10px;
        color: var(--text-muted);
        font-size: 13px;
      }
      .course-card {
        border: 1px solid rgba(38, 30, 20, 0.12);
        border-radius: 12px;
        padding: 14px;
        background: rgba(255, 255, 255, 0.72);
      }
      .catalog-courses-grid {
        display: grid;
        gap: 12px;
      }
      .catalog-course-card {
        cursor: pointer;
        border-color: rgba(38, 30, 20, 0.2);
        background: linear-gradient(150deg, #fffefb 0%, #f2f6ff 100%);
        box-shadow: 0 8px 20px rgba(55, 38, 23, 0.08);
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }
      .catalog-course-card.level-beginner {
        background: linear-gradient(150deg, #fffefb 0%, #eef8ff 100%);
      }
      .catalog-course-card.level-advanced {
        background: linear-gradient(150deg, #fffdf8 0%, #fff2e6 100%);
      }
      .catalog-course-card.level-professional {
        background: linear-gradient(150deg, #fffafc 0%, #f3eefe 100%);
      }
      .catalog-course-card:hover { transform: translateY(-1px); }
      .catalog-course-card:active { transform: translateY(0); }
      .course-card-title { font-weight: 700; margin-bottom: 3px; }
      .course-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .course-level-badge {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        line-height: 1.2;
        font-weight: 700;
        border: 1px solid rgba(38, 30, 20, 0.2);
        background: rgba(255, 255, 255, 0.84);
        color: #3a2f24;
        white-space: nowrap;
      }
      .course-level-badge.beginner {
        border-color: rgba(61, 143, 171, 0.35);
        background: rgba(220, 244, 255, 0.86);
      }
      .course-level-badge.advanced {
        border-color: rgba(203, 126, 61, 0.34);
        background: rgba(255, 236, 214, 0.9);
      }
      .course-level-badge.professional {
        border-color: rgba(117, 87, 178, 0.35);
        background: rgba(235, 227, 255, 0.88);
      }
      .course-card-meta {
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .lesson-btn[disabled] {
        cursor: not-allowed;
        filter: grayscale(0.3);
        opacity: 0.66;
      }
      .row { display: flex; gap: 8px; align-items: center; }
      .row > * { flex: 1; }
      .lesson-row, .user-row {
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(38, 30, 20, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      .pill {
        display: inline-block;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 700;
        color: #fff;
        background: #6a6171;
      }
      .pill.free { background: linear-gradient(135deg, #2d9050, #2f7f95); }
      .pill.paid { background: linear-gradient(135deg, #8e3a55, #a35333); }
      .role-switch-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      .mode-label { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      .switch { position: relative; display: inline-block; width: 46px; height: 26px; flex: 0 0 46px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d7d0c7;
        transition: 0.2s; border-radius: 999px;
      }
      .slider:before {
        position: absolute; content: ""; height: 20px; width: 20px; left: 3px; top: 3px; background: #fff;
        transition: 0.2s; border-radius: 50%;
        box-shadow: 0 1px 3px rgba(42, 31, 20, 0.22);
      }
      .switch input:checked + .slider { background-color: #f24f88; }
      .switch input:checked + .slider:before { transform: translateX(20px); }
      hr {
        border: 0;
        height: 1px;
        margin: 14px 0;
        background: rgba(43, 30, 17, 0.12);
      }
      a { color: #007ea1; }
      @keyframes cardIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @media (min-width: 860px) {
        .catalog-courses-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (max-width: 700px) {
        body { padding: 12px; }
        .card { padding: 14px; border-radius: 14px; }
        button, input, select, textarea { font-size: 16px; }
      }
    </style>
  </head>
  <body>
    <main class="app-shell">
    <div class="card" id="user"></div>

    <div class="card hidden" id="onboardingCard">
      <b id="onboardingTitle"></b>
      <p class="muted" id="onboardingText"></p>
      <button id="onboardingBtn"></button>
    </div>

    <div class="card hidden" id="studentScreen"></div>
    <div class="card hidden" id="profileScreen"></div>
    <div class="card hidden" id="teacherScreen"></div>
    <div class="card hidden" id="adminScreen"></div>
    </main>

    <script>
      const S = window.STRINGS_RU;
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;

      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingTitle = document.getElementById("onboardingTitle");
      const onboardingText = document.getElementById("onboardingText");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const profileScreen = document.getElementById("profileScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const adminScreen = document.getElementById("adminScreen");

      let currentUser = null;
      let selectedStyleId = "";
      let selectedTeacherFilterId = "";
      let courseSearchQuery = "";
      let studentCatalogMode = "all";
      let currentStyles = [];
      let currentStudentTeachers = [];
      let selectedTeacherId = null;
      let currentStudentCourses = [];
      let openedStudentCourseId = null;
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let currentAdminUsers = [];
      let editingLessonId = null;
      let selectedAppScreen = "student";

      renderStaticTexts();

      if (!tgUser) {
        userBlock.innerHTML = `<span class="error">${S.noTelegramData}</span>`;
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderStaticTexts() {
        onboardingTitle.textContent = S.onboardingTitle;
        onboardingText.textContent = S.onboardingText;
        onboardingBtn.textContent = S.onboardingStart;
        userBlock.textContent = S.loadingUser;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function getLevel(xp) {
        if (xp >= 60) return S.levelDancer;
        if (xp >= 30) return S.levelStudent;
        return S.levelBeginner;
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      function renderCourseAuthorAvatar(course) {
        if (course.teacher_avatar_url) {
          return `<img class="course-author-avatar" src="${escapeHtml(course.teacher_avatar_url)}" alt="${escapeHtml(
            course.teacher_name || "Teacher"
          )}" />`;
        }
        return `<span class="course-author-fallback">${escapeHtml(getInitials(course.teacher_name || "T"))}</span>`;
      }

      function pluralizeRu(count, forms) {
        const value = Math.abs(Number(count) || 0);
        const mod10 = value % 10;
        const mod100 = value % 100;
        if (mod10 === 1 && mod100 !== 11) return forms[0];
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return forms[1];
        return forms[2];
      }

      function courseCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["курс", "курса", "курсов"])}`;
      }

      function studentCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["ученик", "ученика", "учеников"])}`;
      }

      function getCourseLevelLabel(level) {
        if (level === "advanced") return "Продвинутый";
        if (level === "professional") return "Профессионал";
        return "Новичок";
      }

      function getCourseLevelClass(level) {
        if (level === "advanced") return "advanced";
        if (level === "professional") return "professional";
        return "beginner";
      }

      function getTeacherAccent(teacherId) {
        const palette = [
          { chipBg: "#fde8ee" },
          { chipBg: "#e3f5fb" },
          { chipBg: "#faefde" },
          { chipBg: "#edf5e7" },
          { chipBg: "#f0eafa" },
          { chipBg: "#fbe9ef" },
        ];
        const index = Math.abs(Number(teacherId) || 0) % palette.length;
        return palette[index];
      }

      function renderStyleFilterChips(styles) {
        return `
          <div class="style-chips">
            <button class="style-chip ${selectedStyleId ? "" : "active"}" onclick="setStyleFilter('')">${S.allStyles}</button>
            ${styles
              .map(
                (style) =>
                  `<button class="style-chip ${String(style.id) === String(selectedStyleId) ? "active" : ""}" onclick="setStyleFilter('${style.id}')">${escapeHtml(style.name)}</button>`
              )
              .join("")}
          </div>
        `;
      }

      function renderStudentProof(teacher) {
        const avatars = Array.isArray(teacher.student_avatars_preview)
          ? teacher.student_avatars_preview.filter(Boolean).slice(0, 3)
          : [];
        const studentsCount = Number(teacher.students_count || 0);
        if (!studentsCount) return "";
        return `
          <div class="teacher-proof">
            <small class="teacher-proof-label">${studentCountLabel(studentsCount)}</small>
            <div class="mini-avatars">
              ${avatars.map((url) => `<img src="${escapeHtml(url)}" alt="student" />`).join("")}
              ${studentsCount > avatars.length ? `<span>+${studentsCount - avatars.length}</span>` : ""}
            </div>
          </div>
        `;
      }

      function setStyleFilter(styleId) {
        selectedStyleId = styleId ? String(styleId) : "";
        selectedTeacherFilterId = "";
        courseSearchQuery = "";
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderTeacherCard(teacher) {
        const accent = getTeacherAccent(teacher.id);
        const styles = Array.isArray(teacher.styles) ? teacher.styles : [];
        const visibleStyles = styles.slice(0, 2);
        const overflowCount = Math.max(styles.length - visibleStyles.length, 0);
        return `
          <div class="teacher-card" onclick="loadCourses(${teacher.id})" style="--teacher-chip-bg:${accent.chipBg};">
            <div class="teacher-card-head">
              ${renderTeacherAvatar(teacher)}
              <div class="teacher-content">
                <h3 class="teacher-name">${escapeHtml(teacher.name || "Преподаватель")}</h3>
                <div class="teacher-courses-count">${courseCountLabel(Number(teacher.published_courses_count || 0))}</div>
              </div>
            </div>
            <div class="teacher-style-row">
              ${
                visibleStyles.length
                  ? visibleStyles.map((style) => `<span class="teacher-style-chip">${escapeHtml(style.name)}</span>`).join("")
                  : `<span class="teacher-style-chip">Направление не указано</span>`
              }
              ${overflowCount ? `<span class="teacher-style-chip">+${overflowCount}</span>` : ""}
            </div>
            ${renderStudentProof(teacher)}
          </div>
        `;
      }

      function formatRub(value) {
        return `${Number(value || 0)} ₽`;
      }

      function renderStudentHeader(title, subtitle = "", backAction = "") {
        const backPart = backAction
          ? `<button class="secondary back-btn" onclick="${backAction}">← Назад</button>`
          : `<span class="back-spacer"></span>`;
        return `
          <div class="student-header">
            <div class="student-header-top">
              ${backPart}
              <h2 class="student-header-title">${escapeHtml(title)}</h2>
            </div>
            ${subtitle ? `<p class="section-subtitle">${escapeHtml(subtitle)}</p>` : ""}
          </div>
        `;
      }

      async function bootstrap() {
        bindEvents();
        await syncProfileFromTelegram();
        await loadCurrentUser();
        await routeByRole();
      }

      async function syncProfileFromTelegram() {
        await apiFetch("/api/profile/sync", {
          method: "POST",
          body: JSON.stringify({
            first_name: tgUser.first_name,
            last_name: tgUser.last_name,
            username: tgUser.username,
            avatar_url: tgUser.photo_url,
          }),
        });
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        const avatarUrl = currentUser.avatar_url || tgUser.photo_url || "";
        const helloName = currentUser.username || currentUser.first_name || tgUser.first_name || S.userDefaultName;

        userBlock.innerHTML = `
          <div class="profile-top" onclick="openProfileMenu()">
            ${
              avatarUrl
                ? `<img class="profile-avatar" src="${escapeHtml(avatarUrl)}" alt="profile avatar" />`
                : `<span class="profile-avatar-fallback">${escapeHtml(getInitials(currentUser.first_name || tgUser.first_name || "U"))}</span>`
            }
            <div class="profile-greeting">Привет, ${escapeHtml(helloName)}!</div>
          </div>
        `;
      }

      function openProfileMenu() {
        selectedAppScreen = "profile";
        routeByRole().catch((error) => {
          profileScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openStudentScreen() {
        selectedAppScreen = "student";
        routeByRole().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openTeacherCabinet() {
        selectedAppScreen = "teacher";
        routeByRole().catch((error) => {
          teacherScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openAdminPanel() {
        selectedAppScreen = "admin";
        routeByRole().catch((error) => {
          adminScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openSupport() {
        tg.showAlert("Напиши в поддержку: @letsdancewithme_support");
      }

      function openMySubscriptions() {
        studentCatalogMode = "subscriptions";
        openStudentScreen();
      }

      function openAllCourses() {
        studentCatalogMode = "all";
        openStudentScreen();
      }

      async function renderProfileScreen() {
        profileScreen.innerHTML = `
          ${renderStudentHeader("Профиль", "", "openStudentScreen()")}
          <div class="profile-menu">
            <button onclick="openMySubscriptions()">Мои подписки</button>
            ${currentUser.role === "teacher" || currentUser.role === "admin" ? `<button onclick="openTeacherCabinet()">Мои курсы</button>` : ""}
            ${currentUser.role === "admin" ? `<button onclick="openAdminPanel()">Администрирование</button>` : ""}
            <button class="secondary" onclick="openSupport()">Поддержка</button>
            <button class="secondary" onclick="openAllCourses()">Все курсы</button>
          </div>
        `;
      }

      async function completeOnboarding() {
        await apiFetch("/api/onboarding/complete", { method: "POST" });
        await loadCurrentUser();
        await routeByRole();
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        profileScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");
        adminScreen.classList.add("hidden");

        if (selectedAppScreen === "profile") {
          profileScreen.classList.remove("hidden");
          await renderProfileScreen();
          return;
        }

        const canUseTeacher = currentUser.role === "teacher" || currentUser.role === "admin";
        const canUseAdmin = currentUser.role === "admin";
        const showTeacherScreen = selectedAppScreen === "teacher" && canUseTeacher;
        const showAdminScreen = selectedAppScreen === "admin" && canUseAdmin;

        if (!currentUser.is_onboarded && !(showTeacherScreen || showAdminScreen)) {
          onboardingCard.classList.remove("hidden");
        }

        if (showAdminScreen) {
          adminScreen.classList.remove("hidden");
          await renderAdminScreen();
          return;
        }

        if (showTeacherScreen) {
          teacherScreen.classList.remove("hidden");
          await renderTeacherScreen();
          return;
        }

        studentScreen.classList.remove("hidden");
        await renderStudentScreen();
      }

      async function renderStudentScreen() {
        studentScreen.classList.add("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = null;
        const [teachers, styles] = await Promise.all([apiFetch("/api/teachers"), apiFetch("/api/styles")]);
        currentStudentTeachers = teachers;
        currentStyles = styles;
        const styleQuery = selectedStyleId ? `&styleId=${selectedStyleId}` : "";
        const teacherQuery = selectedTeacherFilterId ? `&teacherId=${selectedTeacherFilterId}` : "";
        const purchasedQuery = studentCatalogMode === "subscriptions" ? "&purchased=1" : "";
        const searchQuery = courseSearchQuery ? `&search=${encodeURIComponent(courseSearchQuery)}` : "";
        const courses = await apiFetch(`/api/student/courses?1=1${styleQuery}${teacherQuery}${purchasedQuery}${searchQuery}`);
        currentStudentCourses = courses;
        const hasActiveCourse = courses.some(
          (course) => course.is_purchased && Number(course.total_lessons || 0) > 0 && Number(course.completed_lessons || 0) < Number(course.total_lessons || 0)
        );
        const heroTitle = hasActiveCourse ? "Готов продолжить обучение?" : "Курсы для старта";

        studentScreen.innerHTML = `
          ${renderStudentHeader(heroTitle)}
          <div class="catalog-bar">
            <div class="catalog-row">
              <input
                id="courseSearchInput"
                value="${escapeHtml(courseSearchQuery)}"
                placeholder="Поиск по курсам и преподавателям"
              />
            </div>
            <div class="catalog-row">
              <select id="teacherFilter">
                <option value="">Все преподаватели</option>
                ${teachers.map((teacher) => `<option value="${teacher.id}" ${String(teacher.id) === String(selectedTeacherFilterId) ? "selected" : ""}>${escapeHtml(teacher.name || "Преподаватель")}</option>`).join("")}
              </select>
            </div>
          </div>
          ${renderStyleFilterChips(styles)}
          <div class="catalog-courses-grid">
          ${
            courses.length
              ? courses
                  .map(
                    (course) => {
                      const levelClass = getCourseLevelClass(course.level);
                      const levelLabel = getCourseLevelLabel(course.level);
                      return `
                <div class="course-card catalog-course-card level-${levelClass}" onclick="openCourse(${course.id})">
                  <div class="course-author">
                    ${renderCourseAuthorAvatar(course)}
                    <small class="muted">${escapeHtml(course.teacher_name || "Преподаватель")}</small>
                  </div>
                  <div class="course-head">
                    <div class="course-card-title">${escapeHtml(course.title)}</div>
                    <span class="course-level-badge ${levelClass}">${levelLabel}</span>
                  </div>
                  <div class="course-progress">
                    <div class="course-progress-track">
                      <div class="course-progress-fill" style="width:${Math.max(0, Math.min(100, Number(course.progress_percent || 0)))}%"></div>
                    </div>
                    <div class="course-progress-label">${Number(course.progress_percent || 0)}%</div>
                  </div>
                </div>
              `;
                    }
                  )
                  .join("")
              : `<small class="muted">Курсы не найдены.</small>`
          }
          </div>
        `;

        const searchInput = document.getElementById("courseSearchInput");
        searchInput.addEventListener("change", () => {
          courseSearchQuery = searchInput.value.trim();
          renderStudentScreen();
        });

        const teacherFilter = document.getElementById("teacherFilter");
        teacherFilter.addEventListener("change", () => {
          selectedTeacherFilterId = teacherFilter.value;
          renderStudentScreen();
        });
      }

      async function loadCourses(teacherId) {
        studentScreen.classList.remove("flat-list");
        selectedTeacherId = teacherId;
        openedStudentCourseId = null;
        const selectedTeacher = currentStudentTeachers.find((teacher) => Number(teacher.id) === Number(teacherId));
        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, S.loadingCourses, "renderStudentScreen()")}
        `;
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);
        currentStudentCourses = courses;
        const coursesSubtitle = selectedTeacher
          ? `Преподаватель: ${selectedTeacher.name}${
              selectedStyleId
                ? ` • ${currentStyles.find((item) => String(item.id) === String(selectedStyleId))?.name || ""}`
                : ""
            }`
          : "Выбери курс для старта.";

        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, coursesSubtitle, "renderStudentScreen()")}
          <div class="stack">
            ${
              courses.length
                ? courses
                    .map(
                      (course) => `
                  <div class="course-card">
                    <div class="course-card-title">${escapeHtml(course.title)}</div>
                    <small class="muted">${escapeHtml(course.description || "")}</small>
                    <div class="course-card-meta">
                      <small class="muted">${S.priceLabel}: ${formatRub(course.price)}</small>
                      <small class="pill ${course.is_purchased ? "free" : "paid"}">${course.is_purchased ? S.purchased : S.notPurchased}</small>
                    </div>
                    <button onclick="openCourse(${course.id})">Открыть уроки</button>
                  </div>
                `
                    )
                    .join("")
                : `<small class="muted">По выбранным фильтрам курсы не найдены.</small>`
            }
          </div>
        `;
      }

      async function openCourse(courseId) {
        studentScreen.classList.remove("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = courseId;
        studentScreen.innerHTML = `
          ${renderStudentHeader(S.lessonsTitle, S.loadingLessons, "renderStudentScreen()")}
        `;
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        const course = currentStudentCourses.find((item) => item.id === courseId);
        const hasPaidLessons = lessons.some((lesson) => !lesson.is_free);
        const showBuyButton = hasPaidLessons && course && !course.is_purchased;

        studentScreen.innerHTML = `
          ${renderStudentHeader(S.lessonsTitle, course ? course.title : "Выбранный курс", "renderStudentScreen()")}
          <div class="stack">
            ${showBuyButton ? `<button onclick="purchaseCourse(${courseId})">${S.buyCourse} ${formatRub(course.price)}</button>` : ""}
            ${
              lessons.length
                ? lessons
                    .map((lesson) => {
                      const typeClass = lesson.is_free ? "free" : "paid";
                      const typeText = lesson.is_free ? S.free : S.paid;
                      const durationText = lesson.duration_sec
                        ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}`
                        : S.noDuration;
                      const unlockText = lesson.is_unlocked ? S.unlocked : S.locked;
                      const previewHtml = lesson.preview_url
                        ? `<br/><small><a href="${escapeHtml(
                            lesson.preview_url
                          )}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small>`
                        : "";
                      const disabledAttr = lesson.is_unlocked ? "" : "disabled";
                      const action = lesson.is_unlocked ? `onclick="doLesson(${courseId}, ${lesson.lesson_number})"` : "";
                      return `
                <button class="lesson-btn ${lesson.is_unlocked ? "" : "secondary"}" ${action} ${disabledAttr}>
                  ${S.lessonsTitle.slice(0, -1)} ${lesson.lesson_number}: ${escapeHtml(lesson.title)}<br/>
                  <small class="pill ${typeClass}">${typeText}</small>
                  <small class="muted"> • ${durationText}</small>
                  <small class="muted"> • ${unlockText}</small>
                  ${previewHtml}
                </button>
              `;
                    })
                    .join("")
                : `<small class="muted">В этом курсе пока нет уроков.</small>`
            }
          </div>
        `;
      }

      async function purchaseCourse(courseId) {
        await apiFetch(`/api/courses/${courseId}/purchase`, { method: "POST" });
        const selectedCourse = currentStudentCourses.find((item) => item.id === courseId);
        if (selectedCourse) selectedCourse.is_purchased = true;
        tg.showAlert(S.coursePurchaseSuccess);
        await openCourse(courseId);
      }

      async function doLesson(courseId, lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({ telegramId: tgUser.id, courseId, lessonNumber }),
        });

        if (data.blocked) {
          const message =
            data.reason === "course_purchase_required" ? S.lessonLockedNeedPurchase : S.lessonLockedGeneric;
          tg.showPopup({ title: S.lessonLockedTitle, message, buttons: [{ type: "ok" }] });
          return;
        }

        await loadCurrentUser();
        if (openedStudentCourseId) await openCourse(openedStudentCourseId);
      }

      async function renderTeacherScreen() {
        teacherScreen.innerHTML = `
          <b>${S.teacherCabinet}</b>
          <p class="muted">${S.profileTitle}</p>
          <input id="teacherName" placeholder="${S.teacherNamePh}" />
          <input id="teacherDescription" placeholder="${S.teacherDescriptionPh}" />
          <input id="teacherAvatarUrl" placeholder="${S.teacherAvatarPh}" />
          <button id="saveTeacherProfileBtn">${S.saveProfile}</button>
          <hr />
          <p class="muted">${S.newCourseTitle}</p>
          <input id="courseTitle" placeholder="${S.courseNamePh}" />
          <input id="courseDescription" placeholder="${S.courseDescriptionPh}" />
          <div class="row">
            <input id="coursePrice" type="number" placeholder="${S.coursePricePh}" min="199" />
            <select id="courseLevel">
              <option value="beginner">Новичок</option>
              <option value="advanced">Продвинутый</option>
              <option value="professional">Профессионал</option>
            </select>
          </div>
          <div class="row">
            <select id="coursePublished">
              <option value="true">${S.published}</option>
              <option value="false">${S.hidden}</option>
            </select>
          </div>
          <button id="createCourseBtn">${S.createCourse}</button>
          <hr />
          <p class="muted">${S.teacherLessonsTitle}</p>
          <select id="teacherCourseSelect"></select>
          <div class="row">
            <input id="lessonNumber" type="number" min="1" placeholder="${S.lessonNumberPh}" />
            <input id="lessonDuration" type="number" min="1" placeholder="${S.lessonDurationPh}" />
          </div>
          <input id="lessonTitle" placeholder="${S.lessonNamePh}" />
          <input id="lessonPreviewUrl" placeholder="${S.lessonPreviewPh}" />
          <textarea id="lessonDescription" placeholder="${S.lessonDescriptionPh}"></textarea>
          <select id="lessonIsFree">
            <option value="true">${S.lessonFree}</option>
            <option value="false">${S.lessonPaid}</option>
          </select>
          <button id="saveLessonBtn">${S.saveLesson}</button>
          <div id="teacherCourses" class="muted">${S.loading}</div>
          <div id="teacherLessons" class="muted">${S.chooseCourse}</div>
        `;

        const teacherNameInput = document.getElementById("teacherName");
        const teacherDescriptionInput = document.getElementById("teacherDescription");
        const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
        const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");
        const courseTitleInput = document.getElementById("courseTitle");
        const courseDescriptionInput = document.getElementById("courseDescription");
        const coursePriceInput = document.getElementById("coursePrice");
        const courseLevelInput = document.getElementById("courseLevel");
        const coursePublishedInput = document.getElementById("coursePublished");
        const createCourseBtn = document.getElementById("createCourseBtn");
        const teacherCourseSelect = document.getElementById("teacherCourseSelect");
        const lessonNumberInput = document.getElementById("lessonNumber");
        const lessonDurationInput = document.getElementById("lessonDuration");
        const lessonTitleInput = document.getElementById("lessonTitle");
        const lessonPreviewInput = document.getElementById("lessonPreviewUrl");
        const lessonDescriptionInput = document.getElementById("lessonDescription");
        const lessonIsFreeInput = document.getElementById("lessonIsFree");
        const saveLessonBtn = document.getElementById("saveLessonBtn");
        const teacherCoursesBlock = document.getElementById("teacherCourses");
        const teacherLessonsBlock = document.getElementById("teacherLessons");

        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";

        saveTeacherProfileBtn.addEventListener("click", async () => {
          await apiFetch("/api/teacher/profile", {
            method: "PUT",
            body: JSON.stringify({
              name: teacherNameInput.value.trim(),
              description: teacherDescriptionInput.value.trim(),
              avatarUrl: teacherAvatarInput.value.trim(),
            }),
          });
          tg.showAlert(S.profileSaved);
        });

        async function loadTeacherCoursesData() {
          currentTeacherCourses = await apiFetch("/api/teacher/courses");
          teacherCoursesBlock.innerHTML =
            `<b>${S.yourCourses}</b><br/><br/>` +
            (currentTeacherCourses.length
              ? currentTeacherCourses
                  .map(
                    (course) =>
                      `• ${escapeHtml(course.title)} — ${getCourseLevelLabel(course.level)} — ${Number(course.price || 0)} ₽ (${
                        course.is_published ? S.published.toLowerCase() : S.hidden.toLowerCase()
                      })`
                  )
                  .join("<br/>")
              : S.noCoursesYet);

          teacherCourseSelect.innerHTML = currentTeacherCourses.length
            ? currentTeacherCourses.map((course) => `<option value="${course.id}">${escapeHtml(course.title)}</option>`).join("")
            : `<option value="">${S.noCourses}</option>`;
        }

        async function loadTeacherLessonsData() {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) {
            teacherLessonsBlock.textContent = S.chooseCourse;
            return;
          }

          const lessons = await apiFetch(`/api/teacher/courses/${courseId}/lessons`);
          currentTeacherLessons = lessons;
          teacherLessonsBlock.innerHTML =
            `<b>${S.selectedCourseLessons}</b><br/><br/>` +
            (lessons.length
              ? lessons
                  .map(
                    (lesson) => `
                      <div class="lesson-row">
                        <b>${lesson.lesson_number}. ${escapeHtml(lesson.title)}</b><br/>
                        <small class="muted">${escapeHtml(lesson.description || "")}</small><br/>
                        <small class="muted">${lesson.is_free ? S.free : S.paid} • ${
                          lesson.duration_sec ? `${lesson.duration_sec} ${S.seconds}` : S.noDuration
                        }</small><br/>
                        ${
                          lesson.preview_url
                            ? `<small><a href="${escapeHtml(lesson.preview_url)}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small><br/>`
                            : ""
                        }
                        <button class="secondary" onclick="editLessonById(${lesson.id})">${S.editLesson}</button>
                      </div>
                    `
                  )
                  .join("")
              : S.noLessonsYet);
        }

        createCourseBtn.addEventListener("click", async () => {
          const title = courseTitleInput.value.trim();
          const price = Number(coursePriceInput.value || 0);
          if (!title) return tg.showAlert(S.needCourseName);
          if (!Number.isFinite(price) || price < 199) return tg.showAlert(S.minCoursePriceError);

          await apiFetch("/api/teacher/courses", {
            method: "POST",
            body: JSON.stringify({
              title,
              description: courseDescriptionInput.value.trim(),
              price,
              level: courseLevelInput.value,
              isPublished: coursePublishedInput.value === "true",
              styleIds: [],
            }),
          });
          courseTitleInput.value = "";
          courseDescriptionInput.value = "";
          coursePriceInput.value = "";
          courseLevelInput.value = "beginner";
          await loadTeacherCoursesData();
          await loadTeacherLessonsData();
          tg.showAlert(S.courseCreated);
        });

        teacherCourseSelect.addEventListener("change", loadTeacherLessonsData);

        function resetLessonForm() {
          editingLessonId = null;
          lessonNumberInput.value = "";
          lessonDurationInput.value = "";
          lessonTitleInput.value = "";
          lessonPreviewInput.value = "";
          lessonDescriptionInput.value = "";
          lessonIsFreeInput.value = "true";
          saveLessonBtn.textContent = S.saveLesson;
        }

        window.editLessonById = function editLessonById(lessonId) {
          const lesson = currentTeacherLessons.find((item) => item.id === lessonId);
          if (!lesson) return;
          editingLessonId = lesson.id;
          lessonNumberInput.value = lesson.lesson_number;
          lessonDurationInput.value = lesson.duration_sec || "";
          lessonTitleInput.value = lesson.title || "";
          lessonPreviewInput.value = lesson.preview_url || "";
          lessonDescriptionInput.value = lesson.description || "";
          lessonIsFreeInput.value = lesson.is_free ? "true" : "false";
          saveLessonBtn.textContent = S.updateLesson;
        };

        saveLessonBtn.addEventListener("click", async () => {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) return tg.showAlert(S.chooseCourseError);

          const payload = {
            lessonNumber: Number(lessonNumberInput.value),
            title: lessonTitleInput.value.trim(),
            description: lessonDescriptionInput.value.trim(),
            isFree: lessonIsFreeInput.value === "true",
            durationSec: lessonDurationInput.value ? Number(lessonDurationInput.value) : null,
            previewUrl: lessonPreviewInput.value.trim() || null,
          };

          if (!payload.lessonNumber || !payload.title) return tg.showAlert(S.fillLessonError);

          if (editingLessonId) {
            await apiFetch(`/api/teacher/lessons/${editingLessonId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch(`/api/teacher/courses/${courseId}/lessons`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }

          resetLessonForm();
          await loadTeacherLessonsData();
          tg.showAlert(S.lessonSaved);
        });

        await loadTeacherCoursesData();
        await loadTeacherLessonsData();
      }

      async function renderAdminScreen() {
        adminScreen.innerHTML = `
          <b>${S.adminPanelTitle}</b>
          <p class="muted">${S.adminPanelText}</p>
          <button class="secondary" id="refreshAdminUsersBtn">${S.refreshUsers}</button>
          <div id="adminUsersList" class="muted">${S.loadingUsers}</div>
        `;

        const refreshAdminUsersBtn = document.getElementById("refreshAdminUsersBtn");
        const adminUsersList = document.getElementById("adminUsersList");

        async function loadAdminUsers() {
          currentAdminUsers = await apiFetch("/api/admin/users");
          adminUsersList.innerHTML = currentAdminUsers.length
            ? currentAdminUsers
                .map(
                  (user) => `
                    <div class="user-row">
                      ${
                        user.avatar_url
                          ? `<img class="teacher-avatar" src="${escapeHtml(user.avatar_url)}" alt="avatar" />`
                          : `<span class="teacher-avatar-fallback">${escapeHtml(
                              getInitials(user.first_name || user.username || String(user.telegram_id))
                            )}</span>`
                      }
                      <b>${escapeHtml(
                        [user.first_name, user.last_name].filter(Boolean).join(" ") || "Без имени"
                      )}</b><br/>
                      ${
                        user.username
                          ? `<small class="muted">@${escapeHtml(user.username)}</small><br/>`
                          : ""
                      }
                      <b>${S.userIdLabel}:</b> ${user.telegram_id}<br/>
                      <small class="muted">${S.userRoleLabel}: ${escapeHtml(user.role)} | XP: ${user.xp} | ${S.userLessonsLabel}: ${user.lessons_completed}</small>
                      <div class="role-switch-row">
                        <small>${S.teacherRoleSwitch}${user.telegram_id === currentUser.telegram_id ? " (недоступно для себя)" : ""}</small>
                        <label class="switch">
                          <input
                            type="checkbox"
                            ${user.role === "teacher" ? "checked" : ""}
                            ${user.telegram_id === currentUser.telegram_id ? "disabled" : ""}
                            onchange="setTeacherRoleSwitch(${user.telegram_id}, this.checked)"
                          />
                          <span class="slider"></span>
                        </label>
                      </div>
                    </div>
                  `
                )
                .join("")
            : S.usersEmpty;
        }

        window.setTeacherRoleSwitch = async function setTeacherRoleSwitch(telegramId, checked) {
          if (Number(telegramId) === Number(currentUser.telegram_id)) {
            tg.showAlert("Нельзя изменить свою роль из админ-панели");
            return;
          }
          const role = checked ? "teacher" : "student";
          await apiFetch(`/api/admin/users/${telegramId}/role`, {
            method: "PUT",
            body: JSON.stringify({ role }),
          });
          tg.showAlert(S.roleUpdated);
          await loadAdminUsers();
        };

        refreshAdminUsersBtn.addEventListener("click", loadAdminUsers);
        await loadAdminUsers();
      }

      window.renderStudentScreen = renderStudentScreen;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.purchaseCourse = purchaseCourse;
      window.doLesson = doLesson;
      window.setStyleFilter = setStyleFilter;
      window.openProfileMenu = openProfileMenu;
      window.openStudentScreen = openStudentScreen;
      window.openMySubscriptions = openMySubscriptions;
      window.openAllCourses = openAllCourses;
      window.openTeacherCabinet = openTeacherCabinet;
      window.openAdminPanel = openAdminPanel;
      window.openSupport = openSupport;
    </script>
  </body>
</html>


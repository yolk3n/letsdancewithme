<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
      }
      h1 {
        margin-top: 0;
      }
      .card {
        background: #1e1e1e;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      .hidden {
        display: none;
      }
      .muted {
        color: #bbb;
      }
      .error {
        color: #ff8080;
      }
      button,
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 15px;
        border-radius: 8px;
        border: none;
        box-sizing: border-box;
      }
      button {
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }
      button.secondary {
        background: #333;
      }
      input,
      select,
      textarea {
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #3a3a3a;
      }
      .teacher-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }
      .teacher-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex: 0 0 44px;
      }
      .teacher-avatar-fallback {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        flex: 0 0 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        background: #2b2b2b;
        color: #fff;
      }
      .teacher-content {
        min-width: 0;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row > * {
        flex: 1;
      }
      .lesson-row {
        border: 1px solid #333;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .pill {
        display: inline-block;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #333;
      }
      .pill.free {
        background: #245b2e;
      }
      .pill.paid {
        background: #5b2d24;
      }
      a {
        color: #ff9ab0;
      }
    </style>
  </head>
  <body>
    <h1>üíÉ Let's Dance With Me</h1>

    <div class="card" id="user">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>

    <div class="card hidden" id="onboardingCard">
      <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>
      <p class="muted">–í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏ –æ–±—É—á–µ–Ω–∏–µ.</p>
      <button id="onboardingBtn">–ù–∞—á–∞—Ç—å</button>
    </div>

    <div class="card hidden" id="studentScreen">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="card hidden" id="teacherScreen">
      <b>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b>

      <p class="muted">–ü—Ä–æ—Ñ–∏–ª—å</p>
      <input id="teacherName" placeholder="–ò–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è" />
      <input id="teacherDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
      <input id="teacherAvatarUrl" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" />
      <button id="saveTeacherProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

      <hr />

      <p class="muted">–ù–æ–≤—ã–π –∫—É—Ä—Å</p>
      <input id="courseTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞" />
      <input id="courseDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞" />
      <div class="row">
        <input id="coursePrice" type="number" placeholder="–¶–µ–Ω–∞" min="0" />
        <select id="coursePublished">
          <option value="true">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</option>
          <option value="false">–°–∫—Ä—ã—Ç</option>
        </select>
      </div>
      <button id="createCourseBtn">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</button>

      <hr />

      <p class="muted">–£—Ä–æ–∫–∏ –∫—É—Ä—Å–∞</p>
      <select id="teacherCourseSelect"></select>
      <div class="row">
        <input id="lessonNumber" type="number" min="1" placeholder="‚Ññ —É—Ä–æ–∫–∞" />
        <input id="lessonDuration" type="number" min="1" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)" />
      </div>
      <input id="lessonTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞" />
      <input id="lessonPreviewUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–≤—å—é" />
      <textarea id="lessonDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞"></textarea>
      <select id="lessonIsFree">
        <option value="true">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫</option>
        <option value="false">–ü–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫</option>
      </select>
      <button id="saveLessonBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ä–æ–∫</button>

      <div id="teacherCourses" class="muted">–ö—É—Ä—Å—ã: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="teacherLessons" class="muted">–£—Ä–æ–∫–∏: –≤—ã–±–µ—Ä–∏ –∫—É—Ä—Å</div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;
      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const teacherCourses = document.getElementById("teacherCourses");
      const teacherLessons = document.getElementById("teacherLessons");

      const teacherNameInput = document.getElementById("teacherName");
      const teacherDescriptionInput = document.getElementById("teacherDescription");
      const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
      const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");

      const courseTitleInput = document.getElementById("courseTitle");
      const courseDescriptionInput = document.getElementById("courseDescription");
      const coursePriceInput = document.getElementById("coursePrice");
      const coursePublishedInput = document.getElementById("coursePublished");
      const createCourseBtn = document.getElementById("createCourseBtn");

      const teacherCourseSelect = document.getElementById("teacherCourseSelect");
      const lessonNumberInput = document.getElementById("lessonNumber");
      const lessonDurationInput = document.getElementById("lessonDuration");
      const lessonTitleInput = document.getElementById("lessonTitle");
      const lessonPreviewInput = document.getElementById("lessonPreviewUrl");
      const lessonDescriptionInput = document.getElementById("lessonDescription");
      const lessonIsFreeInput = document.getElementById("lessonIsFree");
      const saveLessonBtn = document.getElementById("saveLessonBtn");

      let currentUser = null;
      let selectedStyleId = "";
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let editingLessonId = null;

      if (!tgUser) {
        userBlock.innerHTML = '<span class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</span>';
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏")}</span>`;
        });
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function getLevel(xp) {
        if (xp >= 60) return "üíÉ –¢–∞–Ω—Ü–æ—Ä";
        if (xp >= 30) return "ü•ã –£—á–µ–Ω–∏–∫";
        return "üå± –ù–æ–≤–∏—á–æ–∫";
      }

      async function bootstrap() {
        bindEvents();
        await loadCurrentUser();
        await routeByRole();
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
        saveTeacherProfileBtn.addEventListener("click", saveTeacherProfile);
        createCourseBtn.addEventListener("click", createCourse);
        teacherCourseSelect.addEventListener("change", loadSelectedTeacherCourseLessons);
        saveLessonBtn.addEventListener("click", saveLesson);
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        userBlock.innerHTML = `
          <b>${escapeHtml(tgUser.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")}</b><br/>
          –†–æ–ª—å: ${escapeHtml(currentUser.role)}<br/>
          ‚≠ê XP: ${currentUser.xp}<br/>
          üéñ –£—Ä–æ–≤–µ–Ω—å: ${getLevel(currentUser.xp)}<br/>
          üìö –ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤: ${currentUser.lessons_completed}
        `;
      }

      async function completeOnboarding() {
        await apiFetch("/api/onboarding/complete", { method: "POST" });
        await loadCurrentUser();
        await routeByRole();
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");

        if (!currentUser.is_onboarded) onboardingCard.classList.remove("hidden");

        if (currentUser.role === "teacher" || currentUser.role === "admin") {
          teacherScreen.classList.remove("hidden");
          await loadTeacherProfile();
          await loadTeacherCourses();
          return;
        }

        studentScreen.classList.remove("hidden");
        await loadTeachers();
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0].toUpperCase())
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      async function loadTeachers() {
        const [teachers, styles] = await Promise.all([apiFetch("/api/teachers"), apiFetch("/api/styles")]);
        studentScreen.innerHTML = `
          <b>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b><br/><br/>
          <select id="styleFilter">
            <option value="">–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
            ${styles.map((s) => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("")}
          </select>
          ${teachers
            .map(
              (t) => `
                <button class="teacher-btn" onclick="loadCourses(${t.id})">
                  ${renderTeacherAvatar(t)}
                  <span class="teacher-content">
                    ${escapeHtml(t.name)}<br/>
                    <small class="muted">${escapeHtml(t.description || "")}</small>
                  </span>
                </button>
              `
            )
            .join("")}
        `;

        const styleFilter = document.getElementById("styleFilter");
        styleFilter.value = selectedStyleId;
        styleFilter.addEventListener("change", () => {
          selectedStyleId = styleFilter.value;
        });
      }

      async function loadCourses(teacherId) {
        studentScreen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...";
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);

        studentScreen.innerHTML =
          "<b>–ö—É—Ä—Å—ã</b><br/><br/>" +
          courses
            .map(
              (c) => `
              <button onclick="openCourse(${c.id})">
                ${escapeHtml(c.title)}<br/>
                <small class="muted">${escapeHtml(c.description || "")}</small><br/>
                <small class="muted">–¶–µ–Ω–∞: ${Number(c.price || 0)} ‚ÇΩ</small>
              </button>
            `
            )
            .join("") +
          `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
      }

      async function openCourse(courseId) {
        studentScreen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...";
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        studentScreen.innerHTML =
          "<b>–£—Ä–æ–∫–∏</b><br/><br/>" +
          lessons
            .map((l) => {
              const typeClass = l.is_free ? "free" : "paid";
              const typeText = l.is_free ? "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ" : "–ü–ª–∞—Ç–Ω–æ";
              const durationText = l.duration_sec ? `${Math.round(l.duration_sec / 60)} –º–∏–Ω` : "–±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏";
              const previewHtml = l.preview_url
                ? `<br/><small><a href="${escapeHtml(l.preview_url)}" target="_blank" rel="noopener noreferrer">–ü—Ä–µ–≤—å—é</a></small>`
                : "";
              return `
                <button onclick="doLesson(${l.lesson_number})">
                  –£—Ä–æ–∫ ${l.lesson_number}: ${escapeHtml(l.title)}<br/>
                  <small class="pill ${typeClass}">${typeText}</small>
                  <small class="muted"> ¬∑ ${durationText}</small>
                  ${previewHtml}
                </button>
              `;
            })
            .join("") +
          `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
      }

      async function doLesson(lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({ telegramId: tgUser.id, lessonNumber }),
        });

        if (data.blocked) {
          tg.showPopup({
            title: "üîí –£—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç",
            message: "–≠—Ç–æ—Ç —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ",
            buttons: [{ type: "ok" }],
          });
          return;
        }

        await loadCurrentUser();
      }

      async function loadTeacherProfile() {
        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";
      }

      async function saveTeacherProfile() {
        await apiFetch("/api/teacher/profile", {
          method: "PUT",
          body: JSON.stringify({
            name: teacherNameInput.value.trim(),
            description: teacherDescriptionInput.value.trim(),
            avatarUrl: teacherAvatarInput.value.trim(),
          }),
        });
        tg.showAlert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
      }

      function resetLessonForm() {
        editingLessonId = null;
        lessonNumberInput.value = "";
        lessonDurationInput.value = "";
        lessonTitleInput.value = "";
        lessonPreviewInput.value = "";
        lessonDescriptionInput.value = "";
        lessonIsFreeInput.value = "true";
        saveLessonBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ä–æ–∫";
      }

      async function loadTeacherCourses() {
        currentTeacherCourses = await apiFetch("/api/teacher/courses");
        teacherCourses.innerHTML =
          "<b>–í–∞—à–∏ –∫—É—Ä—Å—ã</b><br/><br/>" +
          (currentTeacherCourses.length
            ? currentTeacherCourses
                .map(
                  (c) =>
                    `‚Ä¢ ${escapeHtml(c.title)} ‚Äî ${Number(c.price || 0)} ‚ÇΩ (${c.is_published ? "–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω" : "—Å–∫—Ä—ã—Ç"})`
                )
                .join("<br/>")
            : "–ü–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤");

        teacherCourseSelect.innerHTML = currentTeacherCourses.length
          ? currentTeacherCourses.map((c) => `<option value="${c.id}">${escapeHtml(c.title)}</option>`).join("")
          : '<option value="">–ù–µ—Ç –∫—É—Ä—Å–æ–≤</option>';

        if (currentTeacherCourses.length) {
          await loadSelectedTeacherCourseLessons();
        } else {
          teacherLessons.textContent = "–£—Ä–æ–∫–∏: —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∫—É—Ä—Å";
        }
      }

      async function loadSelectedTeacherCourseLessons() {
        const courseId = Number(teacherCourseSelect.value);
        if (!courseId) {
          teacherLessons.textContent = "–£—Ä–æ–∫–∏: –≤—ã–±–µ—Ä–∏ –∫—É—Ä—Å";
          return;
        }
        const lessons = await apiFetch(`/api/teacher/courses/${courseId}/lessons`);
        currentTeacherLessons = lessons;
        teacherLessons.innerHTML =
          "<b>–£—Ä–æ–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞</b><br/><br/>" +
          (lessons.length
            ? lessons
                .map(
                  (l) => `
                    <div class="lesson-row">
                      <b>${l.lesson_number}. ${escapeHtml(l.title)}</b><br/>
                      <small class="muted">${escapeHtml(l.description || "")}</small><br/>
                      <small class="muted">${l.is_free ? "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π" : "–ü–ª–∞—Ç–Ω—ã–π"} ¬∑ ${
                        l.duration_sec ? `${l.duration_sec} —Å–µ–∫` : "–±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
                      }</small><br/>
                      ${
                        l.preview_url
                          ? `<small><a href="${escapeHtml(
                              l.preview_url
                            )}" target="_blank" rel="noopener noreferrer">–ü—Ä–µ–≤—å—é</a></small><br/>`
                          : ""
                      }
                      <button class="secondary" onclick="editLessonById(${l.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                  `
                )
                .join("")
            : "–ü–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤");
      }

      async function createCourse() {
        const title = courseTitleInput.value.trim();
        if (!title) {
          tg.showAlert("–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞");
          return;
        }
        await apiFetch("/api/teacher/courses", {
          method: "POST",
          body: JSON.stringify({
            title,
            description: courseDescriptionInput.value.trim(),
            price: Number(coursePriceInput.value || 0),
            isPublished: coursePublishedInput.value === "true",
            styleIds: [],
          }),
        });
        courseTitleInput.value = "";
        courseDescriptionInput.value = "";
        coursePriceInput.value = "";
        await loadTeacherCourses();
        tg.showAlert("–ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω");
      }

      window.editLessonById = function editLessonById(lessonId) {
        const lesson = currentTeacherLessons.find((item) => item.id === lessonId);
        if (!lesson) return;
        editingLessonId = lesson.id;
        lessonNumberInput.value = lesson.lesson_number;
        lessonDurationInput.value = lesson.duration_sec || "";
        lessonTitleInput.value = lesson.title || "";
        lessonPreviewInput.value = lesson.preview_url || "";
        lessonDescriptionInput.value = lesson.description || "";
        lessonIsFreeInput.value = lesson.is_free ? "true" : "false";
        saveLessonBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å —É—Ä–æ–∫";
      };

      async function saveLesson() {
        const courseId = Number(teacherCourseSelect.value);
        if (!courseId) {
          tg.showAlert("–í—ã–±–µ—Ä–∏ –∫—É—Ä—Å");
          return;
        }

        const payload = {
          lessonNumber: Number(lessonNumberInput.value),
          title: lessonTitleInput.value.trim(),
          description: lessonDescriptionInput.value.trim(),
          isFree: lessonIsFreeInput.value === "true",
          durationSec: lessonDurationInput.value ? Number(lessonDurationInput.value) : null,
          previewUrl: lessonPreviewInput.value.trim() || null,
        };

        if (!payload.lessonNumber || !payload.title) {
          tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –Ω–æ–º–µ—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞");
          return;
        }

        if (editingLessonId) {
          await apiFetch(`/api/teacher/lessons/${editingLessonId}`, {
            method: "PUT",
            body: JSON.stringify(payload),
          });
        } else {
          await apiFetch(`/api/teacher/courses/${courseId}/lessons`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
        }

        resetLessonForm();
        await loadSelectedTeacherCourseLessons();
        tg.showAlert("–£—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
      }

      window.loadTeachers = loadTeachers;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.doLesson = doLesson;
    </script>
  </body>
</html>

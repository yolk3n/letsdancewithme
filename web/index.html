<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/strings.ru.js"></script>
    <link rel="stylesheet" href="/styles.css" />
</head>
  <body>
    <main class="app-shell">
    <div class="card" id="user"></div>

    <div class="card hidden" id="onboardingCard">
      <b id="onboardingTitle"></b>
      <p class="muted" id="onboardingText"></p>
      <button id="onboardingBtn"></button>
    </div>

    <div class="card hidden" id="studentScreen"></div>
    <div class="card hidden" id="profileScreen"></div>
    <div class="card hidden" id="teacherScreen"></div>
    <div class="card hidden" id="adminScreen"></div>
    </main>
    <script src="/screens/profile.js"></script>
    <script src="/screens/student.js"></script>
    <script src="/screens/course.js"></script>
    <script src="/screens/lesson.js"></script>
    <script src="/screens/teacher.js"></script>
    <script src="/screens/admin.js"></script>
    <script>
      const S = window.STRINGS_RU;
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;

      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingTitle = document.getElementById("onboardingTitle");
      const onboardingText = document.getElementById("onboardingText");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const profileScreen = document.getElementById("profileScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const adminScreen = document.getElementById("adminScreen");

      let currentUser = null;
      let selectedStyleId = "";
      let selectedTeacherFilterId = "";
      let showTeacherPicker = false;
      let teacherSearchQuery = "";
      let studentCatalogMode = "all";
      let currentStyles = [];
      let currentStudentTeachers = [];
      let selectedTeacherId = null;
      let currentStudentCourses = [];
      let currentCourseLessons = [];
      let openedStudentCourseId = null;
      let openedLessonNumber = null;
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let currentAdminUsers = [];
      let editingLessonId = null;
      let selectedAppScreen = "student";

      renderStaticTexts();

      if (!tgUser) {
        userBlock.innerHTML = `<span class="error">${S.noTelegramData}</span>`;
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderStaticTexts() {
        onboardingTitle.textContent = S.onboardingTitle;
        onboardingText.textContent = S.onboardingText;
        onboardingBtn.textContent = S.onboardingStart;
        userBlock.textContent = S.loadingUser;
      }

      function renderCenteredLoader(label = "") {
        return `
          <div class="loading-center" role="status" aria-live="polite">
            <span class="loading-spinner" aria-hidden="true"></span>
            ${label ? `<span class="loading-label">${escapeHtml(label)}</span>` : ""}
          </div>
        `;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function getLevel(xp) {
        if (xp >= 60) return S.levelDancer;
        if (xp >= 30) return S.levelStudent;
        return S.levelBeginner;
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      function renderCourseAuthorAvatar(course) {
        if (course.teacher_avatar_url) {
          return `<img class="course-author-avatar" src="${escapeHtml(course.teacher_avatar_url)}" alt="${escapeHtml(
            course.teacher_name || "Teacher"
          )}" />`;
        }
        return `<span class="course-author-fallback">${escapeHtml(getInitials(course.teacher_name || "T"))}</span>`;
      }

      function renderTeacherFilterAvatar(teacher) {
        if (teacher?.avatar_url) {
          return `<img class="teacher-filter-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-filter-fallback">${escapeHtml(getInitials(teacher?.name || "T"))}</span>`;
      }

      function pluralizeRu(count, forms) {
        const value = Math.abs(Number(count) || 0);
        const mod10 = value % 10;
        const mod100 = value % 100;
        if (mod10 === 1 && mod100 !== 11) return forms[0];
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return forms[1];
        return forms[2];
      }

      function courseCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["курс", "курса", "курсов"])}`;
      }

      function studentCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["ученик", "ученика", "учеников"])}`;
      }

      function getCourseLevelLabel(level) {
        if (level === "advanced") return "Продвинутый";
        if (level === "professional") return "Профессионал";
        return "Новичок";
      }

      function getCourseLevelClass(level) {
        if (level === "advanced") return "advanced";
        if (level === "professional") return "professional";
        return "beginner";
      }

      function getCourseDirectionClass(course) {
        const styleNames = Array.isArray(course?.styles) ? course.styles.map((style) => String(style?.name || "")) : [];
        const haystack = `${styleNames.join(" ")} ${String(course?.title || "")}`.toLowerCase();
        if (haystack.includes("salsa") || haystack.includes("сальс")) return "salsa";
        if (haystack.includes("bachata") || haystack.includes("бачат")) return "bachata";
        if (haystack.includes("kizomba") || haystack.includes("кизомб")) return "kizomba";
        return "salsa";
      }

      function normalizeLessonTitle(lesson) {
        let rawTitle = String(lesson?.title || "").trim();
        if (!rawTitle) {
          return `${S.lessonsTitle.slice(0, -1)} ${lesson?.lesson_number || ""}`.trim();
        }
        while (/^урок\s*\d+\s*:\s*/i.test(rawTitle)) {
          rawTitle = rawTitle.replace(/^урок\s*\d+\s*:\s*/i, "").trim();
        }
        return rawTitle;
      }

      function renderLessonHero(course) {
        const levelClass = getCourseLevelClass(course?.level);
        const teacherName = course?.teacher_name || "Преподаватель";
        const title = course?.title || "Курс";
        return `
          <div class="lesson-hero level-${levelClass}">
            <div class="lesson-hero-author">
              ${renderCourseAuthorAvatar(course || {})}
              <div class="lesson-hero-name">${escapeHtml(teacherName)}</div>
            </div>
            <h2 class="lesson-hero-title">${escapeHtml(title)}</h2>
          </div>
        `;
      }

      function getTeacherAccent(teacherId) {
        const palette = [
          { chipBg: "#fde8ee" },
          { chipBg: "#e3f5fb" },
          { chipBg: "#faefde" },
          { chipBg: "#edf5e7" },
          { chipBg: "#f0eafa" },
          { chipBg: "#fbe9ef" },
        ];
        const index = Math.abs(Number(teacherId) || 0) % palette.length;
        return palette[index];
      }

      function renderStyleFilterChips(styles) {
        return `
          <div class="style-chips">
            <button class="style-chip ${selectedStyleId ? "" : "active"}" onclick="setStyleFilter('')">${S.allStyles}</button>
            ${styles
              .map(
                (style) =>
                  `<button class="style-chip ${String(style.id) === String(selectedStyleId) ? "active" : ""}" onclick="setStyleFilter('${style.id}')">${escapeHtml(style.name)}</button>`
              )
              .join("")}
          </div>
        `;
      }

      function renderStudentProof(teacher) {
        const avatars = Array.isArray(teacher.student_avatars_preview)
          ? teacher.student_avatars_preview.filter(Boolean).slice(0, 3)
          : [];
        const studentsCount = Number(teacher.students_count || 0);
        if (!studentsCount) return "";
        return `
          <div class="teacher-proof">
            <small class="teacher-proof-label">${studentCountLabel(studentsCount)}</small>
            <div class="mini-avatars">
              ${avatars.map((url) => `<img src="${escapeHtml(url)}" alt="student" />`).join("")}
              ${studentsCount > avatars.length ? `<span>+${studentsCount - avatars.length}</span>` : ""}
            </div>
          </div>
        `;
      }

      function setStyleFilter(styleId) {
        selectedStyleId = styleId ? String(styleId) : "";
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function toggleTeacherPicker() {
        showTeacherPicker = !showTeacherPicker;
        if (!showTeacherPicker) teacherSearchQuery = "";
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function closeTeacherPicker() {
        showTeacherPicker = false;
        teacherSearchQuery = "";
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function selectTeacherFilter(teacherId) {
        selectedTeacherFilterId = String(teacherId || "");
        showTeacherPicker = false;
        teacherSearchQuery = "";
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function clearTeacherFilter(event) {
        if (event && typeof event.stopPropagation === "function") event.stopPropagation();
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        teacherSearchQuery = "";
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function setTeacherSearchQuery(value) {
        teacherSearchQuery = String(value || "");
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderTeacherFilterControl(teachers) {
        const selectedTeacher = teachers.find((teacher) => String(teacher.id) === String(selectedTeacherFilterId));
        if (!selectedTeacher) {
          return `<button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">Все преподаватели</button>`;
        }

        return `
          <button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">
            ${renderTeacherFilterAvatar(selectedTeacher)}
            <span>${escapeHtml(selectedTeacher.name || "Преподаватель")}</span>
            <span class="teacher-filter-clear" onclick="clearTeacherFilter(event)">×</span>
          </button>
        `;
      }

      function renderTeacherPicker(teachers) {
        if (!showTeacherPicker) return "";
        const selectedId = String(selectedTeacherFilterId || "");
        const query = teacherSearchQuery.trim().toLowerCase();
        const filteredTeachers = query
          ? teachers.filter((teacher) => String(teacher?.name || "").toLowerCase().includes(query))
          : teachers;
        return `
          <div class="teacher-picker-overlay" onclick="closeTeacherPicker()">
            <div class="teacher-picker" onclick="event.stopPropagation()">
              <div class="teacher-picker-head">
                <input
                  class="teacher-picker-search"
                  type="text"
                  placeholder="Поиск по имени"
                  value="${escapeHtml(teacherSearchQuery)}"
                  oninput="setTeacherSearchQuery(this.value)"
                />
                <button class="secondary teacher-picker-close" onclick="closeTeacherPicker()">×</button>
              </div>
              ${filteredTeachers.length
                ? filteredTeachers
                .map(
                  (teacher) => `
                    <button class="teacher-picker-item" onclick="selectTeacherFilter(${teacher.id})">
                      ${renderTeacherFilterAvatar(teacher)}
                      <span class="teacher-picker-main">
                        <span class="teacher-picker-name">${escapeHtml(teacher.name || "Преподаватель")}</span>
                        <span class="teacher-picker-sub">${escapeHtml((teacher.styles || []).map((s) => s.name).join(", ") || "Направления")}</span>
                      </span>
                      <span class="teacher-picker-radio ${String(teacher.id) === selectedId ? "selected" : ""}"></span>
                    </button>
                  `
                )
                .join("")
                : `<div class="teacher-picker-empty muted">Ничего не найдено</div>`}
            </div>
          </div>
        `;
      }

      function renderTeacherCard(teacher) {
        const accent = getTeacherAccent(teacher.id);
        const styles = Array.isArray(teacher.styles) ? teacher.styles : [];
        const visibleStyles = styles.slice(0, 2);
        const overflowCount = Math.max(styles.length - visibleStyles.length, 0);
        return `
          <div class="teacher-card" onclick="loadCourses(${teacher.id})" style="--teacher-chip-bg:${accent.chipBg};">
            <div class="teacher-card-head">
              ${renderTeacherAvatar(teacher)}
              <div class="teacher-content">
                <h3 class="teacher-name">${escapeHtml(teacher.name || "Преподаватель")}</h3>
                <div class="teacher-courses-count">${courseCountLabel(Number(teacher.published_courses_count || 0))}</div>
              </div>
            </div>
            <div class="teacher-style-row">
              ${
                visibleStyles.length
                  ? visibleStyles.map((style) => `<span class="teacher-style-chip">${escapeHtml(style.name)}</span>`).join("")
                  : `<span class="teacher-style-chip">Направление не указано</span>`
              }
              ${overflowCount ? `<span class="teacher-style-chip">+${overflowCount}</span>` : ""}
            </div>
            ${renderStudentProof(teacher)}
          </div>
        `;
      }

      function formatRub(value) {
        return `₽ ${Number(value || 0)}`;
      }

      function renderStudentHeader(title, subtitle = "", backAction = "") {
        const backPart = backAction
          ? `<button class="secondary back-btn" onclick="${backAction}">← Назад</button>`
          : `<span class="back-spacer"></span>`;
        return `
          <div class="student-header">
            <div class="student-header-top">
              ${backPart}
              <h2 class="student-header-title">${escapeHtml(title)}</h2>
            </div>
            ${subtitle ? `<p class="section-subtitle">${escapeHtml(subtitle)}</p>` : ""}
          </div>
        `;
      }

      async function bootstrap() {
        bindEvents();
        await syncProfileFromTelegram();
        await loadCurrentUser();
        await routeByRole();
      }

      async function syncProfileFromTelegram() {
        await apiFetch("/api/profile/sync", {
          method: "POST",
          body: JSON.stringify({
            first_name: tgUser.first_name,
            last_name: tgUser.last_name,
            username: tgUser.username,
            avatar_url: tgUser.photo_url,
          }),
        });
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        const avatarUrl = currentUser.avatar_url || tgUser.photo_url || "";
        const helloName =
          [currentUser.last_name, currentUser.first_name].filter(Boolean).join(" ") ||
          [tgUser.last_name, tgUser.first_name].filter(Boolean).join(" ") ||
          currentUser.username ||
          S.userDefaultName;

        userBlock.innerHTML = `
          <div class="profile-top" onclick="openProfileMenu()">
            ${
              avatarUrl
                ? `<img class="profile-avatar" src="${escapeHtml(avatarUrl)}" alt="profile avatar" />`
                : `<span class="profile-avatar-fallback">${escapeHtml(getInitials(currentUser.first_name || tgUser.first_name || "U"))}</span>`
            }
            <div class="profile-greeting">Привет, ${escapeHtml(helloName)}</div>
          </div>
        `;
      }

      function openProfileMenu() {
        selectedAppScreen = "profile";
        setUserHeaderVisible(true);
        routeByRole().catch((error) => {
          profileScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openStudentScreen() {
        selectedAppScreen = "student";
        setUserHeaderVisible(false);
        routeByRole().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openTeacherCabinet() {
        selectedAppScreen = "teacher";
        setUserHeaderVisible(true);
        routeByRole().catch((error) => {
          teacherScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openAdminPanel() {
        selectedAppScreen = "admin";
        setUserHeaderVisible(true);
        routeByRole().catch((error) => {
          adminScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function setUserHeaderVisible(visible) {
        userBlock.classList.toggle("hidden", !visible);
      }

      function openSupport() {
        tg.showAlert("Напиши в поддержку: @letsdancewithme_support");
      }

      function openMySubscriptions() {
        studentCatalogMode = "subscriptions";
        openStudentScreen();
      }

      function openAllCourses() {
        studentCatalogMode = "all";
        openStudentScreen();
      }

      window.renderStudentScreen = renderStudentScreen;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.shareCourse = shareCourse;
      window.openLessonPage = openLessonPage;
      window.purchaseCourse = purchaseCourse;
      window.openCoursePurchaseOverlay = openCoursePurchaseOverlay;
      window.closeCoursePurchaseOverlay = closeCoursePurchaseOverlay;
      window.purchaseCourseFromOverlay = purchaseCourseFromOverlay;
      window.doLesson = doLesson;
      window.setStyleFilter = setStyleFilter;
      window.toggleTeacherPicker = toggleTeacherPicker;
      window.closeTeacherPicker = closeTeacherPicker;
      window.selectTeacherFilter = selectTeacherFilter;
      window.clearTeacherFilter = clearTeacherFilter;
      window.setTeacherSearchQuery = setTeacherSearchQuery;
      window.openProfileMenu = openProfileMenu;
      window.openStudentScreen = openStudentScreen;
      window.openMySubscriptions = openMySubscriptions;
      window.openAllCourses = openAllCourses;
      window.openTeacherCabinet = openTeacherCabinet;
      window.openAdminPanel = openAdminPanel;
      window.openSupport = openSupport;
      window.setUserHeaderVisible = setUserHeaderVisible;
    </script>
  </body>
</html>




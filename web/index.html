<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/strings.ru.js"></script>
    <link rel="stylesheet" href="/styles.css" />
</head>
  <body>
    <main class="app-shell">
    <div class="card" id="user"></div>

    <div class="card hidden" id="onboardingCard">
      <b id="onboardingTitle"></b>
      <p class="muted" id="onboardingText"></p>
      <button id="onboardingBtn"></button>
    </div>

    <div class="card hidden" id="studentScreen"></div>
    <div class="card hidden" id="profileScreen"></div>
    <div class="card hidden" id="teacherScreen"></div>
    <div class="card hidden" id="adminScreen"></div>
    </main>

    <script>
      const S = window.STRINGS_RU;
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;

      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingTitle = document.getElementById("onboardingTitle");
      const onboardingText = document.getElementById("onboardingText");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const profileScreen = document.getElementById("profileScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const adminScreen = document.getElementById("adminScreen");

      let currentUser = null;
      let selectedStyleId = "";
      let selectedTeacherFilterId = "";
      let showTeacherPicker = false;
      let studentCatalogMode = "all";
      let currentStyles = [];
      let currentStudentTeachers = [];
      let selectedTeacherId = null;
      let currentStudentCourses = [];
      let currentCourseLessons = [];
      let openedStudentCourseId = null;
      let openedLessonNumber = null;
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let currentAdminUsers = [];
      let editingLessonId = null;
      let selectedAppScreen = "student";

      renderStaticTexts();

      if (!tgUser) {
        userBlock.innerHTML = `<span class="error">${S.noTelegramData}</span>`;
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderStaticTexts() {
        onboardingTitle.textContent = S.onboardingTitle;
        onboardingText.textContent = S.onboardingText;
        onboardingBtn.textContent = S.onboardingStart;
        userBlock.textContent = S.loadingUser;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function getLevel(xp) {
        if (xp >= 60) return S.levelDancer;
        if (xp >= 30) return S.levelStudent;
        return S.levelBeginner;
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      function renderCourseAuthorAvatar(course) {
        if (course.teacher_avatar_url) {
          return `<img class="course-author-avatar" src="${escapeHtml(course.teacher_avatar_url)}" alt="${escapeHtml(
            course.teacher_name || "Teacher"
          )}" />`;
        }
        return `<span class="course-author-fallback">${escapeHtml(getInitials(course.teacher_name || "T"))}</span>`;
      }

      function formatTeacherNameForCard(fullName) {
        const parts = String(fullName || "")
          .trim()
          .split(/\s+/)
          .filter(Boolean);
        if (parts.length >= 2) {
          return {
            line1: parts[1],
            line2: parts[0],
            isSingle: false,
          };
        }
        return {
          line1: parts[0] || "Преподаватель",
          line2: "",
          isSingle: true,
        };
      }

      function renderTeacherFilterAvatar(teacher) {
        if (teacher?.avatar_url) {
          return `<img class="teacher-filter-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-filter-fallback">${escapeHtml(getInitials(teacher?.name || "T"))}</span>`;
      }

      function pluralizeRu(count, forms) {
        const value = Math.abs(Number(count) || 0);
        const mod10 = value % 10;
        const mod100 = value % 100;
        if (mod10 === 1 && mod100 !== 11) return forms[0];
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return forms[1];
        return forms[2];
      }

      function courseCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["курс", "курса", "курсов"])}`;
      }

      function studentCountLabel(count) {
        return `${count} ${pluralizeRu(count, ["ученик", "ученика", "учеников"])}`;
      }

      function getCourseLevelLabel(level) {
        if (level === "advanced") return "Продвинутый";
        if (level === "professional") return "Профессионал";
        return "Новичок";
      }

      function getCourseLevelClass(level) {
        if (level === "advanced") return "advanced";
        if (level === "professional") return "professional";
        return "beginner";
      }

      function getCourseDirectionClass(course) {
        const styleNames = Array.isArray(course?.styles) ? course.styles.map((style) => String(style?.name || "")) : [];
        const haystack = `${styleNames.join(" ")} ${String(course?.title || "")}`.toLowerCase();
        if (haystack.includes("salsa") || haystack.includes("сальс")) return "salsa";
        if (haystack.includes("bachata") || haystack.includes("бачат")) return "bachata";
        if (haystack.includes("kizomba") || haystack.includes("кизомб")) return "kizomba";
        return "salsa";
      }

      function normalizeLessonTitle(lesson) {
        let rawTitle = String(lesson?.title || "").trim();
        if (!rawTitle) {
          return `${S.lessonsTitle.slice(0, -1)} ${lesson?.lesson_number || ""}`.trim();
        }
        while (/^урок\s*\d+\s*:\s*/i.test(rawTitle)) {
          rawTitle = rawTitle.replace(/^урок\s*\d+\s*:\s*/i, "").trim();
        }
        return rawTitle;
      }

      function renderLessonHero(course) {
        const levelClass = getCourseLevelClass(course?.level);
        const teacherName = course?.teacher_name || "Преподаватель";
        const title = course?.title || "Курс";
        return `
          <div class="lesson-hero level-${levelClass}">
            <div class="lesson-hero-author">
              ${renderCourseAuthorAvatar(course || {})}
              <div class="lesson-hero-name">${escapeHtml(teacherName)}</div>
            </div>
            <h2 class="lesson-hero-title">${escapeHtml(title)}</h2>
          </div>
        `;
      }

      function getTeacherAccent(teacherId) {
        const palette = [
          { chipBg: "#fde8ee" },
          { chipBg: "#e3f5fb" },
          { chipBg: "#faefde" },
          { chipBg: "#edf5e7" },
          { chipBg: "#f0eafa" },
          { chipBg: "#fbe9ef" },
        ];
        const index = Math.abs(Number(teacherId) || 0) % palette.length;
        return palette[index];
      }

      function renderStyleFilterChips(styles) {
        return `
          <div class="style-chips">
            <button class="style-chip ${selectedStyleId ? "" : "active"}" onclick="setStyleFilter('')">${S.allStyles}</button>
            ${styles
              .map(
                (style) =>
                  `<button class="style-chip ${String(style.id) === String(selectedStyleId) ? "active" : ""}" onclick="setStyleFilter('${style.id}')">${escapeHtml(style.name)}</button>`
              )
              .join("")}
          </div>
        `;
      }

      function renderStudentProof(teacher) {
        const avatars = Array.isArray(teacher.student_avatars_preview)
          ? teacher.student_avatars_preview.filter(Boolean).slice(0, 3)
          : [];
        const studentsCount = Number(teacher.students_count || 0);
        if (!studentsCount) return "";
        return `
          <div class="teacher-proof">
            <small class="teacher-proof-label">${studentCountLabel(studentsCount)}</small>
            <div class="mini-avatars">
              ${avatars.map((url) => `<img src="${escapeHtml(url)}" alt="student" />`).join("")}
              ${studentsCount > avatars.length ? `<span>+${studentsCount - avatars.length}</span>` : ""}
            </div>
          </div>
        `;
      }

      function setStyleFilter(styleId) {
        selectedStyleId = styleId ? String(styleId) : "";
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function toggleTeacherPicker() {
        showTeacherPicker = !showTeacherPicker;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function closeTeacherPicker() {
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function selectTeacherFilter(teacherId) {
        selectedTeacherFilterId = String(teacherId || "");
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function clearTeacherFilter(event) {
        if (event && typeof event.stopPropagation === "function") event.stopPropagation();
        selectedTeacherFilterId = "";
        showTeacherPicker = false;
        renderStudentScreen().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderTeacherFilterControl(teachers) {
        const selectedTeacher = teachers.find((teacher) => String(teacher.id) === String(selectedTeacherFilterId));
        if (!selectedTeacher) {
          return `<button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">Все преподаватели</button>`;
        }

        return `
          <button class="teacher-filter-btn active" onclick="toggleTeacherPicker()">
            ${renderTeacherFilterAvatar(selectedTeacher)}
            <span>${escapeHtml(selectedTeacher.name || "Преподаватель")}</span>
            <span class="teacher-filter-clear" onclick="clearTeacherFilter(event)">×</span>
          </button>
        `;
      }

      function renderTeacherPicker(teachers) {
        if (!showTeacherPicker) return "";
        const selectedId = String(selectedTeacherFilterId || "");
        return `
          <div class="teacher-picker-overlay" onclick="closeTeacherPicker()">
            <div class="teacher-picker" onclick="event.stopPropagation()">
              <div class="teacher-picker-head">
                <h3>Выберите преподавателя</h3>
                <button class="secondary teacher-picker-close" onclick="closeTeacherPicker()">×</button>
              </div>
              <button class="teacher-picker-item" onclick="clearTeacherFilter()">
                <span class="teacher-picker-avatar">👥</span>
                <span class="teacher-picker-main">
                  <span class="teacher-picker-name">Все преподаватели</span>
                </span>
                <span class="teacher-picker-radio ${!selectedId ? "selected" : ""}"></span>
              </button>
              ${teachers
                .map(
                  (teacher) => `
                    <button class="teacher-picker-item" onclick="selectTeacherFilter(${teacher.id})">
                      ${renderTeacherFilterAvatar(teacher)}
                      <span class="teacher-picker-main">
                        <span class="teacher-picker-name">${escapeHtml(teacher.name || "Преподаватель")}</span>
                        <span class="teacher-picker-sub">${escapeHtml((teacher.styles || []).map((s) => s.name).join(", ") || "Направления")}</span>
                      </span>
                      <span class="teacher-picker-radio ${String(teacher.id) === selectedId ? "selected" : ""}"></span>
                    </button>
                  `
                )
                .join("")}
            </div>
          </div>
        `;
      }

      function renderTeacherCard(teacher) {
        const accent = getTeacherAccent(teacher.id);
        const styles = Array.isArray(teacher.styles) ? teacher.styles : [];
        const visibleStyles = styles.slice(0, 2);
        const overflowCount = Math.max(styles.length - visibleStyles.length, 0);
        return `
          <div class="teacher-card" onclick="loadCourses(${teacher.id})" style="--teacher-chip-bg:${accent.chipBg};">
            <div class="teacher-card-head">
              ${renderTeacherAvatar(teacher)}
              <div class="teacher-content">
                <h3 class="teacher-name">${escapeHtml(teacher.name || "Преподаватель")}</h3>
                <div class="teacher-courses-count">${courseCountLabel(Number(teacher.published_courses_count || 0))}</div>
              </div>
            </div>
            <div class="teacher-style-row">
              ${
                visibleStyles.length
                  ? visibleStyles.map((style) => `<span class="teacher-style-chip">${escapeHtml(style.name)}</span>`).join("")
                  : `<span class="teacher-style-chip">Направление не указано</span>`
              }
              ${overflowCount ? `<span class="teacher-style-chip">+${overflowCount}</span>` : ""}
            </div>
            ${renderStudentProof(teacher)}
          </div>
        `;
      }

      function formatRub(value) {
        return `${Number(value || 0)} ₽`;
      }

      function renderStudentHeader(title, subtitle = "", backAction = "") {
        const backPart = backAction
          ? `<button class="secondary back-btn" onclick="${backAction}">← Назад</button>`
          : `<span class="back-spacer"></span>`;
        return `
          <div class="student-header">
            <div class="student-header-top">
              ${backPart}
              <h2 class="student-header-title">${escapeHtml(title)}</h2>
            </div>
            ${subtitle ? `<p class="section-subtitle">${escapeHtml(subtitle)}</p>` : ""}
          </div>
        `;
      }

      async function bootstrap() {
        bindEvents();
        await syncProfileFromTelegram();
        await loadCurrentUser();
        await routeByRole();
      }

      async function syncProfileFromTelegram() {
        await apiFetch("/api/profile/sync", {
          method: "POST",
          body: JSON.stringify({
            first_name: tgUser.first_name,
            last_name: tgUser.last_name,
            username: tgUser.username,
            avatar_url: tgUser.photo_url,
          }),
        });
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        const avatarUrl = currentUser.avatar_url || tgUser.photo_url || "";
        const helloName =
          [currentUser.last_name, currentUser.first_name].filter(Boolean).join(" ") ||
          [tgUser.last_name, tgUser.first_name].filter(Boolean).join(" ") ||
          currentUser.username ||
          S.userDefaultName;

        userBlock.innerHTML = `
          <div class="profile-top" onclick="openProfileMenu()">
            ${
              avatarUrl
                ? `<img class="profile-avatar" src="${escapeHtml(avatarUrl)}" alt="profile avatar" />`
                : `<span class="profile-avatar-fallback">${escapeHtml(getInitials(currentUser.first_name || tgUser.first_name || "U"))}</span>`
            }
            <div class="profile-greeting">Привет, ${escapeHtml(helloName)}</div>
          </div>
        `;
      }

      function openProfileMenu() {
        selectedAppScreen = "profile";
        routeByRole().catch((error) => {
          profileScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openStudentScreen() {
        selectedAppScreen = "student";
        routeByRole().catch((error) => {
          studentScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openTeacherCabinet() {
        selectedAppScreen = "teacher";
        routeByRole().catch((error) => {
          teacherScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openAdminPanel() {
        selectedAppScreen = "admin";
        routeByRole().catch((error) => {
          adminScreen.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function openSupport() {
        tg.showAlert("Напиши в поддержку: @letsdancewithme_support");
      }

      function openMySubscriptions() {
        studentCatalogMode = "subscriptions";
        openStudentScreen();
      }

      function openAllCourses() {
        studentCatalogMode = "all";
        openStudentScreen();
      }

      async function renderProfileScreen() {
        profileScreen.innerHTML = `
          ${renderStudentHeader("Профиль", "", "openStudentScreen()")}
          <div class="profile-menu">
            <button onclick="openMySubscriptions()">Мои подписки</button>
            ${currentUser.role === "teacher" || currentUser.role === "admin" ? `<button onclick="openTeacherCabinet()">Мои курсы</button>` : ""}
            ${currentUser.role === "admin" ? `<button onclick="openAdminPanel()">Администрирование</button>` : ""}
            <button class="secondary" onclick="openSupport()">Поддержка</button>
            <button class="secondary" onclick="openAllCourses()">Все курсы</button>
          </div>
        `;
      }

      async function completeOnboarding() {
        await apiFetch("/api/onboarding/complete", { method: "POST" });
        await loadCurrentUser();
        await routeByRole();
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        profileScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");
        adminScreen.classList.add("hidden");

        if (selectedAppScreen === "profile") {
          profileScreen.classList.remove("hidden");
          await renderProfileScreen();
          return;
        }

        const canUseTeacher = currentUser.role === "teacher" || currentUser.role === "admin";
        const canUseAdmin = currentUser.role === "admin";
        const showTeacherScreen = selectedAppScreen === "teacher" && canUseTeacher;
        const showAdminScreen = selectedAppScreen === "admin" && canUseAdmin;

        if (!currentUser.is_onboarded && !(showTeacherScreen || showAdminScreen)) {
          onboardingCard.classList.remove("hidden");
        }

        if (showAdminScreen) {
          adminScreen.classList.remove("hidden");
          await renderAdminScreen();
          return;
        }

        if (showTeacherScreen) {
          teacherScreen.classList.remove("hidden");
          await renderTeacherScreen();
          return;
        }

        studentScreen.classList.remove("hidden");
        await renderStudentScreen();
      }

      async function renderStudentScreen() {
        studentScreen.classList.add("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = null;
        openedLessonNumber = null;
        const [teachers, styles] = await Promise.all([apiFetch("/api/teachers"), apiFetch("/api/styles")]);
        currentStudentTeachers = teachers;
        currentStyles = styles;
        const styleQuery = selectedStyleId ? `&styleId=${selectedStyleId}` : "";
        const teacherQuery = selectedTeacherFilterId ? `&teacherId=${selectedTeacherFilterId}` : "";
        const purchasedQuery = studentCatalogMode === "subscriptions" ? "&purchased=1" : "";
        const courses = await apiFetch(`/api/student/courses?1=1${styleQuery}${teacherQuery}${purchasedQuery}`);
        currentStudentCourses = courses;
        studentScreen.innerHTML = `
          <div class="catalog-surface">
            <div class="catalog-head">
              ${renderStyleFilterChips(styles)}
            </div>
            <div class="catalog-inner">
              <div class="catalog-bar">
                <div class="catalog-row">
                  <div class="teacher-filter-wrap">
                    ${renderTeacherFilterControl(teachers)}
                  </div>
                </div>
                ${renderTeacherPicker(teachers)}
              </div>
              <div class="catalog-courses-grid">
              ${
                courses.length
                  ? courses
                      .map(
                        (course) => {
                          const levelClass = getCourseLevelClass(course.level);
                          const directionClass = getCourseDirectionClass(course);
                          const levelLabel = getCourseLevelLabel(course.level);
                          const author = formatTeacherNameForCard(course.teacher_name);
                          const progressPercent = Number(course.progress_percent || 0);
                          return `
                    <div class="course-card catalog-course-card dir-${directionClass}" onclick="openCourse(${course.id})">
                      <div class="course-head">
                        <div class="course-card-title">${escapeHtml(course.title)}</div>
                        <div class="course-head-side">
                          <span class="course-level-badge ${levelClass}">${levelLabel}</span>
                        </div>
                      </div>
                      <div class="course-top-row">
                        <div class="course-author">
                          ${renderCourseAuthorAvatar(course)}
                          <div class="course-author-name ${author.isSingle ? "single" : ""}">
                            <span class="course-author-line">${escapeHtml(author.line1)}</span>
                            ${author.line2 ? `<span class="course-author-line">${escapeHtml(author.line2)}</span>` : ""}
                          </div>
                        </div>
                        ${
                          progressPercent > 0
                            ? `<div class="course-progress-inline">
                                <div class="course-progress-track">
                                  <div class="course-progress-fill" style="width:${Math.max(0, Math.min(100, progressPercent))}%"></div>
                                </div>
                                <div class="course-progress-label">${progressPercent}%</div>
                              </div>`
                            : ""
                        }
                      </div>
                    </div>
                  `;
                        }
                      )
                      .join("")
                  : `<small class="muted">Курсы не найдены.</small>`
              }
              </div>
            </div>
          </div>
        `;
      }

      async function loadCourses(teacherId) {
        studentScreen.classList.remove("flat-list");
        selectedTeacherId = teacherId;
        openedStudentCourseId = null;
        openedLessonNumber = null;
        const selectedTeacher = currentStudentTeachers.find((teacher) => Number(teacher.id) === Number(teacherId));
        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, S.loadingCourses, "renderStudentScreen()")}
        `;
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);
        currentStudentCourses = courses;
        const coursesSubtitle = selectedTeacher
          ? `Преподаватель: ${selectedTeacher.name}${
              selectedStyleId
                ? ` • ${currentStyles.find((item) => String(item.id) === String(selectedStyleId))?.name || ""}`
                : ""
            }`
          : "Выбери курс для старта.";

        studentScreen.innerHTML = `
          ${renderStudentHeader(S.coursesTitle, coursesSubtitle, "renderStudentScreen()")}
          <div class="stack">
            ${
              courses.length
                ? courses
                    .map(
                      (course) => `
                  <div class="course-card">
                    <div class="course-card-title">${escapeHtml(course.title)}</div>
                    <small class="muted">${escapeHtml(course.description || "")}</small>
                    <div class="course-card-meta">
                      <small class="muted">${S.priceLabel}: ${formatRub(course.price)}</small>
                      <small class="pill ${course.is_purchased ? "free" : "paid"}">${course.is_purchased ? S.purchased : S.notPurchased}</small>
                    </div>
                    <button onclick="openCourse(${course.id})">Открыть уроки</button>
                  </div>
                `
                    )
                    .join("")
                : `<small class="muted">По выбранным фильтрам курсы не найдены.</small>`
            }
          </div>
        `;
      }

      async function openCourse(courseId) {
        studentScreen.classList.add("flat-list");
        selectedTeacherId = null;
        openedStudentCourseId = courseId;
        openedLessonNumber = null;
        studentScreen.innerHTML = `
          <div class="section-subtitle">${S.loadingLessons}</div>
        `;
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        currentCourseLessons = lessons;
        const course = currentStudentCourses.find((item) => item.id === courseId);
        const hasPaidLessons = lessons.some((lesson) => !lesson.is_free);
        const showBuyButton = hasPaidLessons && course && !course.is_purchased;
        const levelClass = getCourseLevelClass(course?.level);
        const styleChips = Array.isArray(course?.styles) ? course.styles : [];
        const progressPercent = Number(course?.progress_percent || 0);
        const completedLessons = Number(course?.completed_lessons || 0);

        studentScreen.innerHTML = `
          <div class="lesson-hero level-${levelClass}">
            <div class="lesson-hero-nav">
              <button class="secondary hero-icon-btn" onclick="openStudentScreen()">←</button>
            </div>
            ${
              styleChips.length
                ? `<div class="lesson-hero-tags">${styleChips
                    .slice(0, 2)
                    .map((style) => `<span class="lesson-hero-tag">${escapeHtml(style.name)}</span>`)
                    .join("")}</div>`
                : ""
            }
            <h2 class="lesson-hero-title">${escapeHtml(course?.title || "Курс")}</h2>
            <div class="lesson-hero-author">
              ${renderCourseAuthorAvatar(course || {})}
              <div>
                <div class="lesson-hero-name">${escapeHtml(course?.teacher_name || "Преподаватель")}</div>
                <div class="lesson-hero-role">Преподаватель</div>
              </div>
            </div>
          </div>
          <div class="lesson-list-wrap">
            ${showBuyButton ? `<button onclick="purchaseCourse(${courseId})">${S.buyCourse} ${formatRub(course.price)}</button>` : ""}
            <div class="lesson-program-header">
              <h3>Программа</h3>
              <span>${Math.max(0, Math.min(100, progressPercent))}% пройдено</span>
            </div>
            <div class="lesson-roadmap">
              ${
                lessons.length
                  ? lessons
                      .map((lesson) => {
                        const typeIcon = lesson.is_free ? "🆓" : "💳";
                        const durationText = lesson.duration_sec
                          ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}`
                          : S.noDuration;
                        const isCompleted = lesson.lesson_number <= completedLessons;
                        const stateIcon = lesson.is_unlocked ? (isCompleted ? "↻" : "▶") : "🔒";
                        const previewHtml = lesson.preview_url
                          ? `<small><a href="${escapeHtml(
                              lesson.preview_url
                            )}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small>`
                          : "";
                        const title = normalizeLessonTitle(lesson);
                        const action = lesson.is_unlocked ? `onclick="openLessonPage(${courseId}, ${lesson.lesson_number})"` : "";
                        return `
                  <div class="lesson-node ${lesson.is_unlocked ? "unlocked" : ""}">
                    <div class="lesson-card ${lesson.is_unlocked ? "" : "locked"}" ${action}>
                      <div class="lesson-card-head">
                        <h3 class="lesson-card-title">${escapeHtml(title)}</h3>
                        <span class="lesson-state-icon">${stateIcon}</span>
                      </div>
                      <div class="lesson-card-meta">
                        <span class="lesson-type-icon" title="${lesson.is_free ? S.free : S.paid}">${typeIcon}</span>
                        <small class="muted">${durationText}</small>
                        ${previewHtml}
                      </div>
                    </div>
                  </div>
                `;
                      })
                      .join("")
                  : `<small class="muted">В этом курсе пока нет уроков.</small>`
              }
            </div>
          </div>
        `;
      }

      function openLessonPage(courseId, lessonNumber) {
        const lesson = currentCourseLessons.find((item) => Number(item.lesson_number) === Number(lessonNumber));
        const course = currentStudentCourses.find((item) => Number(item.id) === Number(courseId));
        if (!lesson) return;
        openedLessonNumber = lessonNumber;

        const durationText = lesson.duration_sec ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}` : S.noDuration;
        const previewHtml = lesson.preview_url
          ? `<p class="lesson-page-description"><a href="${escapeHtml(
              lesson.preview_url
            )}" target="_blank" rel="noopener noreferrer">${S.preview}</a></p>`
          : "";
        const hasNextLesson = currentCourseLessons.some((item) => Number(item.lesson_number) === Number(lesson.lesson_number) + 1);

        studentScreen.innerHTML = `
          <div class="lesson-page-nav">
            <button class="secondary hero-icon-btn" onclick="openCourse(${courseId})">←</button>
            <div class="lesson-page-nav-title">Урок ${lesson.lesson_number}</div>
            <span class="lesson-page-nav-dots">⋮</span>
          </div>
          <div class="lesson-media">
            <div class="lesson-media-play">▶</div>
          </div>
          <div class="lesson-page-wrap">
            <div class="lesson-page-card">
              <div class="lesson-page-meta">
                <span class="lesson-type-icon" title="${lesson.is_free ? S.free : S.paid}">${lesson.is_free ? "🆓" : "💳"}</span>
                <span class="lesson-duration-pill">⏱ ${durationText}</span>
              </div>
              <h3>${escapeHtml(normalizeLessonTitle(lesson))}</h3>
              <p class="lesson-page-description">${escapeHtml(lesson.description || "Описание будет добавлено позже.")}</p>
              ${previewHtml}
              <div class="lesson-materials">
                <h4>Материалы</h4>
                <div class="lesson-material-item">
                  <span class="lesson-material-icon">♫</span>
                  <span class="lesson-material-main"><b>Трек для тренировки.mp3</b><small>4.2 MB</small></span>
                  <span class="lesson-material-download">⇩</span>
                </div>
                <div class="lesson-material-item">
                  <span class="lesson-material-icon">📄</span>
                  <span class="lesson-material-main"><b>Памятка по шагам.pdf</b><small>1.5 MB</small></span>
                  <span class="lesson-material-download">⇩</span>
                </div>
              </div>
              <button class="lesson-next-btn" onclick="doLesson(${courseId}, ${lesson.lesson_number})">${hasNextLesson ? "Следующий урок →" : "Завершить урок"}</button>
            </div>
          </div>
        `;
      }

      async function purchaseCourse(courseId) {
        await apiFetch(`/api/courses/${courseId}/purchase`, { method: "POST" });
        const selectedCourse = currentStudentCourses.find((item) => item.id === courseId);
        if (selectedCourse) selectedCourse.is_purchased = true;
        tg.showAlert(S.coursePurchaseSuccess);
        await openCourse(courseId);
      }

      async function doLesson(courseId, lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({ telegramId: tgUser.id, courseId, lessonNumber }),
        });

        if (data.blocked) {
          const message =
            data.reason === "course_purchase_required" ? S.lessonLockedNeedPurchase : S.lessonLockedGeneric;
          tg.showPopup({ title: S.lessonLockedTitle, message, buttons: [{ type: "ok" }] });
          return;
        }

        await loadCurrentUser();
        if (openedStudentCourseId) {
          await openCourse(openedStudentCourseId);
          const nextLesson = currentCourseLessons.find((item) => Number(item.lesson_number) === Number(lessonNumber) + 1 && item.is_unlocked);
          if (nextLesson) {
            openLessonPage(openedStudentCourseId, nextLesson.lesson_number);
            return;
          }
          if (openedLessonNumber) openLessonPage(openedStudentCourseId, openedLessonNumber);
        }
      }

      async function renderTeacherScreen() {
        teacherScreen.innerHTML = `
          <b>${S.teacherCabinet}</b>
          <p class="muted">${S.profileTitle}</p>
          <input id="teacherName" placeholder="${S.teacherNamePh}" />
          <input id="teacherDescription" placeholder="${S.teacherDescriptionPh}" />
          <input id="teacherAvatarUrl" placeholder="${S.teacherAvatarPh}" />
          <button id="saveTeacherProfileBtn">${S.saveProfile}</button>
          <hr />
          <p class="muted">${S.newCourseTitle}</p>
          <input id="courseTitle" placeholder="${S.courseNamePh}" />
          <input id="courseDescription" placeholder="${S.courseDescriptionPh}" />
          <div class="row">
            <input id="coursePrice" type="number" placeholder="${S.coursePricePh}" min="199" />
            <select id="courseLevel">
              <option value="beginner">Новичок</option>
              <option value="advanced">Продвинутый</option>
              <option value="professional">Профессионал</option>
            </select>
          </div>
          <div class="row">
            <select id="coursePublished">
              <option value="true">${S.published}</option>
              <option value="false">${S.hidden}</option>
            </select>
          </div>
          <button id="createCourseBtn">${S.createCourse}</button>
          <hr />
          <p class="muted">${S.teacherLessonsTitle}</p>
          <select id="teacherCourseSelect"></select>
          <div class="row">
            <input id="lessonNumber" type="number" min="1" placeholder="${S.lessonNumberPh}" />
            <input id="lessonDuration" type="number" min="1" placeholder="${S.lessonDurationPh}" />
          </div>
          <input id="lessonTitle" placeholder="${S.lessonNamePh}" />
          <input id="lessonPreviewUrl" placeholder="${S.lessonPreviewPh}" />
          <textarea id="lessonDescription" placeholder="${S.lessonDescriptionPh}"></textarea>
          <select id="lessonIsFree">
            <option value="true">${S.lessonFree}</option>
            <option value="false">${S.lessonPaid}</option>
          </select>
          <button id="saveLessonBtn">${S.saveLesson}</button>
          <div id="teacherCourses" class="muted">${S.loading}</div>
          <div id="teacherLessons" class="muted">${S.chooseCourse}</div>
        `;

        const teacherNameInput = document.getElementById("teacherName");
        const teacherDescriptionInput = document.getElementById("teacherDescription");
        const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
        const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");
        const courseTitleInput = document.getElementById("courseTitle");
        const courseDescriptionInput = document.getElementById("courseDescription");
        const coursePriceInput = document.getElementById("coursePrice");
        const courseLevelInput = document.getElementById("courseLevel");
        const coursePublishedInput = document.getElementById("coursePublished");
        const createCourseBtn = document.getElementById("createCourseBtn");
        const teacherCourseSelect = document.getElementById("teacherCourseSelect");
        const lessonNumberInput = document.getElementById("lessonNumber");
        const lessonDurationInput = document.getElementById("lessonDuration");
        const lessonTitleInput = document.getElementById("lessonTitle");
        const lessonPreviewInput = document.getElementById("lessonPreviewUrl");
        const lessonDescriptionInput = document.getElementById("lessonDescription");
        const lessonIsFreeInput = document.getElementById("lessonIsFree");
        const saveLessonBtn = document.getElementById("saveLessonBtn");
        const teacherCoursesBlock = document.getElementById("teacherCourses");
        const teacherLessonsBlock = document.getElementById("teacherLessons");

        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";

        saveTeacherProfileBtn.addEventListener("click", async () => {
          await apiFetch("/api/teacher/profile", {
            method: "PUT",
            body: JSON.stringify({
              name: teacherNameInput.value.trim(),
              description: teacherDescriptionInput.value.trim(),
              avatarUrl: teacherAvatarInput.value.trim(),
            }),
          });
          tg.showAlert(S.profileSaved);
        });

        async function loadTeacherCoursesData() {
          currentTeacherCourses = await apiFetch("/api/teacher/courses");
          teacherCoursesBlock.innerHTML =
            `<b>${S.yourCourses}</b><br/><br/>` +
            (currentTeacherCourses.length
              ? currentTeacherCourses
                  .map(
                    (course) =>
                      `• ${escapeHtml(course.title)} — ${getCourseLevelLabel(course.level)} — ${Number(course.price || 0)} ₽ (${
                        course.is_published ? S.published.toLowerCase() : S.hidden.toLowerCase()
                      })`
                  )
                  .join("<br/>")
              : S.noCoursesYet);

          teacherCourseSelect.innerHTML = currentTeacherCourses.length
            ? currentTeacherCourses.map((course) => `<option value="${course.id}">${escapeHtml(course.title)}</option>`).join("")
            : `<option value="">${S.noCourses}</option>`;
        }

        async function loadTeacherLessonsData() {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) {
            teacherLessonsBlock.textContent = S.chooseCourse;
            return;
          }

          const lessons = await apiFetch(`/api/teacher/courses/${courseId}/lessons`);
          currentTeacherLessons = lessons;
          teacherLessonsBlock.innerHTML =
            `<b>${S.selectedCourseLessons}</b><br/><br/>` +
            (lessons.length
              ? lessons
                  .map(
                    (lesson) => `
                      <div class="lesson-row">
                        <b>${lesson.lesson_number}. ${escapeHtml(lesson.title)}</b><br/>
                        <small class="muted">${escapeHtml(lesson.description || "")}</small><br/>
                        <small class="muted">${lesson.is_free ? S.free : S.paid} • ${
                          lesson.duration_sec ? `${lesson.duration_sec} ${S.seconds}` : S.noDuration
                        }</small><br/>
                        ${
                          lesson.preview_url
                            ? `<small><a href="${escapeHtml(lesson.preview_url)}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small><br/>`
                            : ""
                        }
                        <button class="secondary" onclick="editLessonById(${lesson.id})">${S.editLesson}</button>
                      </div>
                    `
                  )
                  .join("")
              : S.noLessonsYet);
        }

        createCourseBtn.addEventListener("click", async () => {
          const title = courseTitleInput.value.trim();
          const price = Number(coursePriceInput.value || 0);
          if (!title) return tg.showAlert(S.needCourseName);
          if (!Number.isFinite(price) || price < 199) return tg.showAlert(S.minCoursePriceError);

          await apiFetch("/api/teacher/courses", {
            method: "POST",
            body: JSON.stringify({
              title,
              description: courseDescriptionInput.value.trim(),
              price,
              level: courseLevelInput.value,
              isPublished: coursePublishedInput.value === "true",
              styleIds: [],
            }),
          });
          courseTitleInput.value = "";
          courseDescriptionInput.value = "";
          coursePriceInput.value = "";
          courseLevelInput.value = "beginner";
          await loadTeacherCoursesData();
          await loadTeacherLessonsData();
          tg.showAlert(S.courseCreated);
        });

        teacherCourseSelect.addEventListener("change", loadTeacherLessonsData);

        function resetLessonForm() {
          editingLessonId = null;
          lessonNumberInput.value = "";
          lessonDurationInput.value = "";
          lessonTitleInput.value = "";
          lessonPreviewInput.value = "";
          lessonDescriptionInput.value = "";
          lessonIsFreeInput.value = "true";
          saveLessonBtn.textContent = S.saveLesson;
        }

        window.editLessonById = function editLessonById(lessonId) {
          const lesson = currentTeacherLessons.find((item) => item.id === lessonId);
          if (!lesson) return;
          editingLessonId = lesson.id;
          lessonNumberInput.value = lesson.lesson_number;
          lessonDurationInput.value = lesson.duration_sec || "";
          lessonTitleInput.value = lesson.title || "";
          lessonPreviewInput.value = lesson.preview_url || "";
          lessonDescriptionInput.value = lesson.description || "";
          lessonIsFreeInput.value = lesson.is_free ? "true" : "false";
          saveLessonBtn.textContent = S.updateLesson;
        };

        saveLessonBtn.addEventListener("click", async () => {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) return tg.showAlert(S.chooseCourseError);

          const payload = {
            lessonNumber: Number(lessonNumberInput.value),
            title: lessonTitleInput.value.trim(),
            description: lessonDescriptionInput.value.trim(),
            isFree: lessonIsFreeInput.value === "true",
            durationSec: lessonDurationInput.value ? Number(lessonDurationInput.value) : null,
            previewUrl: lessonPreviewInput.value.trim() || null,
          };

          if (!payload.lessonNumber || !payload.title) return tg.showAlert(S.fillLessonError);

          if (editingLessonId) {
            await apiFetch(`/api/teacher/lessons/${editingLessonId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch(`/api/teacher/courses/${courseId}/lessons`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }

          resetLessonForm();
          await loadTeacherLessonsData();
          tg.showAlert(S.lessonSaved);
        });

        await loadTeacherCoursesData();
        await loadTeacherLessonsData();
      }

      async function renderAdminScreen() {
        adminScreen.innerHTML = `
          <b>${S.adminPanelTitle}</b>
          <p class="muted">${S.adminPanelText}</p>
          <button class="secondary" id="refreshAdminUsersBtn">${S.refreshUsers}</button>
          <div id="adminUsersList" class="muted">${S.loadingUsers}</div>
        `;

        const refreshAdminUsersBtn = document.getElementById("refreshAdminUsersBtn");
        const adminUsersList = document.getElementById("adminUsersList");

        async function loadAdminUsers() {
          currentAdminUsers = await apiFetch("/api/admin/users");
          adminUsersList.innerHTML = currentAdminUsers.length
            ? currentAdminUsers
                .map(
                  (user) => `
                    <div class="user-row">
                      ${
                        user.avatar_url
                          ? `<img class="teacher-avatar" src="${escapeHtml(user.avatar_url)}" alt="avatar" />`
                          : `<span class="teacher-avatar-fallback">${escapeHtml(
                              getInitials(user.first_name || user.username || String(user.telegram_id))
                            )}</span>`
                      }
                      <b>${escapeHtml(
                        [user.first_name, user.last_name].filter(Boolean).join(" ") || "Без имени"
                      )}</b><br/>
                      ${
                        user.username
                          ? `<small class="muted">@${escapeHtml(user.username)}</small><br/>`
                          : ""
                      }
                      <b>${S.userIdLabel}:</b> ${user.telegram_id}<br/>
                      <small class="muted">${S.userRoleLabel}: ${escapeHtml(user.role)} | XP: ${user.xp} | ${S.userLessonsLabel}: ${user.lessons_completed}</small>
                      <div class="role-switch-row">
                        <small>${S.teacherRoleSwitch}${user.telegram_id === currentUser.telegram_id ? " (недоступно для себя)" : ""}</small>
                        <label class="switch">
                          <input
                            type="checkbox"
                            ${user.role === "teacher" ? "checked" : ""}
                            ${user.telegram_id === currentUser.telegram_id ? "disabled" : ""}
                            onchange="setTeacherRoleSwitch(${user.telegram_id}, this.checked)"
                          />
                          <span class="slider"></span>
                        </label>
                      </div>
                    </div>
                  `
                )
                .join("")
            : S.usersEmpty;
        }

        window.setTeacherRoleSwitch = async function setTeacherRoleSwitch(telegramId, checked) {
          if (Number(telegramId) === Number(currentUser.telegram_id)) {
            tg.showAlert("Нельзя изменить свою роль из админ-панели");
            return;
          }
          const role = checked ? "teacher" : "student";
          await apiFetch(`/api/admin/users/${telegramId}/role`, {
            method: "PUT",
            body: JSON.stringify({ role }),
          });
          tg.showAlert(S.roleUpdated);
          await loadAdminUsers();
        };

        refreshAdminUsersBtn.addEventListener("click", loadAdminUsers);
        await loadAdminUsers();
      }

      window.renderStudentScreen = renderStudentScreen;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.openLessonPage = openLessonPage;
      window.purchaseCourse = purchaseCourse;
      window.doLesson = doLesson;
      window.setStyleFilter = setStyleFilter;
      window.toggleTeacherPicker = toggleTeacherPicker;
      window.closeTeacherPicker = closeTeacherPicker;
      window.selectTeacherFilter = selectTeacherFilter;
      window.clearTeacherFilter = clearTeacherFilter;
      window.openProfileMenu = openProfileMenu;
      window.openStudentScreen = openStudentScreen;
      window.openMySubscriptions = openMySubscriptions;
      window.openAllCourses = openAllCourses;
      window.openTeacherCabinet = openTeacherCabinet;
      window.openAdminPanel = openAdminPanel;
      window.openSupport = openSupport;
    </script>
  </body>
</html>



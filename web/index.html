<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
      }

      h1 {
        margin-top: 0;
      }

      .card {
        background: #1e1e1e;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .hidden {
        display: none;
      }

      .muted {
        color: #bbb;
      }

      .error {
        color: #ff8080;
      }

      button,
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 15px;
        border-radius: 8px;
        border: none;
        box-sizing: border-box;
      }

      button {
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }

      button.secondary {
        background: #333;
      }

      button:active {
        background: #e03a58;
      }

      input,
      select,
      textarea {
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #3a3a3a;
      }

      .teacher-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .teacher-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex: 0 0 44px;
      }

      .teacher-avatar-fallback {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        flex: 0 0 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        background: #2b2b2b;
        color: #fff;
      }

      .teacher-content {
        min-width: 0;
      }

      .row {
        display: flex;
        gap: 8px;
      }

      .row > * {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <h1>üíÉ Let's Dance With Me</h1>

    <div class="card" id="user">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>

    <div class="card hidden" id="onboardingCard">
      <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>
      <p class="muted">
        –ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥–µ—à—å –∫—É—Ä—Å—ã –ø–æ —Ä–∞–∑–Ω—ã–º —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω—ã–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º. –í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏ —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —É—Ä–æ–∫–æ–≤.
      </p>
      <button id="onboardingBtn">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
    </div>

    <div class="card hidden" id="studentScreen">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="card hidden" id="teacherScreen">
      <b>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b>
      <p class="muted">–ü—Ä–æ—Ñ–∏–ª—å</p>
      <input id="teacherName" placeholder="–ò–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è" />
      <input id="teacherDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
      <input id="teacherAvatarUrl" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" />
      <button id="saveTeacherProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      <hr />
      <p class="muted">–ù–æ–≤—ã–π –∫—É—Ä—Å</p>
      <input id="courseTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞" />
      <input id="courseDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞" />
      <div class="row">
        <input id="coursePrice" type="number" placeholder="–¶–µ–Ω–∞" />
        <select id="coursePublished">
          <option value="true">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</option>
          <option value="false">–°–∫—Ä—ã—Ç</option>
        </select>
      </div>
      <button id="createCourseBtn">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</button>
      <hr />
      <div id="teacherCourses" class="muted">–ö—É—Ä—Å—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;
      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const teacherCourses = document.getElementById("teacherCourses");

      const teacherNameInput = document.getElementById("teacherName");
      const teacherDescriptionInput = document.getElementById("teacherDescription");
      const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
      const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");

      const courseTitleInput = document.getElementById("courseTitle");
      const courseDescriptionInput = document.getElementById("courseDescription");
      const coursePriceInput = document.getElementById("coursePrice");
      const coursePublishedInput = document.getElementById("coursePublished");
      const createCourseBtn = document.getElementById("createCourseBtn");

      let currentUser = null;
      let selectedStyleId = "";

      if (!tgUser) {
        userBlock.innerHTML =
          '<span class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</span>';
      } else {
        bootstrap().catch(() => {
          userBlock.innerHTML = '<span class="error">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span>';
        });
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };

        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.error || "Request failed";
          throw new Error(message);
        }
        return data;
      }

      function getLevel(xp) {
        if (xp >= 60) return "üíÉ –¢–∞–Ω—Ü–æ—Ä";
        if (xp >= 30) return "ü•ã –£—á–µ–Ω–∏–∫";
        return "üå± –ù–æ–≤–∏—á–æ–∫";
      }

      async function bootstrap() {
        await loadCurrentUser();
        bindEvents();
        await routeByRole();
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");
        userBlock.innerHTML = `
          <b>${escapeHtml(tgUser.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")}</b><br/>
          –†–æ–ª—å: ${escapeHtml(currentUser.role)}<br/>
          ‚≠ê XP: ${currentUser.xp}<br/>
          üéñ –£—Ä–æ–≤–µ–Ω—å: ${getLevel(currentUser.xp)}<br/>
          üìö –£—Ä–æ–∫–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: ${currentUser.lessons_completed}
        `;
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", async () => {
          await apiFetch("/api/onboarding/complete", { method: "POST" });
          await loadCurrentUser();
          await routeByRole();
        });

        saveTeacherProfileBtn.addEventListener("click", saveTeacherProfile);
        createCourseBtn.addEventListener("click", createCourse);
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");

        if (!currentUser.is_onboarded) {
          onboardingCard.classList.remove("hidden");
        }

        if (currentUser.role === "teacher" || currentUser.role === "admin") {
          teacherScreen.classList.remove("hidden");
          await loadTeacherProfile();
          await loadTeacherCourses();
          return;
        }

        studentScreen.classList.remove("hidden");
        await loadTeachers();
      }

      async function loadTeachers() {
        const [teachers, styles] = await Promise.all([
          apiFetch("/api/teachers"),
          apiFetch("/api/styles"),
        ]);

        studentScreen.innerHTML = `
          <b>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b><br/><br/>
          <select id="styleFilter">
            <option value="">–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
            ${styles
              .map((s) => `<option value="${s.id}">${escapeHtml(s.name)}</option>`)
              .join("")}
          </select>
          ${teachers
            .map(
              (t) => `
              <button class="teacher-btn" onclick="loadCourses(${t.id})">
                ${renderTeacherAvatar(t)}
                <span class="teacher-content">
                  ${escapeHtml(t.name)}<br/>
                  <small class="muted">${escapeHtml(t.description || "")}</small>
                </span>
              </button>
            `
            )
            .join("")}
        `;

        const styleFilter = document.getElementById("styleFilter");
        styleFilter.value = selectedStyleId;
        styleFilter.addEventListener("change", () => {
          selectedStyleId = styleFilter.value;
        });
      }

      async function loadCourses(teacherId) {
        studentScreen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...";
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);

        studentScreen.innerHTML =
          "<b>–ö—É—Ä—Å—ã</b><br/><br/>" +
          courses
            .map(
              (c) => `
              <button onclick="openCourse(${c.id})">
                ${escapeHtml(c.title)}<br/>
                <small class="muted">${escapeHtml(c.description || "")}</small><br/>
                <small class="muted">–¶–µ–Ω–∞: ${Number(c.price || 0)} ‚ÇΩ</small>
              </button>
            `
            )
            .join("") +
          `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
      }

      async function openCourse(courseId) {
        studentScreen.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...";
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        studentScreen.innerHTML =
          "<b>–£—Ä–æ–∫–∏</b><br/><br/>" +
          lessons
            .map(
              (l) => `
              <button onclick="doLesson(${l.lesson_number})">
                –£—Ä–æ–∫ ${l.lesson_number}: ${escapeHtml(l.title)}<br/>
                <small class="muted">${l.is_free ? "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ" : "–ü–ª–∞—Ç–Ω–æ"} ¬∑ ${
                l.duration_sec ? Math.round(l.duration_sec / 60) + " –º–∏–Ω" : "–±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
              }</small>
              </button>
            `
            )
            .join("") +
          `<button class="secondary" onclick="loadTeachers()">‚¨Ö –ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º</button>`;
      }

      async function doLesson(lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({
            telegramId: tgUser.id,
            lessonNumber,
          }),
        });

        if (data.blocked) {
          tg.showPopup({
            title: "üîí –£—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç",
            message: "–≠—Ç–æ—Ç —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ",
            buttons: [{ type: "ok" }],
          });
          return;
        }

        await loadCurrentUser();
      }

      async function loadTeacherProfile() {
        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";
      }

      async function saveTeacherProfile() {
        await apiFetch("/api/teacher/profile", {
          method: "PUT",
          body: JSON.stringify({
            name: teacherNameInput.value,
            description: teacherDescriptionInput.value,
            avatarUrl: teacherAvatarInput.value,
          }),
        });
        tg.showAlert("–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
      }

      async function loadTeacherCourses() {
        const courses = await apiFetch("/api/teacher/courses");
        teacherCourses.innerHTML =
          "<b>–í–∞—à–∏ –∫—É—Ä—Å—ã</b><br/><br/>" +
          (courses.length
            ? courses
                .map(
                  (c) =>
                    `‚Ä¢ ${escapeHtml(c.title)} ‚Äî ${Number(c.price || 0)} ‚ÇΩ (${
                      c.is_published ? "–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω" : "—Å–∫—Ä—ã—Ç"
                    })`
                )
                .join("<br/>")
            : "–ü–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤");
      }

      async function createCourse() {
        const title = courseTitleInput.value.trim();
        if (!title) {
          tg.showAlert("–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞");
          return;
        }

        await apiFetch("/api/teacher/courses", {
          method: "POST",
          body: JSON.stringify({
            title,
            description: courseDescriptionInput.value.trim(),
            price: Number(coursePriceInput.value || 0),
            isPublished: coursePublishedInput.value === "true",
            styleIds: [],
          }),
        });

        courseTitleInput.value = "";
        courseDescriptionInput.value = "";
        coursePriceInput.value = "";
        await loadTeacherCourses();
        tg.showAlert("–ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω");
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part.charAt(0).toUpperCase())
          .join("") || "T";
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(
            teacher.avatar_url
          )}" alt="${escapeHtml(teacher.name || "Teacher")}"/>`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(
          getInitials(teacher.name)
        )}</span>`;
      }

      window.loadTeachers = loadTeachers;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.doLesson = doLesson;
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Dance With Me</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/strings.ru.js"></script>
    <style>
      body { margin: 0; padding: 16px; font-family: Arial, sans-serif; background: #111; color: #fff; }
      h1 { margin-top: 0; }
      .card { background: #1e1e1e; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
      .hidden { display: none; }
      .muted { color: #bbb; }
      .error { color: #ff8080; }
      button, input, select, textarea {
        width: 100%; padding: 12px; margin-bottom: 8px; font-size: 15px; border-radius: 8px;
        border: none; box-sizing: border-box;
      }
      button { background: #ff4d6d; color: #fff; cursor: pointer; }
      button.secondary { background: #333; }
      input, select, textarea { background: #2a2a2a; color: #fff; border: 1px solid #3a3a3a; }
      .teacher-btn { display: flex; align-items: center; gap: 12px; text-align: left; }
      .teacher-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; flex: 0 0 44px; }
      .teacher-avatar-fallback {
        width: 44px; height: 44px; border-radius: 50%; flex: 0 0 44px; display: flex;
        align-items: center; justify-content: center; font-size: 13px; font-weight: 700; background: #2b2b2b;
      }
      .teacher-content { min-width: 0; }
      .row { display: flex; gap: 8px; }
      .row > * { flex: 1; }
      .lesson-row, .user-row { border: 1px solid #333; border-radius: 8px; padding: 8px; margin-bottom: 8px; }
      .pill { display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #333; }
      .pill.free { background: #245b2e; }
      .pill.paid { background: #5b2d24; }
      .mode-label { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      .switch { position: relative; display: inline-block; width: 46px; height: 26px; flex: 0 0 46px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3a;
        transition: 0.2s; border-radius: 999px;
      }
      .slider:before {
        position: absolute; content: ""; height: 20px; width: 20px; left: 3px; top: 3px; background: #fff;
        transition: 0.2s; border-radius: 50%;
      }
      .switch input:checked + .slider { background-color: #ff4d6d; }
      .switch input:checked + .slider:before { transform: translateX(20px); }
      .role-switch-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px; }
      a { color: #ff9ab0; }
    </style>
  </head>
  <body>
    <h1 id="appTitle"></h1>

    <div class="card hidden" id="modeCard">
      <b id="modeTitle"></b>
      <label id="teacherModeWrap" class="hidden mode-label">
        <span id="teacherModeText"></span>
        <span class="switch">
          <input type="checkbox" id="teacherModeToggle" />
          <span class="slider"></span>
        </span>
      </label>
      <label id="adminModeWrap" class="hidden mode-label">
        <span id="adminModeText"></span>
        <span class="switch">
          <input type="checkbox" id="adminModeToggle" />
          <span class="slider"></span>
        </span>
      </label>
    </div>

    <div class="card" id="user"></div>

    <div class="card hidden" id="onboardingCard">
      <b id="onboardingTitle"></b>
      <p class="muted" id="onboardingText"></p>
      <button id="onboardingBtn"></button>
    </div>

    <div class="card hidden" id="studentScreen"></div>
    <div class="card hidden" id="teacherScreen"></div>
    <div class="card hidden" id="adminScreen"></div>

    <script>
      const S = window.STRINGS_RU;
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const tgUser = tg.initDataUnsafe?.user;

      const appTitle = document.getElementById("appTitle");
      const modeCard = document.getElementById("modeCard");
      const modeTitle = document.getElementById("modeTitle");
      const teacherModeWrap = document.getElementById("teacherModeWrap");
      const adminModeWrap = document.getElementById("adminModeWrap");
      const teacherModeText = document.getElementById("teacherModeText");
      const adminModeText = document.getElementById("adminModeText");
      const teacherModeToggle = document.getElementById("teacherModeToggle");
      const adminModeToggle = document.getElementById("adminModeToggle");

      const userBlock = document.getElementById("user");
      const onboardingCard = document.getElementById("onboardingCard");
      const onboardingTitle = document.getElementById("onboardingTitle");
      const onboardingText = document.getElementById("onboardingText");
      const onboardingBtn = document.getElementById("onboardingBtn");
      const studentScreen = document.getElementById("studentScreen");
      const teacherScreen = document.getElementById("teacherScreen");
      const adminScreen = document.getElementById("adminScreen");

      let currentUser = null;
      let selectedStyleId = "";
      let currentStudentCourses = [];
      let openedStudentCourseId = null;
      let currentTeacherCourses = [];
      let currentTeacherLessons = [];
      let currentAdminUsers = [];
      let editingLessonId = null;
      let teacherModeEnabled = false;
      let adminModeEnabled = false;

      renderStaticTexts();

      if (!tgUser) {
        userBlock.innerHTML = `<span class="error">${S.noTelegramData}</span>`;
      } else {
        bootstrap().catch((error) => {
          userBlock.innerHTML = `<span class="error">${escapeHtml(error.message || S.initError)}</span>`;
        });
      }

      function renderStaticTexts() {
        appTitle.textContent = S.appTitle;
        modeTitle.textContent = S.modeTitle;
        teacherModeText.textContent = S.teacherMode;
        adminModeText.textContent = S.adminMode;
        onboardingTitle.textContent = S.onboardingTitle;
        onboardingText.textContent = S.onboardingText;
        onboardingBtn.textContent = S.onboardingStart;
        userBlock.textContent = S.loadingUser;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      async function apiFetch(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "x-telegram-id": String(tgUser.id),
          ...(options.headers || {}),
        };
        const response = await fetch(url, { ...options, headers });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      function getModeStorageKey(modeName) {
        return `ldwm_${modeName}_${tgUser.id}`;
      }

      function loadModeState() {
        teacherModeEnabled = localStorage.getItem(getModeStorageKey("teacher_mode")) === "1";
        adminModeEnabled = localStorage.getItem(getModeStorageKey("admin_mode")) === "1";
      }

      function persistModeState() {
        localStorage.setItem(getModeStorageKey("teacher_mode"), teacherModeEnabled ? "1" : "0");
        localStorage.setItem(getModeStorageKey("admin_mode"), adminModeEnabled ? "1" : "0");
      }

      function getLevel(xp) {
        if (xp >= 60) return S.levelDancer;
        if (xp >= 30) return S.levelStudent;
        return S.levelBeginner;
      }

      function getInitials(name) {
        return String(name || "")
          .trim()
          .split(/\s+/)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("") || "T";
      }

      function renderTeacherAvatar(teacher) {
        if (teacher.avatar_url) {
          return `<img class="teacher-avatar" src="${escapeHtml(teacher.avatar_url)}" alt="${escapeHtml(
            teacher.name || "Teacher"
          )}" />`;
        }
        return `<span class="teacher-avatar-fallback">${escapeHtml(getInitials(teacher.name))}</span>`;
      }

      async function bootstrap() {
        bindEvents();
        await loadCurrentUser();
        loadModeState();
        renderModeControls();
        await routeByRole();
      }

      function bindEvents() {
        onboardingBtn.addEventListener("click", completeOnboarding);
        teacherModeToggle.addEventListener("change", async () => {
          teacherModeEnabled = teacherModeToggle.checked;
          persistModeState();
          await routeByRole();
        });
        adminModeToggle.addEventListener("change", async () => {
          adminModeEnabled = adminModeToggle.checked;
          persistModeState();
          await routeByRole();
        });
      }

      function renderModeControls() {
        modeCard.classList.add("hidden");
        teacherModeWrap.classList.add("hidden");
        adminModeWrap.classList.add("hidden");

        if (currentUser.role === "teacher") {
          modeCard.classList.remove("hidden");
          teacherModeWrap.classList.remove("hidden");
          teacherModeToggle.checked = teacherModeEnabled;
          return;
        }

        if (currentUser.role === "admin") {
          modeCard.classList.remove("hidden");
          adminModeWrap.classList.remove("hidden");
          teacherModeWrap.classList.remove("hidden");
          adminModeToggle.checked = adminModeEnabled;
          teacherModeToggle.checked = teacherModeEnabled;
        }
      }

      async function loadCurrentUser() {
        currentUser = await apiFetch("/api/me");

        if (currentUser.role !== "teacher" && currentUser.role !== "admin") {
          teacherModeEnabled = false;
          localStorage.removeItem(getModeStorageKey("teacher_mode"));
        }
        if (currentUser.role !== "admin") {
          adminModeEnabled = false;
          localStorage.removeItem(getModeStorageKey("admin_mode"));
        }

        renderModeControls();

        userBlock.innerHTML = `
          <b>${escapeHtml(tgUser.first_name || S.userDefaultName)}</b><br/>
          ${S.roleLabel}: ${escapeHtml(currentUser.role)}<br/>
          ${S.xpLabel}: ${currentUser.xp}<br/>
          ${S.levelLabel}: ${escapeHtml(getLevel(currentUser.xp))}<br/>
          ${S.lessonsDoneLabel}: ${currentUser.lessons_completed}
        `;
      }

      async function completeOnboarding() {
        await apiFetch("/api/onboarding/complete", { method: "POST" });
        await loadCurrentUser();
        await routeByRole();
      }

      async function routeByRole() {
        onboardingCard.classList.add("hidden");
        studentScreen.classList.add("hidden");
        teacherScreen.classList.add("hidden");
        adminScreen.classList.add("hidden");

        const teacherSpecialMode =
          (currentUser.role === "teacher" && teacherModeEnabled) ||
          (currentUser.role === "admin" && teacherModeEnabled);
        const adminSpecialMode = currentUser.role === "admin" && adminModeEnabled;
        const specialModeEnabled = teacherSpecialMode || adminSpecialMode;

        if (!currentUser.is_onboarded && !specialModeEnabled) {
          onboardingCard.classList.remove("hidden");
        }

        if (adminSpecialMode) {
          adminScreen.classList.remove("hidden");
          await renderAdminScreen();
          return;
        }

        if (teacherSpecialMode) {
          teacherScreen.classList.remove("hidden");
          await renderTeacherScreen();
          return;
        }

        studentScreen.classList.remove("hidden");
        await renderStudentScreen();
      }

      async function renderStudentScreen() {
        const [teachers, styles] = await Promise.all([apiFetch("/api/teachers"), apiFetch("/api/styles")]);
        studentScreen.innerHTML = `
          <b>${S.studentTitle}</b><br/><br/>
          <select id="styleFilter">
            <option value="">${S.allStyles}</option>
            ${styles.map((style) => `<option value="${style.id}">${escapeHtml(style.name)}</option>`).join("")}
          </select>
          ${teachers
            .map(
              (teacher) => `
                <button class="teacher-btn" onclick="loadCourses(${teacher.id})">
                  ${renderTeacherAvatar(teacher)}
                  <span class="teacher-content">
                    ${escapeHtml(teacher.name)}<br/>
                    <small class="muted">${escapeHtml(teacher.description || "")}</small>
                  </span>
                </button>
              `
            )
            .join("")}
        `;

        const styleFilter = document.getElementById("styleFilter");
        styleFilter.value = selectedStyleId;
        styleFilter.addEventListener("change", () => {
          selectedStyleId = styleFilter.value;
        });
      }

      async function loadCourses(teacherId) {
        studentScreen.innerHTML = S.loadingCourses;
        const styleQuery = selectedStyleId ? `?styleId=${selectedStyleId}` : "";
        const courses = await apiFetch(`/api/courses/${teacherId}${styleQuery}`);
        currentStudentCourses = courses;

        studentScreen.innerHTML =
          `<b>${S.coursesTitle}</b><br/><br/>` +
          courses
            .map(
              (course) => `
                <button onclick="openCourse(${course.id})">
                  ${escapeHtml(course.title)}<br/>
                  <small class="muted">${escapeHtml(course.description || "")}</small><br/>
                  <small class="muted">${S.priceLabel}: ${Number(course.price || 0)} ₽</small><br/>
                  <small class="muted">${course.is_purchased ? S.purchased : S.notPurchased}</small>
                </button>
              `
            )
            .join("") +
          `<button class="secondary" onclick="renderStudentScreen()">${S.toTeachers}</button>`;
      }

      async function openCourse(courseId) {
        openedStudentCourseId = courseId;
        studentScreen.innerHTML = S.loadingLessons;
        const lessons = await apiFetch(`/api/lessons/${courseId}`);
        const course = currentStudentCourses.find((item) => item.id === courseId);
        const hasPaidLessons = lessons.some((lesson) => !lesson.is_free);
        const showBuyButton = hasPaidLessons && course && !course.is_purchased;

        studentScreen.innerHTML =
          `<b>${S.lessonsTitle}</b><br/><br/>` +
          (showBuyButton
            ? `<button onclick="purchaseCourse(${courseId})">${S.buyCourse} ${Number(course.price || 0)} ₽</button>`
            : "") +
          lessons
            .map((lesson) => {
              const typeClass = lesson.is_free ? "free" : "paid";
              const typeText = lesson.is_free ? S.free : S.paid;
              const durationText = lesson.duration_sec
                ? `${Math.round(lesson.duration_sec / 60)} ${S.minutes}`
                : S.noDuration;
              const unlockText = lesson.is_unlocked ? S.unlocked : S.locked;
              const previewHtml = lesson.preview_url
                ? `<br/><small><a href="${escapeHtml(lesson.preview_url)}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small>`
                : "";
              return `
                <button onclick="doLesson(${courseId}, ${lesson.lesson_number})">
                  ${S.lessonsTitle.slice(0, -1)} ${lesson.lesson_number}: ${escapeHtml(lesson.title)}<br/>
                  <small class="pill ${typeClass}">${typeText}</small>
                  <small class="muted"> · ${durationText}</small>
                  <small class="muted"> · ${unlockText}</small>
                  ${previewHtml}
                </button>
              `;
            })
            .join("") +
          `<button class="secondary" onclick="renderStudentScreen()">${S.toTeachers}</button>`;
      }

      async function purchaseCourse(courseId) {
        await apiFetch(`/api/courses/${courseId}/purchase`, { method: "POST" });
        const selectedCourse = currentStudentCourses.find((item) => item.id === courseId);
        if (selectedCourse) selectedCourse.is_purchased = true;
        tg.showAlert(S.coursePurchaseSuccess);
        await openCourse(courseId);
      }

      async function doLesson(courseId, lessonNumber) {
        const data = await apiFetch("/api/lesson", {
          method: "POST",
          body: JSON.stringify({ telegramId: tgUser.id, courseId, lessonNumber }),
        });

        if (data.blocked) {
          const message =
            data.reason === "course_purchase_required" ? S.lessonLockedNeedPurchase : S.lessonLockedGeneric;
          tg.showPopup({ title: S.lessonLockedTitle, message, buttons: [{ type: "ok" }] });
          return;
        }

        await loadCurrentUser();
        if (openedStudentCourseId) await openCourse(openedStudentCourseId);
      }

      async function renderTeacherScreen() {
        teacherScreen.innerHTML = `
          <b>${S.teacherCabinet}</b>
          <p class="muted">${S.profileTitle}</p>
          <input id="teacherName" placeholder="${S.teacherNamePh}" />
          <input id="teacherDescription" placeholder="${S.teacherDescriptionPh}" />
          <input id="teacherAvatarUrl" placeholder="${S.teacherAvatarPh}" />
          <button id="saveTeacherProfileBtn">${S.saveProfile}</button>
          <hr />
          <p class="muted">${S.newCourseTitle}</p>
          <input id="courseTitle" placeholder="${S.courseNamePh}" />
          <input id="courseDescription" placeholder="${S.courseDescriptionPh}" />
          <div class="row">
            <input id="coursePrice" type="number" placeholder="${S.coursePricePh}" min="199" />
            <select id="coursePublished">
              <option value="true">${S.published}</option>
              <option value="false">${S.hidden}</option>
            </select>
          </div>
          <button id="createCourseBtn">${S.createCourse}</button>
          <hr />
          <p class="muted">${S.teacherLessonsTitle}</p>
          <select id="teacherCourseSelect"></select>
          <div class="row">
            <input id="lessonNumber" type="number" min="1" placeholder="${S.lessonNumberPh}" />
            <input id="lessonDuration" type="number" min="1" placeholder="${S.lessonDurationPh}" />
          </div>
          <input id="lessonTitle" placeholder="${S.lessonNamePh}" />
          <input id="lessonPreviewUrl" placeholder="${S.lessonPreviewPh}" />
          <textarea id="lessonDescription" placeholder="${S.lessonDescriptionPh}"></textarea>
          <select id="lessonIsFree">
            <option value="true">${S.lessonFree}</option>
            <option value="false">${S.lessonPaid}</option>
          </select>
          <button id="saveLessonBtn">${S.saveLesson}</button>
          <div id="teacherCourses" class="muted">${S.loading}</div>
          <div id="teacherLessons" class="muted">${S.chooseCourse}</div>
        `;

        const teacherNameInput = document.getElementById("teacherName");
        const teacherDescriptionInput = document.getElementById("teacherDescription");
        const teacherAvatarInput = document.getElementById("teacherAvatarUrl");
        const saveTeacherProfileBtn = document.getElementById("saveTeacherProfileBtn");
        const courseTitleInput = document.getElementById("courseTitle");
        const courseDescriptionInput = document.getElementById("courseDescription");
        const coursePriceInput = document.getElementById("coursePrice");
        const coursePublishedInput = document.getElementById("coursePublished");
        const createCourseBtn = document.getElementById("createCourseBtn");
        const teacherCourseSelect = document.getElementById("teacherCourseSelect");
        const lessonNumberInput = document.getElementById("lessonNumber");
        const lessonDurationInput = document.getElementById("lessonDuration");
        const lessonTitleInput = document.getElementById("lessonTitle");
        const lessonPreviewInput = document.getElementById("lessonPreviewUrl");
        const lessonDescriptionInput = document.getElementById("lessonDescription");
        const lessonIsFreeInput = document.getElementById("lessonIsFree");
        const saveLessonBtn = document.getElementById("saveLessonBtn");
        const teacherCoursesBlock = document.getElementById("teacherCourses");
        const teacherLessonsBlock = document.getElementById("teacherLessons");

        const profile = await apiFetch("/api/teacher/profile");
        teacherNameInput.value = profile.name || "";
        teacherDescriptionInput.value = profile.description || "";
        teacherAvatarInput.value = profile.avatar_url || "";

        saveTeacherProfileBtn.addEventListener("click", async () => {
          await apiFetch("/api/teacher/profile", {
            method: "PUT",
            body: JSON.stringify({
              name: teacherNameInput.value.trim(),
              description: teacherDescriptionInput.value.trim(),
              avatarUrl: teacherAvatarInput.value.trim(),
            }),
          });
          tg.showAlert(S.profileSaved);
        });

        async function loadTeacherCoursesData() {
          currentTeacherCourses = await apiFetch("/api/teacher/courses");
          teacherCoursesBlock.innerHTML =
            `<b>${S.yourCourses}</b><br/><br/>` +
            (currentTeacherCourses.length
              ? currentTeacherCourses
                  .map(
                    (course) =>
                      `• ${escapeHtml(course.title)} — ${Number(course.price || 0)} ₽ (${
                        course.is_published ? S.published.toLowerCase() : S.hidden.toLowerCase()
                      })`
                  )
                  .join("<br/>")
              : S.noCoursesYet);

          teacherCourseSelect.innerHTML = currentTeacherCourses.length
            ? currentTeacherCourses.map((course) => `<option value="${course.id}">${escapeHtml(course.title)}</option>`).join("")
            : `<option value="">${S.noCourses}</option>`;
        }

        async function loadTeacherLessonsData() {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) {
            teacherLessonsBlock.textContent = S.chooseCourse;
            return;
          }

          const lessons = await apiFetch(`/api/teacher/courses/${courseId}/lessons`);
          currentTeacherLessons = lessons;
          teacherLessonsBlock.innerHTML =
            `<b>${S.selectedCourseLessons}</b><br/><br/>` +
            (lessons.length
              ? lessons
                  .map(
                    (lesson) => `
                      <div class="lesson-row">
                        <b>${lesson.lesson_number}. ${escapeHtml(lesson.title)}</b><br/>
                        <small class="muted">${escapeHtml(lesson.description || "")}</small><br/>
                        <small class="muted">${lesson.is_free ? S.free : S.paid} · ${
                          lesson.duration_sec ? `${lesson.duration_sec} ${S.seconds}` : S.noDuration
                        }</small><br/>
                        ${
                          lesson.preview_url
                            ? `<small><a href="${escapeHtml(lesson.preview_url)}" target="_blank" rel="noopener noreferrer">${S.preview}</a></small><br/>`
                            : ""
                        }
                        <button class="secondary" onclick="editLessonById(${lesson.id})">${S.editLesson}</button>
                      </div>
                    `
                  )
                  .join("")
              : S.noLessonsYet);
        }

        createCourseBtn.addEventListener("click", async () => {
          const title = courseTitleInput.value.trim();
          const price = Number(coursePriceInput.value || 0);
          if (!title) return tg.showAlert(S.needCourseName);
          if (!Number.isFinite(price) || price < 199) return tg.showAlert(S.minCoursePriceError);

          await apiFetch("/api/teacher/courses", {
            method: "POST",
            body: JSON.stringify({
              title,
              description: courseDescriptionInput.value.trim(),
              price,
              isPublished: coursePublishedInput.value === "true",
              styleIds: [],
            }),
          });
          courseTitleInput.value = "";
          courseDescriptionInput.value = "";
          coursePriceInput.value = "";
          await loadTeacherCoursesData();
          await loadTeacherLessonsData();
          tg.showAlert(S.courseCreated);
        });

        teacherCourseSelect.addEventListener("change", loadTeacherLessonsData);

        function resetLessonForm() {
          editingLessonId = null;
          lessonNumberInput.value = "";
          lessonDurationInput.value = "";
          lessonTitleInput.value = "";
          lessonPreviewInput.value = "";
          lessonDescriptionInput.value = "";
          lessonIsFreeInput.value = "true";
          saveLessonBtn.textContent = S.saveLesson;
        }

        window.editLessonById = function editLessonById(lessonId) {
          const lesson = currentTeacherLessons.find((item) => item.id === lessonId);
          if (!lesson) return;
          editingLessonId = lesson.id;
          lessonNumberInput.value = lesson.lesson_number;
          lessonDurationInput.value = lesson.duration_sec || "";
          lessonTitleInput.value = lesson.title || "";
          lessonPreviewInput.value = lesson.preview_url || "";
          lessonDescriptionInput.value = lesson.description || "";
          lessonIsFreeInput.value = lesson.is_free ? "true" : "false";
          saveLessonBtn.textContent = S.updateLesson;
        };

        saveLessonBtn.addEventListener("click", async () => {
          const courseId = Number(teacherCourseSelect.value);
          if (!courseId) return tg.showAlert(S.chooseCourseError);

          const payload = {
            lessonNumber: Number(lessonNumberInput.value),
            title: lessonTitleInput.value.trim(),
            description: lessonDescriptionInput.value.trim(),
            isFree: lessonIsFreeInput.value === "true",
            durationSec: lessonDurationInput.value ? Number(lessonDurationInput.value) : null,
            previewUrl: lessonPreviewInput.value.trim() || null,
          };

          if (!payload.lessonNumber || !payload.title) return tg.showAlert(S.fillLessonError);

          if (editingLessonId) {
            await apiFetch(`/api/teacher/lessons/${editingLessonId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await apiFetch(`/api/teacher/courses/${courseId}/lessons`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }

          resetLessonForm();
          await loadTeacherLessonsData();
          tg.showAlert(S.lessonSaved);
        });

        await loadTeacherCoursesData();
        await loadTeacherLessonsData();
      }

      async function renderAdminScreen() {
        adminScreen.innerHTML = `
          <b>${S.adminPanelTitle}</b>
          <p class="muted">${S.adminPanelText}</p>
          <button class="secondary" id="refreshAdminUsersBtn">${S.refreshUsers}</button>
          <div id="adminUsersList" class="muted">${S.loadingUsers}</div>
        `;

        const refreshAdminUsersBtn = document.getElementById("refreshAdminUsersBtn");
        const adminUsersList = document.getElementById("adminUsersList");

        async function loadAdminUsers() {
          currentAdminUsers = await apiFetch("/api/admin/users");
          adminUsersList.innerHTML = currentAdminUsers.length
            ? currentAdminUsers
                .map(
                  (user) => `
                    <div class="user-row">
                      <b>${S.userIdLabel}:</b> ${user.telegram_id}<br/>
                      <small class="muted">${S.userRoleLabel}: ${escapeHtml(user.role)} | XP: ${user.xp} | ${S.userLessonsLabel}: ${user.lessons_completed}</small>
                      <div class="role-switch-row">
                        <small>${S.teacherRoleSwitch}</small>
                        <span class="switch">
                          <input
                            type="checkbox"
                            ${user.role === "teacher" ? "checked" : ""}
                            onchange="setTeacherRoleSwitch(${user.telegram_id}, this.checked)"
                          />
                          <span class="slider"></span>
                        </span>
                      </div>
                    </div>
                  `
                )
                .join("")
            : S.usersEmpty;
        }

        window.setTeacherRoleSwitch = async function setTeacherRoleSwitch(telegramId, checked) {
          const role = checked ? "teacher" : "student";
          await apiFetch(`/api/admin/users/${telegramId}/role`, {
            method: "PUT",
            body: JSON.stringify({ role }),
          });
          tg.showAlert(S.roleUpdated);
          await loadAdminUsers();
        };

        refreshAdminUsersBtn.addEventListener("click", loadAdminUsers);
        await loadAdminUsers();
      }

      window.renderStudentScreen = renderStudentScreen;
      window.loadCourses = loadCourses;
      window.openCourse = openCourse;
      window.purchaseCourse = purchaseCourse;
      window.doLesson = doLesson;
    </script>
  </body>
</html>
